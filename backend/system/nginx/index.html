<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg" />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.3
    </script>
    <title>Nginx</title>
  <script>
      window.g_useSSR = true;
      window.g_initialProps = {};

    </script>
    </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/">Drex</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/guide">指南</a><a href="/fontend">前端</a><a aria-current="page" class="active" href="/backend">后端</a><a href="/devops">运维</a><a href="/blog">博客</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/"></a><h1>Drex</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/guide">指南</a></li><li><a href="/fontend">前端</a></li><li><a aria-current="page" class="active" href="/backend">后端</a></li><li><a href="/devops">运维</a></li><li><a href="/blog">博客</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/backend">后端体系图</a></li><li><a href="/backend/network">网络基础</a><ul><li><a href="/backend/network/network"><span>网络协议</span></a></li></ul></li><li><a aria-current="page" class="active" href="/backend/system">Web服务器</a><ul><li><a aria-current="page" class="active" href="/backend/system/nginx"><span>Nginx</span></a></li></ul></li><li><a href="/backend/database">数据库</a><ul><li><a href="/backend/database/postgre-sql"><span>PostgreSQL</span></a></li><li><a href="/backend/database/my-sql"><span>MySQL</span></a></li><li><a href="/backend/database/table-store"><span>TableStore</span></a></li><li><a href="/backend/database/sequelize"><span>Sequelize</span></a></li><li><a href="/backend/database/redis"><span>Redis</span></a></li></ul></li><li><a href="/backend/node">Node</a><ul><li><a href="/backend/node/basic"><span>Node基础</span></a></li><li><a href="/backend/node/evenloop"><span>Node 事件循环</span></a></li><li><a href="/backend/node/yarn&amp;npm&amp;cnpm"><span>yarn、npm、cnpm 对比分析</span></a></li></ul></li><li><a href="/backend/test">测试</a><ul><li><a href="/backend/test/utils"><span>测试工具</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="Nginx简介" data-depth="2" class=""><a href="/backend/system/nginx#nginx简介"><span>Nginx简介</span></a></li><li title="特点" data-depth="3" class=""><a href="/backend/system/nginx#特点"><span>特点</span></a></li><li title="架构模型" data-depth="3" class=""><a href="/backend/system/nginx#架构模型"><span>架构模型</span></a></li><li title="配置" data-depth="3" class=""><a href="/backend/system/nginx#配置"><span>配置</span></a></li><li title="常用场景" data-depth="2" class=""><a href="/backend/system/nginx#常用场景"><span>常用场景</span></a></li><li title="代理" data-depth="3" class=""><a href="/backend/system/nginx#代理"><span>代理</span></a></li><li title="正向代理" data-depth="3" class=""><a href="/backend/system/nginx#正向代理"><span>正向代理</span></a></li><li title="反向代理" data-depth="3" class=""><a href="/backend/system/nginx#反向代理"><span>反向代理</span></a></li><li title="负载均衡" data-depth="3" class=""><a href="/backend/system/nginx#负载均衡"><span>负载均衡</span></a></li><li title="Nginx 对于前端的作用" data-depth="2" class=""><a href="/backend/system/nginx#nginx-对于前端的作用"><span>Nginx 对于前端的作用</span></a></li><li title="快速配置静态服务器" data-depth="3" class=""><a href="/backend/system/nginx#快速配置静态服务器"><span>快速配置静态服务器</span></a></li><li title="访问限制" data-depth="3" class=""><a href="/backend/system/nginx#访问限制"><span>访问限制</span></a></li><li title="解决跨域" data-depth="3" class=""><a href="/backend/system/nginx#解决跨域"><span>解决跨域</span></a></li><li title="图片处理" data-depth="3" class=""><a href="/backend/system/nginx#图片处理"><span>图片处理</span></a></li><li title="本地代理" data-depth="3" class=""><a href="/backend/system/nginx#本地代理"><span>本地代理</span></a></li><li title="配置SSL证书" data-depth="3" class=""><a href="/backend/system/nginx#配置ssl证书"><span>配置SSL证书</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="nginx简介"><a aria-hidden="true" href="#nginx简介"><span class="icon icon-link"></span></a>Nginx简介</h2><p>轻量级、高性能的 Web 服务器，在现今的大型应用、网站基本都离不开 Nginx，已经成为了一项必选的技术；其实可以把它理解成 <strong>入口网关</strong>，这里我举个例子可能更好理解:</p><blockquote><p>当你去银行办理业务时，刚走进银行，需要到入门处的机器排队取号，然后按指令到对应的柜台办理业务，或者也有可能告诉你，今天不能排号了，回家吧！</p><p>这样一个场景中，<strong>取号机器就是 Nginx(入口网关)</strong>。一个个柜台就是我们的业务服务器(办理业务)；银行中的保险箱就是我们的数据库(存取数据)；🤣</p></blockquote><p><img src="/static/nginx-entry.90fbcab6.png"/></p><h3 id="特点"><a aria-hidden="true" href="#特点"><span class="icon icon-link"></span></a>特点</h3><ul><li>轻量级，配置方便灵活，无侵入性；</li><li>占用内存少，启动快，性能好；</li><li>高并发，事件驱动，异步；</li><li>热部署，修改配置热生效；</li></ul><h3 id="架构模型"><a aria-hidden="true" href="#架构模型"><span class="icon icon-link"></span></a>架构模型</h3><ul><li>基于 <strong>socket 与 Linux epoll (I/O 事件通知机制)</strong>，实现了 <strong>高并发</strong>；</li><li>使用模块化、事件通知、回调函数、计时器、轮询实现非阻塞的异步模式；</li><li>磁盘不足的情况，可能会导致阻塞；</li><li><strong>Master-worker 进程模式</strong>:<ul><li>Nginx 启动时会在内存中常驻一个 <strong>Master 主进程</strong>，功能:<ul><li>读取配置文件；</li><li>创建、绑定、关闭 socket；</li><li>启动、维护、配置 worker 进程；</li><li>编译脚本、打开日志；</li></ul></li><li>master 进程会开启配置数量的 <strong>worker 进程</strong>，比如根据 CPU 核数等:<ul><li>利用 socket 监听连接，不会新开进程或线程，节约了创建与销毁进程的成本；</li><li>检查网络、存储，把新连接加入到轮询队列中，异步处理；</li><li>能有效利用 cpu 多核，并避免了线程切换和锁等待；</li></ul></li></ul></li><li><strong>热部署模式</strong>:<ul><li>当我们修改配置热重启后，master 进程会以新的配置新创建 worker 进程，新连接会全部交给新进程处理；</li><li>老的 worker 进程会在处理完之前的连接后被 kill 掉，逐步全替换成新配置的 worker 进程；</li></ul></li></ul><h3 id="配置"><a aria-hidden="true" href="#配置"><span class="icon icon-link"></span></a>配置</h3><ul><li>官网下载；</li><li>配置文件路径： <code>/usr/local/etc/nginx/nginx.conf</code>；</li><li>启动: 终端输入 <code>nginx</code>，访问 <code>localhost:8080</code> 就能看到 <code>Welcome...</code>；</li><li><code>nginx -s stop</code>: 停止服务；</li><li><code>nginx -s reload</code>: 热重启服务；</li><li>配置代理: <code>proxy_pass</code></li><li>在配置文件中配置即可完成；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
    listen 80;
    location / {
        proxy_pass http://xxx.xxx.xx.xx:3000;
    }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    listen </span><span class="token number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        proxy_pass http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">xxx</span><span class="token punctuation">.</span><span class="token property-access">xxx</span><span class="token punctuation">.</span><span class="token property-access">xx</span><span class="token punctuation">.</span><span class="token property-access">xx</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="常用场景"><a aria-hidden="true" href="#常用场景"><span class="icon icon-link"></span></a>常用场景</h2><h3 id="代理"><a aria-hidden="true" href="#代理"><span class="icon icon-link"></span></a>代理</h3><p>其实 Nginx 可以算一层 <strong>代理服务器</strong>，将客户端的请求处理一层后，再转发到业务服务器，这里可以分成两种类型，其实实质就是 <strong>请求的转发</strong>，使用 Nginx 非常合适、高效；</p><h3 id="正向代理"><a aria-hidden="true" href="#正向代理"><span class="icon icon-link"></span></a>正向代理</h3><ul><li>即用户通过访问这层正向代理服务器，再由代理服务器去到原始服务器请求内容后，再返回给用户；</li><li>例如我们常使用的 VPN 就是一种常见的正向代理模式。通常我们无法直接访问谷歌服务器，但是通过访问一台国外的服务器，再由这台服务器去请求谷歌返回给用户，用户即可访问谷歌；</li></ul><p><strong>特点</strong></p><ul><li>代理服务器属于 <strong>客户端层</strong>，称之为正向代理；</li><li>代理服务器是 <strong>为用户服务</strong>，对于用户是透明的，用户知道自己访问代理服务器；</li><li>对内容服务器来说是 <strong>隐藏</strong> 的，内容服务器并无法分清访问是来自用户或者代理；</li></ul><p><img src="/static/nginx-forward.7d73d240.png"/></p><h3 id="反向代理"><a aria-hidden="true" href="#反向代理"><span class="icon icon-link"></span></a>反向代理</h3><p>用户访问头条的反向代理网关，通过网关的一层处理和调度后，再由网关将访问转发到内部的服务器上，返回内容给用户；</p><p><strong>特点</strong></p><ul><li>代理服务器属于 <strong>服务端层</strong>，因此称为反向代理。通常代理服务器与内部内容服务器会隶属于同一内网或者集群；</li><li>代理服务器是 <strong>为内容服务器服务</strong> 的，对用户是隐藏的，用户不清楚自己访问的具体是哪台内部服务器；</li><li>能有效保证内部服务器的 <strong>稳定与安全</strong>；</li></ul><p><img src="/static/nginx-reverse.0f2d5faf.png"/></p><ul><li><p><strong>反向代理的好处</strong>:</p><ul><li><strong>安全与权限</strong>:<ul><li>用户访问必须通过反向代理服务器，也就是便可以在做这层做统一的请求校验，过滤拦截不合法、危险的请求，从而就能更好的保证服务器的安全与稳定；</li></ul></li><li><strong>负载均衡</strong>: 能有效分配流量，最大化集群的稳定性，保证用户的访问质量；</li></ul></li></ul><h3 id="负载均衡"><a aria-hidden="true" href="#负载均衡"><span class="icon icon-link"></span></a>负载均衡</h3><ul><li>负载均衡是基于反向代理下实现的一种 <strong>流量分配</strong> 功能，目的是为了达到服务器资源的充分利用，以及更快的访问响应；</li><li>其实很好理解，还是以上面银行的例子来看: <strong>通过门口的取号器，系统就可以根据每个柜台的业务排队情况进行用户的分，使每个柜台都保持在一个比较高效的运作状态，避免出现分配不均的情况</strong>；</li><li>由于用户并不知道内部服务器中的队列情况，而反向代理服务器是清楚的，因此通过 Nginx，便能很简单地实现流量的均衡分配；</li><li>Nginx 实现: <code>Upstream</code>模块， 这样当用户访问 <code>http://xxx</code> 时，流量便会被按照一定的规则分配到<code>upstream</code>中的 3 台服务器上；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="http {
    upstream xxx {
        server 1.1.1.1:3001;
        server 2.2.2.2:3001;
        server 3.3.3.3:3001;
    }
    server {
        listen 8080;
        location / {
            proxy_pass http://xxx;
        }
    }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">http </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    upstream xxx </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        server </span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        server </span><span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        server </span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        listen </span><span class="token number">8080</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            proxy_pass http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">xxx</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><strong>分配策略</strong></p><ul><li><p><strong>服务器权重(<code>weight</code>)</strong>:</p><ul><li>可以为每台服务器配置访问权重，传入参数<code>weight</code>，例如:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="  upstream xxx {
      server 1.1.1.1:3001 weight=1;
      server 2.2.2.2:3001 weight=1;
      server 3.3.3.3:3001 weight=8;
  }
" data-status="copy"></button><div class="token-line"><span class="token plain">  upstream xxx </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server </span><span class="token number">1.1</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token plain"> weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server </span><span class="token number">2.2</span><span class="token number">.2</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token plain"> weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server </span><span class="token number">3.3</span><span class="token number">.3</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">3001</span><span class="token plain"> weight</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li><li><p><strong>时间顺序(默认)</strong>: 按用户的访问的顺序逐一的分配到正常运行的服务器上；</p></li><li><p><strong>连接数优先(<code>least_conn</code>)</strong>: 优先将访问分配到列表中连接数队列最短的服务器上；</p></li><li><p><strong>响应时间优先(<code>fair</code>)</strong>: 优先将访问分配到列表中访问响应时间最短的服务器上；</p></li><li><p><strong>ip_hash</strong>: 通过 ip_hash 指定，使每个 ip 用户都访问固定的服务器上，有利于用户特异性数据的缓存，例如本地 session 服务等；</p></li><li><p><strong>url_hash</strong>: 通过 url_hash 指定，使每个 url 都分配到固定的服务器上，有利于缓存；</p></li></ul><h2 id="nginx-对于前端的作用"><a aria-hidden="true" href="#nginx-对于前端的作用"><span class="icon icon-link"></span></a>Nginx 对于前端的作用</h2><h3 id="快速配置静态服务器"><a aria-hidden="true" href="#快速配置静态服务器"><span class="icon icon-link"></span></a>快速配置静态服务器</h3><p>当访问 <code>localhost:80</code> 时，就会默认访问到 <code>/Users/files/index.html</code>；</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
  listen 80;
  server_name localhost;

  location / {
    root   /Users/files;
    index  index.html;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  listen </span><span class="token number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server_name localhost</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root   </span><span class="token operator">/</span><span class="token maybe-class-name">Users</span><span class="token operator">/</span><span class="token plain">files</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    index  index</span><span class="token punctuation">.</span><span class="token property-access">html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="访问限制"><a aria-hidden="true" href="#访问限制"><span class="icon icon-link"></span></a>访问限制</h3><p>可以制定一系列的规则进行访问的控制，例如直接通过 ip 限制:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 屏蔽 192.168.1.1 的访问；
# 允许 192.168.1.2 ~ 10 的访问；
location / {
      deny  192.168.1.1;
      allow 192.168.1.2/10;
      deny  all;
  }
" data-status="copy"></button><div class="token-line"><span class="token plain"># 屏蔽 </span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token plain"> 的访问；</span></div><div class="token-line"><span class="token plain"># 允许 </span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token plain"> </span><span class="token operator">~</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> 的访问；</span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      deny  </span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      allow </span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      deny  all</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="解决跨域"><a aria-hidden="true" href="#解决跨域"><span class="icon icon-link"></span></a>解决跨域</h3><p>其实跨域是 <strong>浏览器的安全策略</strong>，这意味着只要不是通过浏览器，就可以绕开跨域的问题。所以只要通过在同域下启动一个 Nginx 服务，转发请求即可；</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="location ^~/api/ {
      # 重写请求并代理到对应域名下
      rewrite ^/api/(.*)$ /$1 break;
      proxy_pass https://www.cross-target.com/;
  }
" data-status="copy"></button><div class="token-line"><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">^</span><span class="token operator">~</span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      # 重写请求并代理到对应域名下</span></div><div class="token-line"><span class="token plain">      rewrite </span><span class="token operator">^</span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token plain">$ </span><span class="token operator">/</span><span class="token plain">$</span><span class="token number">1</span><span class="token plain"> </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      proxy_pass https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token regex">/www.cross-target.com/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="图片处理"><a aria-hidden="true" href="#图片处理"><span class="icon icon-link"></span></a>图片处理</h3><p>通过 ngx_http_image_filter_module 这个模块，可以作为一层图片服务器的代理，在访问的时候 <strong>对图片进行特定的操作，例如裁剪，旋转，压缩等</strong>；</p><h3 id="本地代理"><a aria-hidden="true" href="#本地代理"><span class="icon icon-link"></span></a>本地代理</h3><p>绕过白名单限制: 例如我们在接入一些第三方服务时经常会有一些域名白名单的限制，如果我们在本地通过<code>localhost</code>进行开发，便无法完成功能。这里我们可以做一层本地代理，便可以直接通过指定域名访问本地开发环境；</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
  listen 80;
  server_name www.toutiao.com;
  location / {
    proxy_pass http://localhost:3000;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  listen </span><span class="token number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server_name www</span><span class="token punctuation">.</span><span class="token property-access">toutiao</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    proxy_pass http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">localhost</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="配置ssl证书"><a aria-hidden="true" href="#配置ssl证书"><span class="icon icon-link"></span></a>配置SSL证书</h3><ul><li>在相应证书机构进行证书申请及下载(阿里云&amp;腾讯云)</li><li>将证书文件 <code>xxx.pem</code> 和 <code>xxx.key</code>文件拷贝到<code>/etc/ssl/</code>目录下</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="    server {
        listen       443 ssl http2 default_server;
        listen       [::]:443 ssl http2 default_server;
        server_name  api.yiketiandi.com;
        root         /usr/share/nginx/html;

        ssl_certificate &quot;/etc/ssl/1_api.yiketiandi.com_bundle.crt&quot;;
        ssl_certificate_key &quot;/etc/ssl/2_api.yiketiandi.com.key&quot;;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout  10m;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
# http映射到https
    server{
        listen 80;
        server_name idrex.net;
        rewrite ^/(.*)$ https://idrex.net:443/$1 permanent;
    }
" data-status="copy"></button><div class="token-line"><span class="token plain">    server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        listen       </span><span class="token number">443</span><span class="token plain"> ssl http2 default_server</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        listen       </span><span class="token punctuation">[</span><span class="token plain">::</span><span class="token punctuation">]</span><span class="token plain">:443 ssl http2 default_server</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        server_name  api.yiketiandi.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        root         /usr/share/nginx/html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_certificate </span><span class="token string">&quot;/etc/ssl/1_api.yiketiandi.com_bundle.crt&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_certificate_key </span><span class="token string">&quot;/etc/ssl/2_api.yiketiandi.com.key&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_session_cache shared:SSL:1m</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_session_timeout  10m</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_ciphers HIGH:</span><span class="token operator">!</span><span class="token plain">aNULL:</span><span class="token operator">!</span><span class="token plain">MD5</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ssl_prefer_server_ciphers on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># Load configuration files for the default server block.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        include /etc/nginx/default.d/*.conf</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        location / </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        error_page </span><span class="token number">404</span><span class="token plain"> /404.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            location </span><span class="token operator">=</span><span class="token plain"> /40x.html </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        error_page </span><span class="token number">500</span><span class="token plain"> </span><span class="token number">502</span><span class="token plain"> </span><span class="token number">503</span><span class="token plain"> </span><span class="token number">504</span><span class="token plain"> /50x.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            location </span><span class="token operator">=</span><span class="token plain"> /50x.html </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># http映射到https</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        listen </span><span class="token number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        server_name idrex.net</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        rewrite ^/</span><span class="token punctuation">(</span><span class="token plain">.*</span><span class="token punctuation">)</span><span class="token plain">$ https://idrex.net:443/</span><span class="token variable">$1</span><span class="token plain"> permanent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last Update: ">6/24/2020, 7:36:58 AM</span></div></div></div></div>

    <script src="/umi.js"></script>
  </body>
</html>
