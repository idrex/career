<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg" />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.3
    </script>
    <title>Node &#x4E8B;&#x4EF6;&#x5FAA;&#x73AF;</title>
  <script>
      window.g_useSSR = true;
      window.g_initialProps = {};

    </script>
    </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/">Drex</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/guide">指南</a><a href="/fontend">前端</a><a aria-current="page" class="active" href="/backend">后端</a><a href="/devops">运维</a><a href="/blog">博客</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/"></a><h1>Drex</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/guide">指南</a></li><li><a href="/fontend">前端</a></li><li><a aria-current="page" class="active" href="/backend">后端</a></li><li><a href="/devops">运维</a></li><li><a href="/blog">博客</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/backend">后端体系图</a></li><li><a href="/backend/network">网络基础</a><ul><li><a href="/backend/network/api"><span>接口选型</span></a></li><li><a href="/backend/network/network"><span>网络协议</span></a></li></ul></li><li><a href="/backend/system">Web服务器</a><ul><li><a href="/backend/system/nginx"><span>Nginx</span></a></li></ul></li><li><a href="/backend/database">数据库</a><ul><li><a href="/backend/database/postgre-sql"><span>PostgreSQL</span></a></li><li><a href="/backend/database/my-sql"><span>MySQL</span></a></li><li><a href="/backend/database/table-store"><span>TableStore</span></a></li><li><a href="/backend/database/sequelize"><span>Sequelize</span></a></li><li><a href="/backend/database/redis"><span>Redis</span></a></li></ul></li><li><a aria-current="page" class="active" href="/backend/node">Node</a><ul><li><a href="/backend/node/basic"><span>Node基础</span></a></li><li><a aria-current="page" class="active" href="/backend/node/evenloop"><span>Node 事件循环</span></a></li><li><a href="/backend/node/yarn&amp;npm&amp;cnpm"><span>yarn、npm、cnpm 对比分析</span></a></li></ul></li><li><a href="/backend/test">测试</a><ul><li><a href="/backend/test/utils"><span>测试工具</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="Node 中事件循环阶段解析" data-depth="2" class=""><a href="/backend/node/evenloop#node-中事件循环阶段解析"><span>Node 中事件循环阶段解析</span></a></li><li title="关于 setTimeout 和 setImmediate" data-depth="2" class=""><a href="/backend/node/evenloop#关于-settimeout-和-setimmediate"><span>关于 setTimeout 和 setImmediate</span></a></li><li title="process.nextTick() and Promise" data-depth="2" class=""><a href="/backend/node/evenloop#processnexttick-and-promise"><span>process.nextTick() and Promise</span></a></li><li title="poll 阶段" data-depth="2" class=""><a href="/backend/node/evenloop#poll-阶段"><span>poll 阶段</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="node-事件循环"><a aria-hidden="true" href="#node-事件循环"><span class="icon icon-link"></span></a>Node 事件循环</h1><h2 id="node-中事件循环阶段解析"><a aria-hidden="true" href="#node-中事件循环阶段解析"><span class="icon icon-link"></span></a>Node 中事件循环阶段解析</h2><p>下面是事件循环不同阶段的示意图：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="   ┌───────────────────────┐
┌─&gt;│        timers         │&lt;————— 执行 setTimeout()、setInterval() 的回调
│  └──────────┬────────────┘
|             |&lt;-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调
│  ┌──────────┴────────────┐
│  │     pending callbacks │&lt;————— 执行由上一个 Tick 延迟下来的 I/O 回调（待完善，可忽略）
│  └──────────┬────────────┘
|             |&lt;-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调
│  ┌──────────┴────────────┐
│  │     idle, prepare     │&lt;————— 内部调用（可忽略）
│  └──────────┬────────────┘
|             |&lt;-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调
|             |                   ┌───────────────┐
│  ┌──────────┴────────────┐      │   incoming:   │ - (执行几乎所有的回调，除了 close callbacks 以及 timers 调度的回调和 setImmediate() 调度的回调，在恰当的时机将会阻塞在此阶段)
│  │         poll          │&lt;─────┤  connections, │
│  └──────────┬────────────┘      │   data, etc.  │
│             |                   |               |
|             |                   └───────────────┘
|             |&lt;-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调
|  ┌──────────┴────────────┐
│  │        check          │&lt;————— setImmediate() 的回调将会在这个阶段执行
│  └──────────┬────────────┘
|             |&lt;-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调
│  ┌──────────┴────────────┐
└──┤    close callbacks    │&lt;————— socket.on(&#x27;close&#x27;, ...)
   └───────────────────────┘
" data-status="copy"></button><div class="token-line"><span class="token plain">   ┌───────────────────────┐</span></div><div class="token-line"><span class="token plain">┌─</span><span class="token operator">&gt;</span><span class="token plain">│        timers         │</span><span class="token operator">&lt;</span><span class="token plain">————— 执行 setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain">、setInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> 的回调</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain">│  ┌──────────┴────────────┐</span></div><div class="token-line"><span class="token plain">│  │     pending callbacks │</span><span class="token operator">&lt;</span><span class="token plain">————— 执行由上一个 Tick 延迟下来的 I/O 回调（待完善，可忽略）</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain">│  ┌──────────┴────────────┐</span></div><div class="token-line"><span class="token plain">│  │     idle, prepare     │</span><span class="token operator">&lt;</span><span class="token plain">————— 内部调用（可忽略）</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token plain">                   ┌───────────────┐</span></div><div class="token-line"><span class="token plain">│  ┌──────────┴────────────┐      │   incoming:   │ - </span><span class="token punctuation">(</span><span class="token plain">执行几乎所有的回调，除了 close callbacks 以及 timers 调度的回调和 setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> 调度的回调，在恰当的时机将会阻塞在此阶段</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">│  │         poll          │</span><span class="token operator">&lt;</span><span class="token plain">─────┤  connections, │</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘      │   data, etc.  │</span></div><div class="token-line"><span class="token plain">│             </span><span class="token operator">|</span><span class="token plain">                   </span><span class="token operator">|</span><span class="token plain">               </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token plain">                   └───────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">  ┌──────────┴────────────┐</span></div><div class="token-line"><span class="token plain">│  │        check          │</span><span class="token operator">&lt;</span><span class="token plain">————— setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> 的回调将会在这个阶段执行</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 Next Tick Queue 以及 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain">│  ┌──────────┴────────────┐</span></div><div class="token-line"><span class="token plain">└──┤    close callbacks    │</span><span class="token operator">&lt;</span><span class="token plain">————— socket.on</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token plain">, </span><span class="token punctuation">..</span><span class="token plain">.</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   └───────────────────────┘</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>对比浏览器 想理解整个 loop 的过程，我们可以参照浏览器的 event loop，因为浏览器的比较简单，如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="   ┌───────────────────────┐
┌─&gt;│        timers         │&lt;————— 执行一个 MacroTask Queue 的回调
│  └──────────┬────────────┘
|             |&lt;-- 执行所有 MicroTask Queue 的回调
| ────────────┘
" data-status="copy"></button><div class="token-line"><span class="token plain">   ┌───────────────────────┐</span></div><div class="token-line"><span class="token plain">┌─</span><span class="token operator">&gt;</span><span class="token plain">│        timers         │</span><span class="token operator">&lt;</span><span class="token plain">————— 执行一个 MacroTask Queue 的回调</span></div><div class="token-line"><span class="token plain">│  └──────────┬────────────┘</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">             </span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token plain">-- 执行所有 MicroTask Queue 的回调</span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> ────────────┘</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>其实 nodejs 与浏览器的区别，就是 nodejs 的 MacroTask 分好几种，而这好几种又有不同的 task queue，而不同的 task queue 又有顺序区别，而 MicroTask 是穿插在每一种【注意不是每一个！】MacroTask 之间的。</p><p>其实图中已经画的很明白：</p><ul><li>setTimeout/setInterval 属于 timers 类型；</li><li>setImmediate 属于 check 类型；</li><li>socket 的 close 事件属于 close callbacks 类型；</li><li>其他 MacroTask 都属于 poll 类型。</li><li>process.nextTick 本质上属于 MicroTask，但是它先于所有其他 MicroTask 执行；</li><li>所有 MicroTask 的执行时机，是不同类型 MacroTask 切换的时候。</li><li>idle/prepare 仅供内部调用，我们可以忽略。</li><li>pending callbacks 不太常见，我们也可以忽略。</li></ul><p>所以我们可以按照浏览器的经验得出一个结论：</p><blockquote><p>先执行所有类型为 timers 的 MacroTask，然后执行所有的 MicroTask（注意 NextTick 要优先哦）； 进入 poll 阶段，执行几乎所有 MacroTask，然后执行所有的 MicroTask； 再执行所有类型为 check 的 MacroTask，然后执行所有的 MicroTask； 再执行所有类型为 close callbacks 的 MacroTask，然后执行所有的 MicroTask； 至此，完成一个 Tick，回到 timers 阶段； …… 如此反复，无穷无尽……</p></blockquote><h2 id="关于-settimeout-和-setimmediate"><a aria-hidden="true" href="#关于-settimeout-和-setimmediate"><span class="icon icon-link"></span></a>关于 setTimeout 和 setImmediate</h2><p>代码重现，我们会发现 setTimeout 和 setImmediate 在 Node 环境下执行是靠“随缘法则”的。</p><p>比如说下面这段代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setTimeout(() =&gt; {
  console.log(&quot;setTimeout&quot;);
}, 0);
setImmediate(() =&gt; {
  console.log(&quot;setImmediate&quot;);
});

// 执行的结果是这样子的：
setImmediate
setTimeout
// 再次执行
setTimeout
setImmediate
" data-status="copy"></button><div class="token-line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 执行的结果是这样子的：</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">setImmediate</span></div><div class="token-line"><span class="token plain">setTimeout</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 再次执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">setTimeout</span></div><div class="token-line"><span class="token plain">setImmediate</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>为什么会这样子呢？</p><p>这里我们要根据前面的那个事件循环不同阶段的图解来说明一下：</p><p>首先进入的是 <code>timers</code> 阶段，如果我们的机器性能一般，那么进入 <code>timers</code> 阶段，一毫秒已经过去了（<code>setTimeout(fn, 0)</code> 等价于 <code>setTimeout(fn, 1)</code>），那么 setTimeout 的回调会首先执行。</p><p>如果没有到一毫秒，那么在 timers 阶段的时候，下限时间没到，setTimeout 回调不执行，事件循环来到了 poll 阶段，这个时候队列为空，此时有代码被 setImmediate()，于是先执行了 setImmediate()的回调函数，之后在下一个事件循环再执行 setTimemout 的回调函数。</p><p>而我们在执行代码的时候，进入 timers 的时间延迟其实是随机的，并不是确定的，所以会出现两个函数执行顺序随机的情况。</p><p>那我们再来看一段代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var fs = require(&quot;fs&quot;);

fs.readFile(__filename, () =&gt; {
  setTimeout(() =&gt; {
    console.log(&quot;timeout&quot;);
  }, 0);
  setImmediate(() =&gt; {
    console.log(&quot;immediate&quot;);
  });
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">fs</span><span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token plain">__filename</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;immediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这里我们就会发现，setImmediate 永远先于 setTimeout 执行。</p><p>原因如下：</p><p>fs.readFile 的回调是在 poll 阶段执行的，当其回调执行完毕之后，poll 队列为空，而 setTimeout 入了 timers 的队列，此时有代码被 setImmediate()，于是事件循环先进入 check 阶段执行回调，之后在下一个事件循环再在 timers 阶段中执行有效回调。</p><p>同样的，这段代码也是一样的道理：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setTimeout(() =&gt; {
  setImmediate(() =&gt; {
    console.log(&quot;setImmediate&quot;);
  });
  setTimeout(() =&gt; {
    console.log(&quot;setTimeout&quot;);
  }, 0);
}, 0);
" data-status="copy"></button><div class="token-line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;setTimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>以上的代码在 timers 阶段执行外部的 setTimeout 回调后，内层的 setTimeout 和 setImmediate 入队，之后事件循环继续往后面的阶段走，走到 poll 阶段的时候发现队列为空，此时有代码被 setImmedate()，所以直接进入 check 阶段执行响应回调（注意这里没有去检测 timers 队列中是否有成员到达下限事件，因为 setImmediate()优先）。之后在第二个事件循环的 timers 阶段中再去执行相应的回调。</p><p>综上，我们可以总结：</p><blockquote><p>如果两者都在主模块中调用，那么执行先后取决于进程性能，也就是随机。 如果两者都不在主模块调用（被一个异步操作包裹），那么 setImmediate 的回调永远先执行。</p></blockquote><h2 id="processnexttick-and-promise"><a aria-hidden="true" href="#processnexttick-and-promise"><span class="icon icon-link"></span></a>process.nextTick() and Promise</h2><p>对于这两个，我们可以把它们理解成一个微任务。也就是说，它其实不属于事件循环的一部分。</p><p>那么他们是在什么时候执行呢？</p><p>不管在什么地方调用，他们都会在其所处的事件循环最后，事件循环进入下一个循环的阶段前执行。</p><p>举个?：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setTimeout(() =&gt; {
  console.log(&quot;timeout0&quot;);
  process.nextTick(() =&gt; {
    console.log(&quot;nextTick1&quot;);
    process.nextTick(() =&gt; {
      console.log(&quot;nextTick2&quot;);
    });
  });
  process.nextTick(() =&gt; {
    console.log(&quot;nextTick3&quot;);
  });
  console.log(&quot;sync&quot;);
  setTimeout(() =&gt; {
    console.log(&quot;timeout2&quot;);
  }, 0);
}, 0);
" data-status="copy"></button><div class="token-line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;timeout0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;timeout2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>结果是：</p><p>再解释一下：</p><p>timers 阶段执行外层 setTimeout 的回调，遇到同步代码先执行，也就有 timeout0、sync 的输出。遇到 process.nextTick 后入微任务队列，依次 nextTick1、nextTick3、nextTick2 入队后出队输出。之后，在下一个事件循环的 timers 阶段，执行 setTimeout 回调输出 timeout2。</p><p>最后 下面给出两段代码，如果能够理解其执行顺序说明你已经理解透彻。</p><p>代码 1：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="setImmediate(function() {
  console.log(&quot;setImmediate&quot;);
  setImmediate(function() {
    console.log(&quot;嵌套setImmediate&quot;);
  });
  process.nextTick(function() {
    console.log(&quot;nextTick&quot;);
  });
});

// setImmediate
// nextTick
// 嵌套setImmediate
" data-status="copy"></button><div class="token-line"><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;嵌套setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// setImmediate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// nextTick</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 嵌套setImmediate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>解析：事件循环 check 阶段执行回调函数输出 setImmediate，之后输出 nextTick。嵌套的 setImmediate 在下一个事件循环的 check 阶段执行回调输出嵌套的 setImmediate。</p><p>代码 2：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var fs = require(&quot;fs&quot;);

function someAsyncOperation(callback) {
  // 假设这个任务要消耗 95ms
  fs.readFile(&quot;/path/to/file&quot;, callback);
}

var timeoutScheduled = Date.now();

setTimeout(function() {
  var delay = Date.now() - timeoutScheduled;

  console.log(delay + &quot;ms have passed since I was scheduled&quot;);
}, 100);

// someAsyncOperation要消耗 95 ms 才能完成
someAsyncOperation(function() {
  var startCallback = Date.now();

  // 消耗 10ms...
  while (Date.now() - startCallback &lt; 10) {
    // do nothing
  }
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 假设这个任务要消耗 95ms</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  fs</span><span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/file&quot;</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> timeoutScheduled </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> delay </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> timeoutScheduled</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">delay </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&quot;ms have passed since I was scheduled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// someAsyncOperation要消耗 95 ms 才能完成</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> startCallback </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 消耗 10ms...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> startCallback </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// do nothing</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>解析：事件循环进入 poll 阶段发现队列为空，并且没有代码被 setImmediate()。于是在 poll 阶段等待 timers 下限时间到达。当等到 95ms 时，fs.readFile 首先执行了，它的回调被添加进 poll 队列并同步执行，耗时 10ms。此时总共时间累积 105ms。等到 poll 队列为空的时候，事件循环会查看最近到达的 timer 的下限时间，发现已经到达，再回到 timers 阶段，执行 timer 的回调。</p><h2 id="poll-阶段"><a aria-hidden="true" href="#poll-阶段"><span class="icon icon-link"></span></a>poll 阶段</h2><p>poll 阶段主要有两个功能：</p><ul><li>获取新的 I/O 事件，并执行这些 I/O 的回调，之后适当的条件下 node 将阻塞在这里</li><li>当有 immediate 或已超时的 timers，执行它们的回调</li></ul><p>poll 阶段用于获取并执行几乎所有 I/O 事件回调，是使得 node event loop 得以无限循环下去的重要阶段。所以它的首要任务就是同步执行所有 poll queue 中的所有 callbacks 直到 queue 被清空或者已执行的 callbacks 达到一定上限，然后结束 poll 阶段，接下来会有几种情况：</p><ol><li>setImmediate 的 queue 不为空，则进入 check 阶段，然后是 close callbacks 阶段……</li><li>setImmediate 的 queue 为空，但是 timers 的 queue 不为空，则直接进入 timers 阶段，然后又来到 poll 阶段……</li><li>setImmediate 的 queue 为空，timers 的 queue 也为空，此时会阻塞在这里，因为无事可做，也确实没有循环下去的必要</li></ol><p>参考 <a href="https://www.jianshu.com/p/deedcbf68880" target="_blank" rel="noopener noreferrer">nodejs中的event loop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>参考 <a href="https://segmentfault.com/a/1190000013102056?utm_source=tag-newest" target="_blank" rel="noopener noreferrer">Node的事件循环机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last Update: ">6/25/2020, 2:50:31 AM</span></div></div></div></div>

    <script src="/umi.js"></script>
  </body>
</html>
