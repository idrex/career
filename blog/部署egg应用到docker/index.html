<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg" />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.28
    </script>
    <title>部署egg应用到docker</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/">Drex</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/guide">指南</a><a href="/fontend">前端</a><a href="/backend">后端</a><a href="/devops">运维</a><a aria-current="page" class="active" href="/blog">博客</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/"></a><h1>Drex</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/guide">指南</a></li><li><a href="/fontend">前端</a></li><li><a href="/backend">后端</a></li><li><a href="/devops">运维</a></li><li><a aria-current="page" class="active" href="/blog">博客</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/blog">推荐网站</a></li><li><a href="/blog/ffmpeg">ffmpeg 下载 ts 文件视频</a></li><li><a href="/blog/lighthouse网站检测">Lighthouse 网站检测</a></li><li><a href="/blog/rbac权限管理">RBAC权限管理(Resource-Based Access Control)</a></li><li><a href="/blog/record">备案相关</a></li><li><a href="/blog/video">音视频</a></li><li><a href="/blog/website">网站性能测试指标</a></li><li><a href="/blog/yarn">yarn vs npm vs cnpm</a></li><li><a href="/blog/可变(mutable)和不变(immutable)对象的区别">可变(Mutable)和不变(Immutable)对象的区别</a></li><li><a href="/blog/知识产权">知识产权</a></li><li><a href="/blog/系统相关">系统相关</a></li><li><a href="/blog/网站克隆机 httrack">网站克隆机 HTTrack</a></li><li><a aria-current="page" class="active" href="/blog/部署egg应用到docker">部署egg应用到docker</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="部署egg应用到docker" data-depth="2" class=""><a href="/blog/部署egg应用到docker#部署egg应用到docker"><span>部署egg应用到docker</span></a></li><li title="部署" data-depth="3" class=""><a href="/blog/部署egg应用到docker#部署"><span>部署</span></a></li><li title="更新" data-depth="2" class=""><a href="/blog/部署egg应用到docker#更新"><span>更新</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="部署egg应用到docker"><a aria-hidden="true" href="#部署egg应用到docker"><span class="icon icon-link"></span></a>部署egg应用到docker</h2><h3 id="部署"><a aria-hidden="true" href="#部署"><span class="icon icon-link"></span></a>部署</h3><ol><li>egg.js应用需要修改根目录下的package.json（普通node.js应用可忽略这一步）：将start这行里命令里的--daemon去掉，即启动eggjs使用egg-scripts start就好了。在Docker里eggjs应用要在前台运行。</li><li>在本地应用的根目录下(package.json所在目录)新建一个名为Dockerfile的文件（无后缀），将以下内容复制到文件里，并将/usr/src/node-app/koa-server全部替换为你想设置的路径（该路径为docker容器里的路径，可自行设置）：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 设置基础镜像,如果本地没有该镜像，会从Docker.io服务器pull镜像
FROM node:slim

# 创建app目录
RUN mkdir -p /data/your-project

# 设置工作目录
WORKDIR /data/your-project

# 拷贝package.json文件到工作目录
# !!重要：package.json需要单独添加。
# Docker在构建镜像的时候，是一层一层构建的，仅当这一层有变化时，重新构建对应的层。
# 如果package.json和源代码一起添加到镜像，则每次修改源码都需要重新安装npm模块，这样木有必要。
# 所以，正确的顺序是: 添加package.json；安装npm模块；添加源代码。
COPY package.json /data/your-project/package.json

# 安装npm依赖(使用淘宝的镜像源)
# 如果使用的境外服务器，无需使用淘宝的镜像源，即改为`RUN npm i`。
RUN npm i --registry=https://registry.npm.taobao.org

# 拷贝所有源代码到工作目录
COPY . /data/your-project

# 打包TS应用(需要TS编译的项目需要添加)
RUN npm run ci

# 暴露容器端口(根据需求依此添加)
EXPOSE 7001

# 启动node应用
CMD npm start
" data-status="copy"></button><div class="token-line"><span class="token comment"># 设置基础镜像,如果本地没有该镜像，会从Docker.io服务器pull镜像</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">FROM node:slim</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 创建app目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">RUN </span><span class="token function">mkdir</span><span class="token plain"> -p /data/your-project</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 设置工作目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">WORKDIR /data/your-project</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 拷贝package.json文件到工作目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># !!重要：package.json需要单独添加。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># Docker在构建镜像的时候，是一层一层构建的，仅当这一层有变化时，重新构建对应的层。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果package.json和源代码一起添加到镜像，则每次修改源码都需要重新安装npm模块，这样木有必要。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 所以，正确的顺序是: 添加package.json；安装npm模块；添加源代码。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">COPY package.json /data/your-project/package.json</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 安装npm依赖(使用淘宝的镜像源)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果使用的境外服务器，无需使用淘宝的镜像源，即改为`RUN npm i`。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">RUN </span><span class="token function">npm</span><span class="token plain"> i --registry</span><span class="token operator">=</span><span class="token plain">https://registry.npm.taobao.org</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 拷贝所有源代码到工作目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">COPY </span><span class="token builtin class-name">.</span><span class="token plain"> /data/your-project</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 打包TS应用(需要TS编译的项目需要添加)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">RUN </span><span class="token function">npm</span><span class="token plain"> run ci</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 暴露容器端口(根据需求依此添加)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">EXPOSE </span><span class="token number">7001</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 启动node应用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">CMD </span><span class="token function">npm</span><span class="token plain"> start</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面的注释一目了然。整个过程简单描述就是：1.拉取docker镜像（并设置时区等）；2.创建docker工作目录，并将package.json拷贝到docker里；3.安装npm依赖；4.将服务器上的应用拷贝到docker里；5.暴露docker容器的端口，然后启动node应用。 3. 使用ftp工具或git工具将整个应用上传到生产环境服务器，并使用终端连接到服务器，进入到服务器应用的目录下；（过程略） 4. 执行以下命令，安装docker镜像；</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ sudo docker build -t node/koa-server .
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker build -t node/koa-server </span><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>-t是对该镜像进行tag标识，标识的名字为node/koa-server，可以自定义这个名字。镜像的构建过程依赖于网速，整体还比较快。npm依赖可能会久一些，因为egg.js的依赖比较多。如果所有步骤执行完，会有success的提示，安装成功了。 5. 执行以下命令，使用刚创建好的镜像来启动一个容器； 普通node.js应用</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ sudo docker run -d --name koa-server -p 7001:7001 node/koa-server
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker run -d --name koa-server -p </span><span class="token number">7001</span><span class="token plain">:7001 node/koa-server</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>-d为后台运行容器。如果普通node.js应用使用以上命令，容器使用9002端口，与Dockerfile里面的一致。 eggjs应用</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ sudo docker run -d --net=host --name koa-server node/koa-server
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker run -d --net</span><span class="token operator">=</span><span class="token plain">host --name koa-server node/koa-server</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>eggjs应用需要执行以上命令，即增加了--net=host，该参数表示使用host网络模式与主机共享网络来连接mysql数据库；(暂时使用这种模式成功了，后续研究其他更好方案)。 6. 执行以下命令查看容器是否启动成功；</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ docker ps
" data-status="copy"></button><div class="token-line"><span class="token plain">$ docker </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>以上命令是查看运行中的容器。如果刚才启动成功，则会显示出来。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ curl -i localhost:9002
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">curl</span><span class="token plain"> -i localhost:9002</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>也可以通过curl命令或者到浏览器里输入应用的访问地址，来查看能否访问应用，如果可以则安装成功。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ docker logs containerId
" data-status="copy"></button><div class="token-line"><span class="token plain">$ docker logs containerId</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果刚才执行docker ps没有看到刚刚启动的容器，说明启动失败，使用该命令来查看启动的具体情况。 7. docker容器里eggjs连接mysql： 只需要根据情况修改数据库相关信息即可，在host网络模式下，容器里eggjs的mysql配置文件里的host仍可设置为localhost。</p><h2 id="更新"><a aria-hidden="true" href="#更新"><span class="icon icon-link"></span></a>更新</h2><ol><li>通过查看容器列表，找到需要停止的容器ID；</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ docker ps
" data-status="copy"></button><div class="token-line"><span class="token plain">$ docker </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="2"><li>停止容器；</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ sudo docker stop containerId
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker stop containerId</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="3"><li>删除容器；</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ sudo docker rm containerId
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker </span><span class="token function">rm</span><span class="token plain"> containerId</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="4"><li>删除镜像；</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 正常情况可以删除
$ sudo docker rmi imageId
// 提示无法删除情况下，强制删除
$ sudo docker rmi -f imageId
" data-status="copy"></button><div class="token-line"><span class="token plain">// 正常情况可以删除</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker rmi imageId</span></div><div class="token-line"><span class="token plain">// 提示无法删除情况下，强制删除</span></div><div class="token-line"><span class="token plain">$ </span><span class="token function">sudo</span><span class="token plain"> docker rmi -f imageId</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="5"><li>将本地应用代码更新到服务器目录下。</li><li>按照上面的步骤重新构建镜像和启动容器。</li></ol></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last Update: ">11/27/2020, 9:47:03 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
  </body>
</html>
