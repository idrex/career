<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg" />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.12
    </script>
    <title>React</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/">Drex</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/guide">指南</a><a aria-current="page" class="active" href="/fontend">前端</a><a href="/backend">后端</a><a href="/devops">运维</a><a href="/blog">博客</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/"></a><h1>Drex</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/guide">指南</a></li><li><a aria-current="page" class="active" href="/fontend">前端</a></li><li><a href="/backend">后端</a></li><li><a href="/devops">运维</a></li><li><a href="/blog">博客</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/fontend">前端体系图</a></li><li><a href="/fontend/browser">浏览器</a><ul><li><a href="/fontend/browser/basic"><span>基础知识</span></a></li><li><a href="/fontend/browser/model"><span>浏览器模型</span></a></li><li><a href="/fontend/browser/optimization"><span>性能优化</span></a></li><li><a href="/fontend/browser/request"><span>网络请求</span></a></li></ul></li><li><a href="/fontend/html">Html</a><ul><li><a href="/fontend/html/basic"><span>基础知识</span></a></li></ul></li><li><a href="/fontend/css">CSS</a><ul><li><a href="/fontend/css/basic"><span>基础知识</span></a></li><li><a href="/fontend/css/less"><span>Less</span></a></li></ul></li><li><a href="/fontend/javasrcipt">Javasrcipt</a><ul><li><a href="/fontend/javasrcipt/basic"><span>基础中的基础</span></a></li><li><a href="/fontend/javasrcipt/application"><span>基础应用</span></a></li><li><a href="/fontend/javasrcipt/esnext"><span>ES6 &amp; ES Next</span></a></li><li><a href="/fontend/javasrcipt/ts"><span>TypeScript</span></a></li><li><a href="/fontend/javasrcipt/issues"><span>JS 相关方法实现</span></a></li><li><a href="/fontend/javasrcipt/optimization"><span>代码优化技巧</span></a></li></ul></li><li><a href="/fontend/construct">构建工具</a><ul><li><a href="/fontend/construct/webpack"><span>Webpack</span></a></li></ul></li><li><a aria-current="page" class="active" href="/fontend/frame">JS 框架</a><ul><li><a aria-current="page" class="active" href="/fontend/frame/react"><span>React</span></a></li><li><a href="/fontend/frame/redux"><span>Redux</span></a></li><li><a href="/fontend/frame/vue"><span>Vue</span></a></li></ul></li><li><a href="/fontend/mobile">移动&amp;桌面应用</a><ul><li><a href="/fontend/mobile/certificate"><span>证书说明</span></a></li><li><a href="/fontend/mobile/hybrid"><span>Hybrid</span></a></li><li><a href="/fontend/mobile/react-native"><span>React Native</span></a></li></ul></li><li><a href="/fontend/setup">工程体系</a><ul><li><a href="/fontend/setup/pattern"><span>体系格局</span></a></li><li><a href="/fontend/setup/engineering"><span>前端工程化</span></a></li></ul></li><li><a href="/fontend/package">Package</a><ul><li><a href="/fontend/package/module"><span>模块化标准</span></a></li><li><a href="/fontend/package/npm"><span>Npm</span></a></li><li><a href="/fontend/package/yarn"><span>Yarn</span></a></li></ul></li><li><a href="/fontend/security">Security</a><ul><li><a href="/fontend/security/monitor"><span>监控体系</span></a></li><li><a href="/fontend/security/web"><span>Web 安全</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="架构" data-depth="2" class=""><a href="/fontend/frame/react#架构"><span>架构</span></a></li><li title="Fiber" data-depth="3" class=""><a href="/fontend/frame/react#fiber"><span>Fiber</span></a></li><li title="Virtual DOM" data-depth="3" class=""><a href="/fontend/frame/react#virtual-dom"><span>Virtual DOM</span></a></li><li title="生命周期" data-depth="2" class=""><a href="/fontend/frame/react#生命周期"><span>生命周期</span></a></li><li title="渲染机制" data-depth="2" class=""><a href="/fontend/frame/react#渲染机制"><span>渲染机制</span></a></li><li title="key" data-depth="3" class=""><a href="/fontend/frame/react#key"><span>key</span></a></li><li title="setState" data-depth="3" class=""><a href="/fontend/frame/react#setstate"><span>setState</span></a></li><li title="forceUpdate" data-depth="3" class=""><a href="/fontend/frame/react#forceupdate"><span>forceUpdate</span></a></li><li title="事件机制" data-depth="2" class=""><a href="/fontend/frame/react#事件机制"><span>事件机制</span></a></li><li title="事件代理" data-depth="3" class=""><a href="/fontend/frame/react#事件代理"><span>事件代理</span></a></li><li title="事件 This 绑定" data-depth="3" class=""><a href="/fontend/frame/react#事件-this-绑定"><span>事件 This 绑定</span></a></li><li title="组件复用" data-depth="2" class=""><a href="/fontend/frame/react#组件复用"><span>组件复用</span></a></li><li title="HOC(高阶组件)" data-depth="3" class=""><a href="/fontend/frame/react#hoc高阶组件"><span>HOC(高阶组件)</span></a></li><li title="RenderProps" data-depth="3" class=""><a href="/fontend/frame/react#renderprops"><span>RenderProps</span></a></li><li title="通信机制" data-depth="2" class=""><a href="/fontend/frame/react#通信机制"><span>通信机制</span></a></li><li title="Props" data-depth="3" class=""><a href="/fontend/frame/react#props"><span>Props</span></a></li><li title="EventBus" data-depth="3" class=""><a href="/fontend/frame/react#eventbus"><span>EventBus</span></a></li><li title="Context" data-depth="3" class=""><a href="/fontend/frame/react#context"><span>Context</span></a></li><li title="Hooks" data-depth="2" class=""><a href="/fontend/frame/react#hooks"><span>Hooks</span></a></li><li title="优缺点" data-depth="3" class=""><a href="/fontend/frame/react#优缺点"><span>优缺点</span></a></li><li title="注意事项" data-depth="3" class=""><a href="/fontend/frame/react#注意事项"><span>注意事项</span></a></li><li title="状态钩子(useState)" data-depth="3" class=""><a href="/fontend/frame/react#状态钩子usestate"><span>状态钩子(useState)</span></a></li><li title="生命周期钩子(useEffect)" data-depth="3" class=""><a href="/fontend/frame/react#生命周期钩子useeffect"><span>生命周期钩子(useEffect)</span></a></li><li title="其它内置钩子" data-depth="3" class=""><a href="/fontend/frame/react#其它内置钩子"><span>其它内置钩子</span></a></li><li title="自定义钩子(useXxxxx)" data-depth="3" class=""><a href="/fontend/frame/react#自定义钩子usexxxxx"><span>自定义钩子(useXxxxx)</span></a></li><li title="模仿Hooks" data-depth="3" class=""><a href="/fontend/frame/react#模仿hooks"><span>模仿Hooks</span></a></li><li title="Hooks 实现 Redux" data-depth="3" class=""><a href="/fontend/frame/react#hooks-实现-redux"><span>Hooks 实现 Redux</span></a></li><li title="SSR" data-depth="2" class=""><a href="/fontend/frame/react#ssr"><span>SSR</span></a></li><li title="React-Router" data-depth="2" class=""><a href="/fontend/frame/react#react-router"><span>React-Router</span></a></li><li title="History" data-depth="3" class=""><a href="/fontend/frame/react#history"><span>History</span></a></li><li title="基本原理" data-depth="3" class=""><a href="/fontend/frame/react#基本原理"><span>基本原理</span></a></li><li title="具体实现" data-depth="3" class=""><a href="/fontend/frame/react#具体实现"><span>具体实现</span></a></li><li title="函数式编程" data-depth="2" class=""><a href="/fontend/frame/react#函数式编程"><span>函数式编程</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><p><strong>React</strong></p><p><code>React</code> 也是现如今最流行的前端框架，也是很多大厂面试必备。<code>React</code> 与 <code>Vue</code> 虽有不同，但同样作为一款 <code>UI</code> 框架，虽然实现可能不一样，但在一些理念上还是有相似的，例如数据驱动、组件化、虚拟 <code>dom</code> 等。这里就主要列举一些 React 中独有的概念。</p><h2 id="架构"><a aria-hidden="true" href="#架构"><span class="icon icon-link"></span></a>架构</h2><h3 id="fiber"><a aria-hidden="true" href="#fiber"><span class="icon icon-link"></span></a>Fiber</h3><p>React16 提出了 Fiber 结构，其能够将任务分片，划分优先级，同时能够实现类似于操作系统中对线程的抢占式调度，非常强大。</p><p>React 的核心流程可以分为两个部分:</p><ul><li>reconciliation (<strong>调度算法</strong>，也可称为 render):<ul><li>更新 state 与 props；</li><li>调用生命周期钩子；</li><li>生成 virtual dom；</li><li>通过新旧 vdom 进行 diff 算法，获取 vdom change；</li><li>确定是否需要重新渲染</li></ul></li><li>commit:<ul><li>如需要，则操作 dom 节点更新；</li></ul></li></ul><p>要了解 Fiber，我们首先来看为什么需要它？</p><ul><li><p><strong>问题</strong>: 随着应用变得越来越庞大，整个更新渲染的过程开始变得吃力，大量的组件渲染会导致主进程长时间被占用，导致一些动画或高频操作出现卡顿和掉帧的情况。而关键点，便是 <strong>同步阻塞</strong>。在之前的调度算法中，React 需要实例化每个类组件，生成一颗组件树，使用 <strong>同步递归</strong> 的方式进行遍历渲染，而这个过程最大的问题就是无法 <strong>暂停和恢复</strong>。</p></li><li><p><strong>解决方案</strong>: 解决同步阻塞的方法，通常有两种: <strong>异步</strong> 与 <strong>任务分割</strong>。而 React Fiber 便是为了实现任务分割而诞生的。</p></li><li><p><strong>简述</strong>:</p><ul><li>在 React V16 将调度算法进行了重构， 将之前的 stack reconciler 重构成新版的 fiber reconciler，变成了具有链表和指针的 <strong>单链表树遍历算法</strong>。通过指针映射，每个单元都记录着遍历当下的上一步与下一步，从而使遍历变得可以被暂停和重启。</li><li>这里我理解为是一种 <strong>任务分割调度算法</strong>，主要是 将原先同步更新渲染的任务分割成一个个独立的 <strong>小任务单位</strong>，根据不同的优先级，将小任务分散到浏览器的空闲时间执行，充分利用主进程的事件循环机制。</li></ul></li><li><p><strong>核心</strong>:</p><ul><li>Fiber 这里可以具象为一个 <strong>数据结构</strong>:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class Fiber {
  constructor(instance) {
    this.instance = instance;
    // 指向第一个 child 节点
    this.child = child;
    // 指向父节点
    this.return = parent;
    // 指向第一个兄弟节点
    this.sibling = previous;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Fiber</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 指向第一个 child 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 指向父节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">return</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 指向第一个兄弟节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> previous</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p><strong>链表树遍历算法</strong>: 通过 <strong>节点保存与映射</strong>，便能够随时地进行 停止和重启，这样便能达到实现任务分割的基本前提；</p><ul><li>1、首先通过不断遍历子节点，到树末尾；</li><li>2、开始通过 sibling 遍历兄弟节点；</li><li>3、return 返回父节点，继续执行 2；</li><li>4、直到 root 节点后，跳出遍历；</li></ul></li><li><p><strong>任务分割</strong>，React 中的渲染更新可以分成两个阶段:</p><ul><li><strong>reconciliation 阶段</strong>: vdom 的数据对比，是个适合拆分的阶段，比如对比一部分树后，先暂停执行个动画调用，待完成后再回来继续比对。</li><li><strong>Commit 阶段</strong>: 将 change list 更新到 dom 上，不适合拆分，因为使用 vdom 的意义就是为了节省传说中最耗时的 dom 操作，把所有操作一次性更新，如果在这里又拆分，那不是又懵了么。🙃</li></ul></li><li><p><strong>分散执行</strong>: 任务分割后，就可以把小任务单元分散到浏览器的空闲期间去排队执行，而实现的关键是两个新 API: <code>requestIdleCallback</code> 与 <code>requestAnimationFrame</code></p><ul><li>低优先级的任务交给<code>requestIdleCallback</code>处理，这是个浏览器提供的事件循环空闲期的回调函数，需要 pollyfill，而且拥有 deadline 参数，限制执行事件，以继续切分任务；</li><li>高优先级的任务交给<code>requestAnimationFrame</code>处理；</li></ul></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 类似于这样的方式
requestIdleCallback((deadline) =&gt; {
  // 当有空闲时间时，我们执行一个组件渲染；
  // 把任务塞到一个个碎片时间中去；
  while (
    (deadline.timeRemaining() &gt; 0 || deadline.didTimeout) &amp;&amp;
    nextComponent
  ) {
    nextComponent = performWork(nextComponent);
  }
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// 类似于这样的方式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当有空闲时间时，我们执行一个组件渲染；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 把任务塞到一个个碎片时间中去；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">deadline</span><span class="token punctuation">.</span><span class="token method function property-access">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> deadline</span><span class="token punctuation">.</span><span class="token property-access">didTimeout</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextComponent</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextComponent </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performWork</span><span class="token punctuation">(</span><span class="token plain">nextComponent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><strong>优先级策略</strong>: 文本框输入 &gt; 本次调度结束需完成的任务 &gt; 动画过渡 &gt; 交互反馈 &gt; 数据更新 &gt; 不会显示但以防将来会显示的任务</li></ul></li></ul><blockquote><p>Tips:</p><p>Fiber 其实可以算是一种编程思想，在其它语言中也有许多应用(Ruby Fiber)。当遇到进程阻塞的问题时，<strong>任务分割</strong>、<strong>异步调用</strong> 和 <strong>缓存策略</strong> 是三个显著的解决思路。</p></blockquote><h3 id="virtual-dom"><a aria-hidden="true" href="#virtual-dom"><span class="icon icon-link"></span></a>Virtual DOM</h3><p>虽然DOM是由JavaScript实现的，但是在浏览器中都是把DOM和JavaScript分开来实现的，比如IE中，JavaScript的实现名为JScript，放在jscript.dll文件中，而DOM则放在另一个叫做mshtml.dll的库中。在Safari中，DOM和渲染是使用Webkit中的WebCore实现，而JavaScript是由独立的JavaScriptCore引擎实现，同样在Chrome中，同样是使用WebCore来实现渲染，而JavaScript引擎则是他们自己研发的V8引擎。</p><p>由于DOM和JavaScript是被分开独立实现的，因此，每一次在通过js操作DOM的时候，就需要先去连接js和DOM，我们可以这样理解：把DOM和JavaScript比作两个岛，他们之间通过一个收费的桥连接着，每一次访问DOM的时候，就需要经过这座桥，并且给“过路费”，访问的次数越多，路费就会越高，并且访问到DOM后，操作具体的DOM还需要给“操作费”，由于浏览器访问DOM的操作很多，因此，“路费”和“操作费”自然会增加，这就是为什么操作DOM会很慢的原因</p><h2 id="生命周期"><a aria-hidden="true" href="#生命周期"><span class="icon icon-link"></span></a>生命周期</h2><p>在新版本中，React 官方对生命周期有了新的 <strong>变动建议</strong>:</p><ul><li>使用<code>getDerivedStateFromProps</code> 替换<code>componentWillMount</code>；</li><li>使用<code>getSnapshotBeforeUpdate</code>替换<code>componentWillUpdate</code>；</li><li>避免使用<code>componentWillReceiveProps</code>；</li></ul><p>其实该变动的原因，正是由于上述提到的 Fiber。首先，从上面我们知道 React 可以分成 reconciliation 与 commit 两个阶段，对应的生命周期如下:</p><ul><li><p><strong>reconciliation</strong>:</p><ul><li><code>componentWillMount</code></li><li><code>componentWillReceiveProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code></li></ul></li><li><p><strong>commit</strong>:</p><ul><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>componentWillUnmount</code></li></ul></li></ul><p>在 Fiber 中，reconciliation 阶段进行了任务分割，涉及到 暂停 和 重启，因此可能会导致 reconciliation 中的生命周期函数在一次更新渲染循环中被 <strong>多次调用</strong> 的情况，产生一些意外错误。</p><p>新版的建议生命周期如下:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class Component extends React.Component {
  // 替换 `componentWillReceiveProps` ，
  // 初始化和 update 时被调用
  // 静态函数，无法使用 this
  static getDerivedStateFromProps(nextProps, prevState) {}

  // 判断是否需要更新组件
  // 可以用于组件性能优化
  shouldComponentUpdate(nextProps, nextState) {}

  // 组件被挂载后触发
  componentDidMount() {}

  // 替换 componentWillUpdate
  // 可以在更新之前获取最新 dom 数据
  getSnapshotBeforeUpdate() {}

  // 组件更新后调用
  componentDidUpdate() {}

  // 组件即将销毁
  componentWillUnmount() {}

  // 组件已销毁
  componentDidUnMount() {}
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 替换 `componentWillReceiveProps` ，</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 初始化和 update 时被调用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 静态函数，无法使用 this</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> prevState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 判断是否需要更新组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 可以用于组件性能优化</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> nextState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件被挂载后触发</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 替换 componentWillUpdate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 可以在更新之前获取最新 dom 数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件更新后调用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件即将销毁</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件已销毁</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">componentDidUnMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p><strong>使用建议</strong>:</p><ul><li>在<code>constructor</code>初始化 state；</li><li>在<code>componentDidMount</code>中进行事件监听，并在<code>componentWillUnmount</code>中解绑事件；</li><li>在<code>componentDidMount</code>中进行数据的请求，而不是在<code>componentWillMount</code>；</li><li>需要根据 props 更新 state 时，使用<code>getDerivedStateFromProps(nextProps, prevState)</code>；<ul><li>旧 props 需要自己存储，以便比较；</li></ul></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="public static getDerivedStateFromProps(nextProps, prevState) {
  // 当新 props 中的 data 发生变化时，同步更新到 state 上
  if (nextProps.data !== prevState.data) {
    return {
      data: nextProps.data
    }
  } else {
    return null1
  }
  }
" data-status="copy"></button><div class="token-line"><span class="token keyword">public</span><span class="token plain"> </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> prevState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当新 props 中的 data 发生变化时，同步更新到 state 上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextProps</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> prevState</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      data</span><span class="token punctuation">:</span><span class="token plain"> nextProps</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> null1</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>可以在<code>componentDidUpdate</code>监听 props 或者 state 的变化，例如:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="componentDidUpdate(prevProps) {
  // 当 id 发生变化时，重新获取数据
  if (this.props.id !== prevProps.id) {
    this.fetchData(this.props.id);
  }
}
" data-status="copy"></button><div class="token-line"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当 id 发生变化时，重新获取数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> prevProps</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">fetchData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>在<code>componentDidUpdate</code>使用<code>setState</code>时，必须加条件，否则将进入死循环；</li><li><code>getSnapshotBeforeUpdate(prevProps, prevState)</code>可以在更新之前获取最新的渲染数据，它的调用是在 render 之后， mounted 之前；</li><li><code>shouldComponentUpdate</code>: 默认每次调用<code>setState</code>，一定会最终走到 diff 阶段，但可以通过<code>shouldComponentUpdate</code>的生命钩子返回<code>false</code>来直接阻止后面的逻辑执行，通常是用于做条件渲染，优化渲染的性能。</li></ul></li></ul><h2 id="渲染机制"><a aria-hidden="true" href="#渲染机制"><span class="icon icon-link"></span></a>渲染机制</h2><h3 id="key"><a aria-hidden="true" href="#key"><span class="icon icon-link"></span></a>key</h3><blockquote><p>key 是给每一个 vnode 的唯一 id,可以依靠 key,更准确, 更快的拿到 oldVnode 中对应的 vnode 节点。</p></blockquote><ol><li><p>更准确 因为带 key 就不是就地复用了，在 sameNode 函数 a.key === b.key 对比中可以避免就地复用的情况。所以会更加准确。</p></li><li><p>更快 利用 key 的唯一性生成 map 对象来获取对应节点，比遍历方式更快。(这个观点，就是我最初的那个观点。从这个角度看，map 会比遍历更快。)</p></li></ol><h3 id="setstate"><a aria-hidden="true" href="#setstate"><span class="icon icon-link"></span></a>setState</h3><p>在了解<code>setState</code>之前，我们先来简单了解下 React 一个包装结构: <strong>Transaction</strong>:</p><ul><li><strong>事务</strong> (Transaction):<ul><li>是 React 中的一个调用结构，用于包装一个方法，结构为: <strong>initialize - perform(method) - close</strong>。通过事务，可以统一管理一个方法的开始与结束；处于事务流中，表示进程正在执行一些操作；</li></ul></li></ul><img width="750" src="https://raw.githubusercontent.com/xd-tayde/blog/master/images/interview/7.png"/><ul><li><p><code>setState</code>: React 中用于修改状态，更新视图。它具有以下特点:</p></li><li><p><strong>异步与同步</strong>: <code>setState</code>并不是单纯的异步或同步，这其实与调用时的环境相关:</p><ul><li>在 <strong>合成事件</strong> 和 <strong>生命周期钩子(除 componentDidUpdate)</strong> 中，<code>setState</code>是&quot;异步&quot;的；<ul><li><strong>原因</strong>: 因为在<code>setState</code>的实现中，有一个判断: 当更新策略正在事务流的执行中时，该组件更新会被推入<code>dirtyComponents</code>队列中等待执行；否则，开始执行<code>batchedUpdates</code>队列更新；<ul><li>在生命周期钩子调用中，更新策略都处于更新之前，组件仍处于事务流中，而<code>componentDidUpdate</code>是在更新之后，此时组件已经不在事务流中了，因此则会同步执行；</li><li>在合成事件中，React 是基于 <strong>事务流完成的事件委托机制</strong> 实现，也是处于事务流中；</li></ul></li><li><strong>问题</strong>: 无法在<code>setState</code>后马上从<code>this.state</code>上获取更新后的值。</li><li><strong>解决</strong>: 如果需要马上同步去获取新值，<code>setState</code>其实是可以传入第二个参数的。<code>setState(updater, callback)</code>，在回调中即可获取最新值；</li></ul></li><li>在 <strong>原生事件</strong> 和 <strong>setTimeout</strong> 中，<code>setState</code>是同步的，可以马上获取更新后的值；<ul><li>原因: 原生事件是浏览器本身的实现，与事务流无关，自然是同步；而<code>setTimeout</code>是放置于定时器线程中延后执行，此时事务流已结束，因此也是同步；</li></ul></li></ul></li><li><p><strong>批量更新</strong>: 在 <strong>合成事件</strong> 和 <strong>生命周期钩子</strong> 中，<code>setState</code>更新队列时，存储的是 <strong>合并状态</strong>(<code>Object.assign</code>)。因此前面设置的 key 值会被后面所覆盖，最终只会执行一次更新；</p></li><li><p><strong>函数式</strong>: 由于 Fiber 及 合并 的问题，官方推荐可以传入 <strong>函数</strong> 的形式。<code>setState(fn)</code>，在<code>fn</code>中返回新的<code>state</code>对象即可，例如<code>this.state((state, props) =&gt; newState)；</code></p><ul><li>使用函数式，可以用于避免<code>setState</code>的批量更新的逻辑，传入的函数将会被 <strong>顺序调用</strong>；</li></ul></li><li><p><strong>注意事项</strong>:</p><ul><li>setState 合并，在 合成事件 和 生命周期钩子 中多次连续调用会被优化为一次；</li><li>当组件已被销毁，如果再次调用<code>setState</code>，React 会报错警告，通常有两种解决办法:<ul><li>将数据挂载到外部，通过 props 传入，如放到 Redux 或 父级中；</li><li>在组件内部维护一个状态量 (isUnmounted)，<code>componentWillUnmount</code>中标记为 true，在<code>setState</code>前进行判断；</li></ul></li></ul></li></ul><h3 id="forceupdate"><a aria-hidden="true" href="#forceupdate"><span class="icon icon-link"></span></a>forceUpdate</h3><p>强制React组件渲染的方法有多种，但本质上是相同的。 首先是使用this.forceUpdate() ，它会跳过shouldComponentUpdate</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="someMethod() {
  // Force a render without state change...
  this.forceUpdate();
}
" data-status="copy"></button><div class="token-line"><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Force a render without state change...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="事件机制"><a aria-hidden="true" href="#事件机制"><span class="icon icon-link"></span></a>事件机制</h2><ul><li>React事件是合成事件</li><li>有stopPropagation和preventDefault</li><li>有nativeEvent上的所有属性</li><li>可以通过nativeEvent获取到原生事件</li><li>跨浏览器兼容</li></ul><h3 id="事件代理"><a aria-hidden="true" href="#事件代理"><span class="icon icon-link"></span></a>事件代理</h3><p>首先回顾以下原生事件的两个方法：<code>event.stopImmediatePropagation</code> 和 <code>event.stopPropagation</code> ，前者可以阻止同一 dom 上的后续事件的执行以及阻止冒泡，后者仅能阻止冒泡。</p><p>在 react 内通过 onClick 绑定的事件，实际上并没有把点击事件绑定到对应的元素上，而是统一放到了 document 上处理。点击一个元素，首先触发这个元素的原生绑定事件（这里不讨论捕获），接着事件冒泡，到了 document 上，先触发 dispatch，即分发 react 的合成事件，这个触发过程也是和冒泡类似，从里向外的。</p><p>dispatch 结束后，触发 document 上剩余的原生事件，也就是说可以认为 dispatch 是 document 上的第一个原生绑定事件，这个事件内进行 react 合成事件的分发。</p><p>原生绑定的回调事件中获取到的是原生事件。通过 react 在 jsx 内 onClick 绑定的回调事件中获取到的是合成事件。</p><p>如果你有试过输出 react 事件中的 event，你就会发现这个 event 好像和我们看到的 dom 事件中的 event 不太一样，那是因为 react 在进行 dom 事件绑定时，不是直接绑定事件的，而是通过所谓的合成事件(SyntheticEvent)进行委托管理的，它是原生事件进行封装后的结果，你可以通过 nativeEvent 获取原生事件。</p></div><div class="__dumi-default-previewer "><div class="__dumi-default-previewer-demo"><div class="App">打开控制台，点击 <button>按钮</button></div></div><div class="__dumi-default-previewer-desc"></div><div class="__dumi-default-previewer-actions"><form style="display:flex" method="POST" action="https://codesandbox.io/api/v1/sandboxes/define?query=module=/demo.jsx" target="_blank"><button class="__dumi-default-icon" role="codesandbox" type="submit"></button><input type="hidden" value="" name="parameters"/></form><span></span><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy " data-status="copy"></button><button class="__dumi-default-icon" role="source" type="button"></button></div></div><div class="markdown"><h3 id="事件-this-绑定"><a aria-hidden="true" href="#事件-this-绑定"><span class="icon icon-link"></span></a>事件 This 绑定</h3><ol><li>bind 如果一个事件只会被使用一次，则使用 bind 进行绑定是比较方便的：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="onClick = { this.clickHandle.bind(this,[other params]) }
" data-status="copy"></button><div class="token-line"><span class="token plain">onClick </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">clickHandle</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token plain">other params</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="2"><li>构造函数中绑定 如果一个事件处理函数可能会多次绑定，则使用构造函数中绑定一次即可.</li></ol><p>在 JSX 中可以直接使用 <code>onClick = <!-- -->{<!-- --> this.clickHandle <!-- -->}</code> 绑定事件</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="constructor(props){
  super(props);

  this.clickHandle = this.handleClick.bind(this);

  render() {
    return &lt;button onClick = { this.handleClick }&gt;click&lt;/button&gt;;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">clickHandle</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">button onClick </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain">click</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="3"><li>箭头函数</li></ol><p>箭头函数的特点是， 能够自动绑定定义此函数作用域的 this 。</p><p>箭头函数脱离不了函数这个范围，因此其 this 指向依旧是最终调用该函数的作用域 this。（这句话是否正确或者合理目前个人并不是很清楚）</p><p>所以也可以通过这个特性实现绑定。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="onClick={ () =&gt; this.handleClick() }
" data-status="copy"></button><div class="token-line"><span class="token plain">onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="组件复用"><a aria-hidden="true" href="#组件复用"><span class="icon icon-link"></span></a>组件复用</h2><h3 id="hoc高阶组件"><a aria-hidden="true" href="#hoc高阶组件"><span class="icon icon-link"></span></a>HOC(高阶组件)</h3><p>HOC(Higher Order Componennt) 是在 React 机制下社区形成的一种组件模式，在很多第三方开源库中表现强大。</p><ul><li><p><strong>简述</strong>:</p><ul><li>高阶组件不是组件，是 <strong>增强函数</strong>，可以输入一个元组件，返回出一个新的增强组件；</li><li>高阶组件的主要作用是 <strong>代码复用</strong>，<strong>操作</strong> 状态和参数；</li></ul></li><li><p><strong>用法</strong>:</p><ul><li><p><strong>属性代理 (Props Proxy)</strong>: 返回出一个组件，它基于被包裹组件进行 <strong>功能增强</strong>；</p><ul><li><strong>默认参数</strong>: 可以为组件包裹一层默认参数；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function proxyHoc(Comp) {
  return class extends React.Component {
    render() {
      const newProps = {
        name: &quot;tayde&quot;,
        age: 1,
      };
      return &lt;Comp {...this.props} {...newProps} /&gt;;
    }
  };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">proxyHoc</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;tayde&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        age</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">newProps</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><strong>提取状态</strong>: 可以通过 props 将被包裹组件中的 state 依赖外层，例如用于转换受控组件:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function withOnChange(Comp) {
  return class extends React.Component {
    constructor(props) {
      super(props);
      this.state = {
        name: &quot;&quot;,
      };
    }
    onChangeName = () =&gt; {
      this.setState({
        name: &quot;dongdong&quot;,
      });
    };
    render() {
      const newProps = {
        value: this.state.name,
        onChange: this.onChangeName,
      };
      return &lt;Comp {...this.props} {...newProps} /&gt;;
    }
  };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">withOnChange</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function-variable function">onChangeName</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;dongdong&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        value</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        onChange</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onChangeName</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">newProps</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>使用姿势如下，这样就能非常快速的将一个 <code>Input</code> 组件转化成受控组件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const NameInput = (props) =&gt; &lt;input name=&quot;name&quot; {...props} /&gt;;
export default withOnChange(NameInput);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">NameInput</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">input name</span><span class="token operator">=</span><span class="token string">&quot;name&quot;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token function">withOnChange</span><span class="token punctuation">(</span><span class="token maybe-class-name">NameInput</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><strong>包裹组件</strong>: 可以为被包裹元素进行一层包装，</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function withMask(Comp) {
  return class extends React.Component {
    render() {
      return (
        &lt;div&gt;
          &lt;Comp {...this.props} /&gt;
          &lt;div style={{
            width: &#x27;100%&#x27;,
            height: &#x27;100%&#x27;,
            backgroundColor: &#x27;rgba(0, 0, 0, .6)&#x27;,
          }}
        &lt;/div&gt;
      )
    }
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">withMask</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">div style</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            width</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;100%&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            height</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;100%&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            backgroundColor</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;rgba(0, 0, 0, .6)&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li><li><p><strong>反向继承</strong> (Inheritance Inversion): 返回出一个组件，<strong>继承于被包裹组件</strong>，常用于以下操作:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function IIHoc(Comp) {
  return class extends Comp {
    render() {
      return super.render();
    }
  };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">IIHoc</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p><strong>渲染劫持</strong> (Render Highjacking)</p><ul><li><strong>条件渲染</strong>: 根据条件，渲染不同的组件</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function withLoading(Comp) {
  return class extends Comp {
    render() {
      if (this.props.isLoading) {
        return &lt;Loading /&gt;;
      } else {
        return super.render();
      }
    }
  };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">withLoading</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">isLoading</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Loading</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>可以直接修改被包裹组件渲染出的 React 元素树</li></ul></li><li><p><strong>操作状态</strong> (Operate State): 可以直接通过 <code>this.state</code> 获取到被包裹组件的状态，并进行操作。但这样的操作容易使 state 变得难以追踪，不易维护，谨慎使用。</p></li></ul></li></ul></li><li><p><strong>应用场景</strong>:</p><ul><li><strong>权限控制</strong>，通过抽象逻辑，统一对页面进行权限判断，按不同的条件进行页面渲染:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function withAdminAuth(WrappedComponent) {
  return class extends React.Component {
    constructor(props) {
      super(props);
      this.state = {
        isAdmin: false,
      };
    }
    async componentWillMount() {
      const currentRole = await getCurrentUserRole();
      this.setState({
        isAdmin: currentRole === &quot;Admin&quot;,
      });
    }
    render() {
      if (this.state.isAdmin) {
        return &lt;Comp {...this.props} /&gt;;
      } else {
        return &lt;div&gt;您没有权限查看该页面，请联系管理员！&lt;/div&gt;;
      }
    }
  };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">withAdminAuth</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        isAdmin</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> currentRole </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">getCurrentUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        isAdmin</span><span class="token punctuation">:</span><span class="token plain"> currentRole </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">isAdmin</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain">您没有权限查看该页面，请联系管理员！</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><strong>性能监控</strong>，包裹组件的生命周期，进行统一埋点:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function withTiming(Comp) {
    return class extends Comp {
        constructor(props) {
            super(props);
            this.start = Date.now();
            this.end = 0;
        }
        componentDidMount() {
            super.componentDidMount &amp;&amp; super.componentDidMount();
            this.end = Date.now();
            console.log(`${WrappedComponent.name} 组件渲染时间为 ${this.end - this.start} ms`);
        }
        render() {
            return super.render();
        }
    };
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">withTiming</span><span class="token punctuation">(</span><span class="token parameter">Comp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">extends</span><span class="token plain"> </span><span class="token maybe-class-name">Comp</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token property-access">componentDidMount</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">WrappedComponent</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> 组件渲染时间为 </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation keyword">this</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation">end </span><span class="token template-string interpolation operator">-</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation keyword">this</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation">start</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> ms</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><strong>代码复用</strong>，可以将重复的逻辑进行抽象。</li></ul></li><li><p>使用注意:</p><ul><li><ol><li><strong>纯函数</strong>: 增强函数应为纯函数，避免侵入修改元组件；</li></ol></li><li><ol start="2"><li><strong>避免用法污染</strong>: 理想状态下，应透传元组件的无关参数与事件，尽量保证用法不变；</li></ol></li><li><ol start="3"><li><strong>命名空间</strong>: 为 HOC 增加特异性的组件名称，这样能便于开发调试和查找问题；</li></ol></li><li><ol start="4"><li><strong>引用传递</strong>: 如果需要传递元组件的 refs 引用，可以使用<code>React.forwardRef</code>；</li></ol></li><li><ol start="5"><li><strong>静态方法</strong>: 元组件上的静态方法并无法被自动传出，会导致业务层无法调用；解决:</li></ol><ul><li>函数导出</li><li>静态方法赋值</li></ul></li><li><ol start="6"><li><strong>重新渲染</strong>: 由于增强函数每次调用是返回一个新组件，因此如果在 Render 中使用增强函数，就会导致每次都重新渲染整个 HOC，而且之前的状态会丢失；</li></ol></li></ul></li></ul><h3 id="renderprops"><a aria-hidden="true" href="#renderprops"><span class="icon icon-link"></span></a>RenderProps</h3><p>在调用组件时，引入一个函数类型的 prop，这个 prop 定义了组件的渲染方式。</p><p>而 render props 本质实际上是使用到了回调的方式来通信。只不过在传统的 js 回调是在构造函数中进行初始化（使用回调函数作为参数），而在 react 中，现在可以通过 props 传入该回调函数，就是我们所介绍的 render prop。</p><p>回调的目的是渲染子组件，而渲染的外部细节需要通过父组件注入，实现了控制反转。</p></div><div class="__dumi-default-previewer "><div class="__dumi-default-previewer-demo"><div><div>Hello! <!-- -->Drex</div></div></div><div class="__dumi-default-previewer-desc"></div><div class="__dumi-default-previewer-actions"><form style="display:flex" method="POST" action="https://codesandbox.io/api/v1/sandboxes/define?query=module=/demo.jsx" target="_blank"><button class="__dumi-default-icon" role="codesandbox" type="submit"></button><input type="hidden" value="" name="parameters"/></form><a target="_blank" rel="noopener noreferrer" href="/_demos/render-props"><button class="__dumi-default-icon" role="open-demo" type="button"></button></a><span></span><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy " data-status="copy"></button><button class="__dumi-default-icon" role="source" type="button"></button></div></div><div class="markdown"><h2 id="通信机制"><a aria-hidden="true" href="#通信机制"><span class="icon icon-link"></span></a>通信机制</h2><p>组件间进行消息传递（通信），组件间通信大体有下面几种情况：</p><ul><li>父组件向子组件通信</li><li>子组件向父组件通信</li><li>兄弟组件通信</li><li>跨级组件之间通信</li><li>非嵌套组件间通信</li></ul><h3 id="props"><a aria-hidden="true" href="#props"><span class="icon icon-link"></span></a>Props</h3><p>简单的父子，兄弟之间的通信用<code>Props</code>传值，用<code>Callback</code>进行回调赋值</p><h3 id="eventbus"><a aria-hidden="true" href="#eventbus"><span class="icon icon-link"></span></a>EventBus</h3><p>作为中间介子进行事件汇总及发布，参考<a href="/guide/common/设计模式#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F">发布订阅模式</a></p><h3 id="context"><a aria-hidden="true" href="#context"><span class="icon icon-link"></span></a>Context</h3><p><code>Context</code> 通过组件树提供了一个传递数据的方法，从而避免了在每一个层级手动的传递 <code>props</code> 属性。Redux就是通过这个方式注入</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// React.createContext：创建一个上下文的容器(组件), defaultValue可以设置共享的默认数据
const {Provider, Consumer} = React.createContext(defaultValue);
// Provider(生产者): 用于生产共享数据的地方。value:放置共享的数据
&lt;Provider value={/*共享的数据*/}&gt;
    /*里面可以渲染对应的内容*/
&lt;/Provider&gt;
// Consumer(消费者): 消费供应商(Provider 上面提到的)产生数据。Consumer需要嵌套在生产者下面。才能通过回调的方式拿到共享的数据源。当然也可以单独使用，那就只能消费到上文提到的defaultValue
&lt;Consumer&gt;
  {value =&gt; /*根据上下文  进行渲染相应内容*/}
&lt;/Consumer&gt;
" data-status="copy"></button><div class="token-line"><span class="token comment">// React.createContext：创建一个上下文的容器(组件), defaultValue可以设置共享的默认数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token maybe-class-name">Provider</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Consumer</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createContext</span><span class="token punctuation">(</span><span class="token plain">defaultValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Provider(生产者): 用于生产共享数据的地方。value:放置共享的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> value</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">/*共享的数据*/</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">/*里面可以渲染对应的内容*/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">Provider</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Consumer(消费者): 消费供应商(Provider 上面提到的)产生数据。Consumer需要嵌套在生产者下面。才能通过回调的方式拿到共享的数据源。当然也可以单独使用，那就只能消费到上文提到的defaultValue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token maybe-class-name">Consumer</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token comment">/*根据上下文  进行渲染相应内容*/</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">Consumer</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="hooks"><a aria-hidden="true" href="#hooks"><span class="icon icon-link"></span></a>Hooks</h2><p><code>React</code> 中通常使用 <strong>类定义</strong> 或者 <strong>函数定义</strong> 创建组件:</p><p>在类定义中，我们可以使用到许多 <code>React</code> 特性，例如 <code>state</code>、 各种组件生命周期钩子等，但是在函数定义中，我们却无能为力，因此 <code>React 16.8</code> 版本推出了一个新功能 (<code>React Hooks)</code>，通过它，可以更好的在函数定义组件中使用 <code>React</code> 特性。</p><h3 id="优缺点"><a aria-hidden="true" href="#优缺点"><span class="icon icon-link"></span></a>优缺点</h3><ol><li><strong>跨组件复用</strong>: 其实 <code>render props</code> / <code>HOC</code> 也是为了复用，相比于它们，<code>Hooks</code> 作为官方的底层 <code>API</code>，最为轻量，而且改造成本小，不会影响原来的组件层次结构和传说中的嵌套地狱；</li><li><strong>类定义更为复杂</strong>:</li></ol><ul><li>不同的生命周期会使逻辑变得分散且混乱，不易维护和管理；</li><li>时刻需要关注<code>this</code>的指向问题；</li><li>代码复用代价高，高阶组件的使用经常会使整个组件树变得臃肿；</li></ul><ol start="3"><li><strong>状态与 UI 隔离</strong>: 正是由于 Hooks 的特性，状态逻辑会变成更小的粒度，并且极容易被抽象成一个自定义 Hooks，组件中的状态和 UI 变得更为清晰和隔离。</li><li><strong>代码清爽量少</strong>: 函数式编程风格，函数式组件、状态保存在运行环境、每个功能都包裹在函数中，整体风格更清爽，更优雅</li></ol><h3 id="注意事项"><a aria-hidden="true" href="#注意事项"><span class="icon icon-link"></span></a>注意事项</h3><ul><li>避免在 循环/条件判断/嵌套函数 中调用 hooks，保证调用顺序的稳定；</li><li>只有 函数定义组件 和 hooks 可以调用 hooks，避免在 类组件 或者 普通函数 中调用；</li><li>不能在<code>useEffect</code>中使用<code>useState</code>，React 会报错提示；</li><li>类组件不会被替换或废弃，不需要强制改造类组件，两种方式能并存；</li></ul><h3 id="状态钩子usestate"><a aria-hidden="true" href="#状态钩子usestate"><span class="icon icon-link"></span></a>状态钩子(<code>useState</code>)</h3><p>用于定义组件的 State，其到类定义中<code>this.state</code>的功能；</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// useState 只接受一个参数: 初始状态
// 返回的是组件名和更改该组件对应的函数
const [flag, setFlag] = useState(true);
// 修改状态
setFlag(false);

// 上面的代码映射到类定义中:
this.state = {
  flag: true,
};
const flag = this.state.flag;
const setFlag = (bool) =&gt; {
  this.setState({
    flag: bool,
  });
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// useState 只接受一个参数: 初始状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 返回的是组件名和更改该组件对应的函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">flag</span><span class="token punctuation">,</span><span class="token plain"> setFlag</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 修改状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 上面的代码映射到类定义中:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  flag</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> flag </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">flag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">setFlag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">bool</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    flag</span><span class="token punctuation">:</span><span class="token plain"> bool</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="生命周期钩子useeffect"><a aria-hidden="true" href="#生命周期钩子useeffect"><span class="icon icon-link"></span></a>生命周期钩子(<code>useEffect</code>)</h3><p>类定义中有许多生命周期函数，而在 React Hooks 中也提供了一个相应的函数 (<code>useEffect</code>)，这里可以看做<code>componentDidMount</code>、<code>componentDidUpdate</code>和<code>componentWillUnmount</code>的结合。</p><ul><li><code>useEffect(callback, [source])</code>接受两个参数<ul><li><code>callback</code>: 钩子回调函数；</li><li><code>source</code>: 设置触发条件，仅当 source 发生改变时才会触发；</li><li><code>useEffect</code>钩子在没有传入<code>[source]</code>参数时，默认在每次 render 时都会优先调用上次保存的回调中返回的函数，后再重新调用回调；</li></ul></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="useEffect(() =&gt; {
  // 组件挂载后执行事件绑定
  console.log(&quot;on&quot;);
  addEventListener();

  // 组件 update 时会执行事件解绑
  return () =&gt; {
    console.log(&quot;off&quot;);
    removeEventListener();
  };
}, [source]);

// 每次 source 发生改变时，执行结果(以类定义的生命周期，便于大家理解):
// --- DidMount ---
// &#x27;on&#x27;
// --- DidUpdate ---
// &#x27;off&#x27;
// &#x27;on&#x27;
// --- DidUpdate ---
// &#x27;off&#x27;
// &#x27;on&#x27;
// --- WillUnmount ---
// &#x27;off&#x27;
" data-status="copy"></button><div class="token-line"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件挂载后执行事件绑定</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 组件 update 时会执行事件解绑</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;off&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">source</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 每次 source 发生改变时，执行结果(以类定义的生命周期，便于大家理解):</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// --- DidMount ---</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;on&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// --- DidUpdate ---</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;off&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;on&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// --- DidUpdate ---</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;off&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;on&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// --- WillUnmount ---</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// &#x27;off&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p>通过第二个参数，我们便可模拟出几个常用的生命周期:</p><ul><li><code>componentDidMount</code>: 传入<code>[]</code>时，就只会在初始化时调用一次；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const useMount = (fn) =&gt; useEffect(fn, []);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">useMount</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token plain">fn</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>componentWillUnmount</code>: 传入<code>[]</code>，回调中的返回的函数也只会被最终执行一次；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const useUnmount = (fn) =&gt; useEffect(() =&gt; fn, []);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">useUnmount</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> fn</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>mounted</code>: 可以使用 useState 封装成一个高度可复用的 mounted 状态；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const useMounted = () =&gt; {
  const [mounted, setMounted] = useState(false);
  useEffect(() =&gt; {
    !mounted &amp;&amp; setMounted(true);
    return () =&gt; setMounted(false);
  }, []);
  return mounted;
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">useMounted</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">mounted</span><span class="token punctuation">,</span><span class="token plain"> setMounted</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">!</span><span class="token plain">mounted </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">setMounted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">setMounted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> mounted</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>componentDidUpdate</code>: <code>useEffect</code>每次均会执行，其实就是排除了 DidMount 后即可；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const mounted = useMounted();
useEffect(() =&gt; {
  mounted &amp;&amp; fn();
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> mounted </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useMounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  mounted </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li></ul><h3 id="其它内置钩子"><a aria-hidden="true" href="#其它内置钩子"><span class="icon icon-link"></span></a>其它内置钩子</h3><ul><li><code>useContext</code>: 获取 context 对象</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import React, { useContext } from &quot;react&quot;;

const colorContext = React.createContext(&quot;gray&quot;);
function Bar() {
  const color = useContext(colorContext);
  return &lt;div&gt;{color}&lt;/div&gt;;
}
function Foo() {
  return &lt;Bar /&gt;;
}
function App() {
  return (
    &lt;colorContext.Provider value={&quot;red&quot;} /&gt;
      &lt;Foo /&gt;
    &lt;/colorContext.Provider&gt;
  );
}
" data-status="copy"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useContext </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> colorContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createContext</span><span class="token punctuation">(</span><span class="token string">&quot;gray&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> color </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useContext</span><span class="token punctuation">(</span><span class="token plain">colorContext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token plain">color</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Bar</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">colorContext</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Provider</span><span class="token plain"> value</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Foo</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">colorContext</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Provider</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p><code>useReducer</code>: 类似于 Redux 思想的实现，但其并不足以替代 Redux，可以理解成一个组件内部的 redux:</p><ul><li>并不是持久化存储，会随着组件被销毁而销毁；</li><li>属于组件内部，各个组件是相互隔离的，单纯用它并无法共享数据；</li><li>配合<code>useContext</code>的全局性，可以完成一个轻量级的 Redux；(<a href="https://github.com/ctrlplusb/easy-peasy" target="_blank" rel="noopener noreferrer">easy-peasy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li></ul></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const initialState = {count: 0};

function reducer(state, action) {
  switch (action.type) {
    case &#x27;increment&#x27;:
      return {count: state.count + 1};
    case &#x27;decrement&#x27;:
      return {count: state.count - 1};
    default:
      throw new Error();
  }
}

function Counter() {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    &lt;&gt;
      Count: {state.count}
      &lt;button onClick={() =&gt; dispatch({type: &#x27;decrement&#x27;})}&gt;-&lt;/button&gt;
      &lt;button onClick={() =&gt; dispatch({type: &#x27;increment&#x27;})}&gt;+&lt;/button&gt;
    &lt;/&gt;
  );
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> initialState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token parameter punctuation">,</span><span class="token parameter"> action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">action</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;increment&#x27;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">:</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;decrement&#x27;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">:</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword module">default</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token plain">reducer</span><span class="token punctuation">,</span><span class="token plain"> initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token maybe-class-name">Count</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">button onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain">type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;decrement&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">-</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">button onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain">type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;increment&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>useCallback</code>: 缓存回调函数，避免传入的回调每次都是新的函数实例而导致依赖组件重新渲染，具有性能优化的效果；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const memoizedCallback = useCallback(
  () =&gt; {
    doSomething(a, b);
  },
  [a, b],
);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> memoizedCallback </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">[</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>useMemo</code>: 用于缓存传入的 props，避免依赖的组件每次都重新渲染；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const memoizedValue = useMemo(() =&gt; computeExpensiveValue(a, b), [a, b]);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> memoizedValue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">computeExpensiveValue</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>useRef</code>: 获取组件的真实节点；</li><li><code>useLayoutEffect</code>:<ul><li>DOM 更新同步钩子。用法与<code>useEffect</code>类似，只是区别于执行时间点的不同。</li><li><code>useEffect</code>属于异步执行，并不会等待 DOM 真正渲染后执行，而<code>useLayoutEffect</code>则会真正渲染后才触发；</li><li>可以获取更新后的 state；</li></ul></li></ul><h3 id="自定义钩子usexxxxx"><a aria-hidden="true" href="#自定义钩子usexxxxx"><span class="icon icon-link"></span></a>自定义钩子(<code>useXxxxx</code>)</h3><p>基于 Hooks 可以引用其它 Hooks 这个特性，我们可以编写自定义钩子，如上面的<code>useMounted</code>。又例如，我们需要每个页面自定义标题:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function useTitle(title) {
  useEffect(() =&gt; {
    document.title = title;
  });
}

// 使用:
function Home() {
  const title = &quot;我是首页&quot;;
  useTitle(title);

  return &lt;div&gt;{title}&lt;/div&gt;;
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useTitle</span><span class="token punctuation">(</span><span class="token parameter">title</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> title</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 使用:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> title </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;我是首页&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">useTitle</span><span class="token punctuation">(</span><span class="token plain">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token plain">title</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="模仿hooks"><a aria-hidden="true" href="#模仿hooks"><span class="icon icon-link"></span></a>模仿Hooks</h3></div><div class="__dumi-default-previewer "><div class="__dumi-default-previewer-demo"><div>0</div><div>10</div><div>获取状态</div></div><div class="__dumi-default-previewer-desc"></div><div class="__dumi-default-previewer-actions"><form style="display:flex" method="POST" action="https://codesandbox.io/api/v1/sandboxes/define?query=module=/demo.jsx" target="_blank"><button class="__dumi-default-icon" role="codesandbox" type="submit"></button><input type="hidden" value="" name="parameters"/></form><a target="_blank" rel="noopener noreferrer" href="/_demos/imitate-hooks"><button class="__dumi-default-icon" role="open-demo" type="button"></button></a><span></span><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy " data-status="copy"></button><button class="__dumi-default-icon" role="source" type="button"></button></div></div><div class="markdown"><h3 id="hooks-实现-redux"><a aria-hidden="true" href="#hooks-实现-redux"><span class="icon icon-link"></span></a>Hooks 实现 Redux</h3><h2 id="ssr"><a aria-hidden="true" href="#ssr"><span class="icon icon-link"></span></a>SSR</h2><p>SSR，俗称 <strong>服务端渲染</strong> (Server Side Render)，讲人话就是: 直接在服务端层获取数据，渲染出完成的 HTML 文件，直接返回给用户浏览器访问。</p><ul><li><p><strong>前后端分离</strong>: 前端与服务端隔离，前端动态获取数据，渲染页面。</p></li><li><p><strong>痛点</strong>:</p><ul><li><p><strong>首屏渲染性能瓶颈</strong>:</p><ul><li>空白延迟: HTML 下载时间 + JS 下载/执行时间 + 请求时间 + 渲染时间。在这段时间内，页面处于空白的状态。</li></ul></li><li><p><strong>SEO 问题</strong>: 由于页面初始状态为空，因此爬虫无法获取页面中任何有效数据，因此对搜索引擎不友好。</p><ul><li>虽然一直有在提动态渲染爬虫的技术，不过据我了解，大部分国内搜索引擎仍然是没有实现。</li></ul></li></ul></li></ul><p>最初的服务端渲染，便没有这些问题。但我们不能返璞归真，既要保证现有的前端独立的开发模式，又要由服务端渲染，因此我们使用 React SSR。</p><ul><li><p><strong>原理</strong>:</p><ul><li>Node 服务: 让前后端运行同一套代码成为可能。</li><li>Virtual Dom: 让前端代码脱离浏览器运行。</li></ul></li><li><p><strong>条件</strong>: Node 中间层、 React / Vue 等框架。 结构大概如下:</p></li></ul><img width="600" src="https://raw.githubusercontent.com/xd-tayde/blog/master/images/interview/9.png"/><ul><li><p><strong>开发流程</strong>: (此处以 React + Router + Redux + Koa 为例)</p><ul><li><p>1、在同个项目中，<strong>搭建</strong> 前后端部分，常规结构:</p><ul><li><p>build</p></li><li><p>public</p></li><li><p>src</p><ul><li>client</li><li>server</li></ul></li></ul></li><li><p>2、server 中使用 Koa <strong>路由监听</strong> 页面访问:</p></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import * as Router from &quot;koa-router&quot;;

const router = new Router();
// 如果中间也提供 Api 层
router.use(&quot;/api/home&quot;, async () =&gt; {
  // 返回数据
});

router.get(&quot;*&quot;, async (ctx) =&gt; {
  // 返回 HTML
});
" data-status="copy"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword module">as</span><span class="token plain"> </span><span class="token maybe-class-name">Router</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> router </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果中间也提供 Api 层</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">&quot;/api/home&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回 HTML</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>3、通过访问 url <strong>匹配</strong> 前端页面路由:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 前端页面路由
import { pages } from &quot;../../client/app&quot;;
import { matchPath } from &quot;react-router-dom&quot;;

// 使用 react-router 库提供的一个匹配方法
const matchPage = matchPath(ctx.req.url, page);
" data-status="copy"></button><div class="token-line"><span class="token comment">// 前端页面路由</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> pages </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;../../client/app&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> matchPath </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 使用 react-router 库提供的一个匹配方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> matchPage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">matchPath</span><span class="token punctuation">(</span><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">req</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">,</span><span class="token plain"> page</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p>4、通过页面路由的配置进行 <strong>数据获取</strong>。通常可以在页面路由中增加 SSR 相关的静态配置，用于抽象逻辑，可以保证服务端逻辑的通用性，如:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class HomePage extends React.Component{
  public static ssrConfig = {
      cache: true,
         fetch() {
            // 请求获取数据
         }
    }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">HomePage</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">public</span><span class="token plain"> </span><span class="token keyword">static</span><span class="token plain"> ssrConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      cache</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">         </span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 请求获取数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">         </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>获取数据通常有两种情况:</p><ul><li>中间层也使用 <strong>http</strong> 获取数据，则此时 fetch 方法可前后端共享；</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const data = await matchPage.ssrConfig.fetch();
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> matchPage</span><span class="token punctuation">.</span><span class="token property-access">ssrConfig</span><span class="token punctuation">.</span><span class="token method function property-access">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>中间层并不使用 http，是通过一些 <strong>内部调用</strong>，例如 Rpc 或 直接读数据库 等，此时也可以直接由服务端调用对应的方法获取数据。通常，这里需要在 ssrConfig 中配置特异性的信息，用于匹配对应的数据获取方法。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 页面路由
class HomePage extends React.Component{
  public static ssrConfig = {
        fetch: {
           url: &#x27;/api/home&#x27;,
        }
    }
}

// 根据规则匹配出对应的数据获取方法
// 这里的规则可以自由，只要能匹配出正确的方法即可
const controller = matchController(ssrConfig.fetch.url)

// 获取数据
const data = await controller(ctx)
" data-status="copy"></button><div class="token-line"><span class="token comment">// 页面路由</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">HomePage</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">public</span><span class="token plain"> </span><span class="token keyword">static</span><span class="token plain"> ssrConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        fetch</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">           url</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;/api/home&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 根据规则匹配出对应的数据获取方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 这里的规则可以自由，只要能匹配出正确的方法即可</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> controller </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">matchController</span><span class="token punctuation">(</span><span class="token plain">ssrConfig</span><span class="token punctuation">.</span><span class="token property-access">fetch</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">controller</span><span class="token punctuation">(</span><span class="token plain">ctx</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li><li><p>5、创建 Redux store，并将数据<code>dispatch</code>到里面:</p></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import { createStore } from &quot;redux&quot;;
// 获取 Clinet层 reducer
// 必须复用前端层的逻辑，才能保证一致性；
import { reducers } from &quot;../../client/store&quot;;

// 创建 store
const store = createStore(reducers);

// 获取配置好的 Action
const action = ssrConfig.action;

// 存储数据
store.dispatch(createAction(action)(data));
" data-status="copy"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> createStore </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取 Clinet层 reducer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 必须复用前端层的逻辑，才能保证一致性；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> reducers </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;../../client/store&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 创建 store</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> store </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createStore</span><span class="token punctuation">(</span><span class="token plain">reducers</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取配置好的 Action</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> ssrConfig</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 存储数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">store</span><span class="token punctuation">.</span><span class="token method function property-access">dispatch</span><span class="token punctuation">(</span><span class="token function">createAction</span><span class="token punctuation">(</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>6、注入 Store， 调用<code>renderToString</code>将 React Virtual Dom 渲染成 <strong>字符串</strong>:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import * as ReactDOMServer from &quot;react-dom/server&quot;;
import { Provider } from &quot;react-redux&quot;;

// 获取 Clinet 层根组件
import { App } from &quot;../../client/app&quot;;

const AppString = ReactDOMServer.renderToString(
  &lt;Provider store={store}&gt;
    &lt;StaticRouter location={ctx.req.url} context={{}}&gt;
      &lt;App /&gt;
    &lt;/StaticRouter&gt;
  &lt;/Provider&gt;
);
" data-status="copy"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword module">as</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMServer</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">Provider</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取 Clinet 层根组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;../../client/app&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">AppString</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMServer</span><span class="token punctuation">.</span><span class="token method function property-access">renderToString</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">store</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token maybe-class-name">StaticRouter</span><span class="token plain"> </span><span class="token dom variable">location</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">req</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">}</span><span class="token plain"> context</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">StaticRouter</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">Provider</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p>7、将 AppString 包装成完整的 html 文件格式；</p></li><li><p>8、此时，已经能生成完整的 HTML 文件。但只是个纯静态的页面，没有样式没有交互。接下来我们就是要插入 JS 与 CSS。我们可以通过访问前端打包后生成的<code>asset-manifest.json</code>文件来获取相应的文件路径，并同样注入到 Html 中引用。</p></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const html = `
  
  &lt;html lang=&quot;zh&quot;&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;link href=&quot;${cssPath}&quot; rel=&quot;stylesheet&quot; /&gt;
    &lt;body&gt;
      &lt;div id=&quot;App&quot;&gt;${AppString}&lt;/div&gt;
      &lt;script src=&quot;${scriptPath}&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
`;
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> html </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">  </span></div><div class="token-line"><span class="token template-string string">  &lt;html lang=&quot;zh&quot;&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;head&gt;&lt;/head&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;link href=&quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">cssPath</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot; rel=&quot;stylesheet&quot; /&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;body&gt;</span></div><div class="token-line"><span class="token template-string string">      &lt;div id=&quot;App&quot;&gt;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">AppString</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&lt;/div&gt;</span></div><div class="token-line"><span class="token template-string string">      &lt;script src=&quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">scriptPath</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot;&gt;&lt;/script&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;/body&gt;</span></div><div class="token-line"><span class="token template-string string">  &lt;/html&gt;</span></div><div class="token-line"><span class="token template-string string"></span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>9、进行 <strong>数据脱水</strong>: 为了把服务端获取的数据同步到前端。主要是将数据序列化后，插入到 html 中，返回给前端。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import serialize from &quot;serialize-javascript&quot;;
// 获取数据
const initState = store.getState();
const html = `
  &lt;!DOCTYPE html&gt;
  &lt;html lang=&quot;zh&quot;&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;App&quot;&gt;&lt;/div&gt;
      &lt;script type=&quot;application/json&quot; id=&quot;SSR_HYDRATED_DATA&quot;&gt;${serialize(
        initState
      )}&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
`;

ctx.status = 200;
ctx.body = html;
" data-status="copy"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> serialize </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;serialize-javascript&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> initState </span><span class="token operator">=</span><span class="token plain"> store</span><span class="token punctuation">.</span><span class="token method function property-access">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> html </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">  &lt;!DOCTYPE html&gt;</span></div><div class="token-line"><span class="token template-string string">  &lt;html lang=&quot;zh&quot;&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;head&gt;&lt;/head&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;body&gt;</span></div><div class="token-line"><span class="token template-string string">      &lt;div id=&quot;App&quot;&gt;&lt;/div&gt;</span></div><div class="token-line"><span class="token template-string string">      &lt;script type=&quot;application/json&quot; id=&quot;SSR_HYDRATED_DATA&quot;&gt;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation function">serialize</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation"></span></div><div class="token-line"><span class="token template-string interpolation">        initState</span></div><div class="token-line"><span class="token template-string interpolation">      </span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&lt;/script&gt;</span></div><div class="token-line"><span class="token template-string string">    &lt;/body&gt;</span></div><div class="token-line"><span class="token template-string string">  &lt;/html&gt;</span></div><div class="token-line"><span class="token template-string string"></span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><blockquote><p><strong>Tips</strong>:</p><p>这里比较特别的有两点:</p><ol><li><p>使用了<code>serialize-javascript</code>序列化 store， 替代了<code>JSON.stringify</code>，保证数据的安全性，避免代码注入和 XSS 攻击；</p></li><li><p>使用 json 进行传输，可以获得更快的加载速度；</p></li></ol></blockquote><ul><li>10、Client 层 <strong>数据吸水</strong>: 初始化 store 时，以脱水后的数据为初始化数据，同步创建 store。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const hydratedEl = document.getElementById(&quot;SSR_HYDRATED_DATA&quot;);
const hydrateData = JSON.parse(hydratedEl.textContent);

// 使用初始 state 创建 Redux store
const store = createStore(reducer, hydrateData);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> hydratedEl </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;SSR_HYDRATED_DATA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> hydrateData </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token plain">hydratedEl</span><span class="token punctuation">.</span><span class="token property-access">textContent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 使用初始 state 创建 Redux store</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> store </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createStore</span><span class="token punctuation">(</span><span class="token plain">reducer</span><span class="token punctuation">,</span><span class="token plain"> hydrateData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li></ul><h2 id="react-router"><a aria-hidden="true" href="#react-router"><span class="icon icon-link"></span></a>React-Router</h2><h3 id="history"><a aria-hidden="true" href="#history"><span class="icon icon-link"></span></a>History</h3><blockquote><p>history是一个独立的第三方js库，可以用来兼容在不同浏览器、不同环境下对历史记录的管理，拥有统一的API。具体来说里面的history分为三类</p></blockquote><ul><li>老浏览器的history: 主要通过hash来实现，对应createHashHistory</li><li>高版本浏览器: 通过html5里面的history，对应createBrowserHistory</li><li>node环境下: 主要存储在memeory里面，对应createMemoryHistory</li></ul><h3 id="基本原理"><a aria-hidden="true" href="#基本原理"><span class="icon icon-link"></span></a>基本原理</h3><blockquote><p>实现URL与UI界面的同步。其中在react-router中，URL对应Location对象，而UI是由react components来决定的，这样就转变成location与components之间的同步问题</p></blockquote><p><img src="data:image/webp;base64,UklGRsoVAABXRUJQVlA4IL4VAACQjQCdASpuAlUBPpFAnEwloyMiITCKwLASCWlu/HyZbVRnZ15fpt/bP6b+tXg5/ffEfxceOvZn1zcq9pn8l+wH5T+z/tp8hP3f/M/znxT/G/u89QL8e/kf96/r/5D+dV2wYAfyP+Y/5v+9f4T/y/3v0K/1T81vcv63/6D7ZvsA/V3/JfnHzPvo3sA/yT+u/5X+4/lZ9L/8p/3P9T+YftW/OP81/6P9B8BX84/qP/H/wP+Y92j//+3n9mP//+//ypfr7/+R6rjqQAIi1cdSABEWrjqQAIi1cdSABEWrjqQAIi1cdSABEWrjqQAIi1bYDpBxxxk7fKxm86D2TfABEMPeOuuus1I2jqJycVA2Gxdddc47kLHH/Usm+ACItXHURtqVKI24fRddddL3Vps+yFXhpFC2yPtCba12jVygynMYdk2OeeeedyicGzclt4Gz3/////9uUfzyxxFOmDUw3xCFJszAI2FLhjOQCA5AXsOcBrDcTSD4aCVqCC76oo8kkkj+dbihDOexq48HjeNq29999999IwK66ZeVNk41ih7Afevdjcn7Xx0dNfHUV2QzZS1oTZDeD2TfABEWKD2pj3Tme40DA/56E63fsblkQsdqqqqqJ2jeYa9WM241XxyMWDJE+tZrgjhxPddddTGfySB7JvBycKokexqvB7Hx9rw3/C+G2mGFTqq5OpuZAHjdMl6aGM3nFp5pDoLsKkACItT4+QT2TeIdRfdm2CACjo3/2h7i4wWHUf+D/jlnnQesfFp7JveiAZcNG5J4416oWL/ucTdZapcqzigv37EiLP4ZVNE9fUctBOBKc4zzoB8T8q8HsmomvjqQADd0RX/0UVQPWGoPObAj97MZeKCIFiM1FeMtScaN6aL+9DyFI7XiWeVdLGq8HsecsoklY+N1BDboiLUqlqTnZfBDgX7cUDIeqhWvjPOfsZl80IFjYxD+VjNv1cEVhNg36eHS5YWZIrt6MpWM29FqTkkhh2cv5MamXmhpPpQUPJOGZzQV46kAAi0WR/yZ55Tu6L01R206J6lQxm8kh8aEHKZ4yGbGCgPaxEWrjN4wLnGssJWM3nGO526E4ATW03f9yJZs5PZTouR7ykPIPpZ6u4FCec0mfysbJTtq46iNtRPouR7ykXj7AwwMtyFA5U7niFsQQgyQ5pUfzO+0auUGWlEfU34ExBBBA/l/CWUnPAVNxpVVVVVQRNyR1a2NDBEq2pjV+YXBQ61q4VmQCwpbjgxAmsCVX3QI49czRY+FLJg9/oZIMju4U0p2cNHkmmmmmHERHSLdxf47Sz9mbpFoQQQQPhNh+f7iP4jBaa3Zv/PayOooC8gQLxE6JAV4ThHswBfOl6AKBv4U8VN473/Biq3GfYNNoPZN8AERamloP1DlIawLyDfGP2pT38mYqKCkLeZDWGNWm8xzzoPZN8AERauMftSnv5MxUUFIW8xUOjjzE+zyZ50Hsm+ACItXHUgARFq46kACItXHUgARFq46kACItXHUgARFq46kACCgAP7/diAABo5/PTqtcWtnFW1bQ+OAtzOBuxT08oB5DL85uKVjpbdwHcKXh2efZ5uTukIqXfyfP1vxS3i4MOzX3VckghtfPecKEBWk3Qw8OxENxmILGWhbpmEBAtcMJm7/IXZP5N7ybWb8jf0gbApZUU9EJNeHZ59nm5O6Qipd/J8/W/FLeLgw7NfdVySLrDExvLLU/abKtdESnGEjNWU0GbRX5yOSnXyLjfXVTxU9ltBAHWP4IPEYrQbz/rY920gNEy8ODEzNP4PA8ZduVChT1c1FoDAxl3I5eherHYKDCQb9kU/2E+MTijfvyhvPfVOhvgDF3TN/Qd8GMGgUiNBCWWeZA0N3vd/ifJ9NSJghfbDVBV8AYI5PDRMz70Tg9a8Lk19yuwIbeG0LA1f/rT9LpO67gxv4+0fpG/KLe7/pZT+MELJBrL1yceXPPWhqka8tXK/yoyJVeN+Keh+b+FfuaSGZk40MMawvULeBKIqE9Fskctd6cJTypazfCw3xwncHkRxxBWPPKF09xCR9ajj1Cs6k86KspmaVBn6ZZWAiq+MfLRlVvEAt5nIdvrJDndzkOAO8WCxR2wtJGwf2UakUlGGM7elQ7XyMvYtjfFEtm5y/orNP3RQsm/o0rKRRm2n2quPmO01+Ssn4eJA/RR+oXuJeTdvSJLzok341V61Fr+tHQpvp//CWcqxkUSJvAnx54ahBf6GjIS2+m4WDJ+NlR1PDIgQAHfljqDBPdBGPURhOx1n/0lRXmsELOVPF2g34HGkUXqcaxH8QCkufb7ya/mPFeLLKWp4bzqu5Uilq8ktqD2rCnCUYP4SSJff4Tr4kCjpqw9xTIdyu5GcH74TfhoDNB3ueVhsjbvzR9h0NlruIFt5wxBwKO2E50/AAA6r6k6ha+yl5elJb3cLkwOn8skU+iYhFyyPNzQgQ6toxhLpugeyTCn3+QcVB0rEtxzs48wtmWeLNHIRisp/qfxU5uM4dnrVGnflSt+mvGz8/OPCKOYV3hXCRSMu715PBe83euVvCkVNpBJPhXN7IY9H1FPJHFxiKrWIOj0GiVKMmwIr43DwP1z3IL1Pm8W1T8nB2y7vjKwBOw5n0tQteW4hJduWk8hL2zZ5jcyxC16uaqOZQlSV9ZBCw75DLn5ocTRkZUrcEO4Th0nukCVcCE+fCg4HP3sbbeC1kvnjsBdZDRwa7BGG9z1XLptD06BzxVdcSy1Qes9GpR9SUb21twY8sNuY36u/qE1NnNVC+SHO+gaANEOsjTornmd1HPrieQfGkj6QkatDj9mErCNLcnT0TmeXUCqbtJ0Mjr4uxmABx2K/IrzA82OKYWutOZoYRA/7HAY+ZD6cX/U2lv+tQ9Y1v1aukMrCoyLkj0ozASXzlW9bmZTX9U4p9pFjPOzu4CHllbHIeRjCe5ShmMLUVa/qIw2ZtI5qccCT3FwU6uTfq4Ljrr8GsP5fkzsowHEi+cYEJit0e4ehBaK1jx3+G9Q6HJlsJY1swU22oaPV3TIZLfev/HxlIJi15BW10CPwcCiDh+lz8jiwl/UPYUiZV+z98o1NRwmXZt1ELoAnQZyoNdv2ClFuwizi61+6sCOuJEgM8z8J5c2Ye+VI18jIbAKbLzSPsmBVHy2aAh27gbFNDY1NzYeUPhV3k5mfzaotanhUEV9jeOpUEimfYjKSj0J2aoXTXeQXV9neLln3ao0HVhSv7q3cWXe6SZx1Liwv+81+Arx/EwAkM3W0ZM0QSz/DPRcKWe5IjpJByBaNRG67cosqzeRyxa2I/EWdNUaZPt4tvvS/sDjtJXmQdQsLjAhU10RfvTfPMFDugYWQ4S7DFo6YHvE5uukW80PXRziktJRJR70un+68LStGGop+xXJ2Cf3MdoLW2N8yetJTuru9UhIADckpG0CIVc8uGrXcgS38NjkF+1v5lpxYHw5VcD/vTO39XFll3+booLNoNH/zQv1ZC/47wJRiXARkpzazAfVyu1fw/m4GnKA0EK5Xo6OxJ2nK1NJ43tw9gYPkA78el2mMqAJ5cp9RS49/AHAY4dAa3BgSCi3Zxhhq5DO/25EoZyxQz88H77iszLtR8Hk9YHkoqyydNy9Q95NWRXXRKnh61Dlw6f3swufi12DPn+GfiyxKx9td4FZ+bOX5q0sgUn//Vis1e2pcYz3tGhO4BtEkgfcujwRBNqgYDmWwQErkvgr8uYLLg8pODL2K78rDZqGCbhd7tn658me2BIbZSJyNPBByIeyWfowBc9hkrXT6G1OjNH1wHHsmDbTTqu94SZpwmXBjnXwT7uPLxaLZ//mmIKJeDvRr8ENwuSDDy6GtLziR+0LuQBnSoEC+JJb9AuLoz3ZWcfMeuOqSK+fohganxj08kYBfsgl3PmUW/p/C8Yx7RCW4DY4zjO10x7SEQfPsPnXcsS11hn8F6K9jy3rqlULwmamiDEb/Bv2b1FfmsJB+vCaXlCo/lzhFezm186CnsvCj4v8FGCGlxE3idbYD8LCrOBG/K0pFhjqguRGDO8BQeWaCNkSN5MABgDTS7ichGSTWqOrpSV0vd4J37y6/ofY8pCwCJp/XaA47jADyRvek+afH40QAzPZ4kx7MnOnhML12HYTknujNV8HBVEVkzaLbUZ9MEhdeMnVGhik8pyKhvv97EbAflD9oEN4D0ZMHE8CMJH1/E6fm/NtNk1hirNxC9Bnp9DmEAQT/ZWaIpNHcfPn833rZYzrJ/471LK39iW6DMNhvdY2D5SPBHuhZ/vhZcsqFnHUbAI56yDRORqm7K0qQMLwM2SS0jrGHtWWmwcZdW/cOx3m6++NvzFawVb3aX/Hoxp7NW50rYtCgQZGQMknA6WTj6nh4XGe8PFYeucSfol03VBfr5AL6vLFVz3C4E7VMoq3GBcDtTqgJ5ng3hxTAh5XP0yKf//A07GE21+ze34dFhCgQbEWQLQ+wWRHbkp6ztNcsmOB7tcyFZY1d2kGWUaBmMpdUpwwDclYhA5d5cFhmUTObnj7rPCs0uCYskEKsn2hzEEsh3ZV242uLZzkm7iBO6hanUTNgZ0LSOqbPhU+qldhiVsPOTUxQ7azfM1/eczoo6JFPq4MVWt2FLPw9w1nqvgyBDoe7IoxB/a6Xqu4+ma4d8VFKXTKnDD7SPR2Plz+sNW4CifggqmvPZmk0FstcTxU5WMUf+5rVsf/Odsi3nGLUshFsmaQgMUHmVFRatNTrERdMxYDEPqdatNTGBesqWb9WuSb1wciVFx0W1r5X+Suim4QbXNdtnnEUg67kN9gjHWmNXQRUqvXCh63sb6GZFaZejIw7f9ptP3ESrEZ9fBWmDXMBl+E4AtcvW4vKVA4ATmEkE+fWOpEY4Rz3PEunezPD2P8QalUTvtYpu73I8CGXtjltBtYnWCtPyfSUwoQFoNL39y4nKL7g21Z5oNU0TTRIbhF/2eYm+1dwLGT70uM1x0qGdoNLd7r5pAa5RQqvR+KR0/E2SBPYkPxs+ZUji6tontu/FntxOMhD4hv98LtVqfQazzjDr88UqWt4rLPzwJZslJ8G9uQUWzHYMlNnu4dELynK6dRpYjsP6XtTmy7Y05SRb4EMmMMhOkKqdNk0MReAhV2LEX2yq1ShBl6pCeBl0RuRVCGVsgq+Oz8cylP0EyKmexpArYRb9w+74tSohniLf5+c7YkzXgC8dWOZn+sDdEtZ6CEhNZKI7pbhVbeTKyH+2GKq7U99dRD/rS/eVxZAvXAZO95CfrY4NmR1lfUBLkDHJI4cHBhppmaK60Y77quZAGUca9lrjlRGZpABY/6iEbr4WtitgY0of8aHvdJcK+QYvMRmce3frVo1/A68WesqYHu9MLHQIQKnXQJV0FVlNRAIMZ2DSWZsVD21/WNBYbZ4a+Pjma5NKKuXDR5MLX/+pRJPTxlfn1OZH/jF+CuUhXfgLZ8QgFP2vJ/qApKZO2pF4EPig0GJaK1OnYqNlvEEEV1k+XARjET+8vpetHxk7r+8lkzjlYKwA0UAIoUfxbK7EtO/ev0ernrRMGOcWA5K0V21NQpJlV5jOWGhd4o7RUvl5zH/NsAb+btkBqLw8gjtMXndZuWE/FCJYBO1kwE78omAoIfsoYEJV9hMQBulHOKiOEPQqAn4OAhq+AzRrgP7U4EjyvLHFe1OWXplkfKQFoQbKoMZ8Zj8wXFhQhRFvPL3HdNkkPWhB00FjOZhWq/o+d5i3+BxEpX0FOLorjxEz6lyNNTOhKowkmnIJsjyKRemUh2AViz7/0vVB+Xm4bK50EApzoiIed6Gwia+UN5UVQ0AiAL+DSBuX/lgrPY8YoJnzXmclgSDJ3sxzfHFbFCW0SlG4cQMYbGZIk2yEEnez2yvwc4ecABn7B5hycdYfiCkfNmEb8BJ1CWjYYCdZdIdkefWfkwvrJiIn5RgsVDNNsGt0Xch3kGFG+XfVcdcJNSgT8dRqMTdMnfNGQPUVwXEEyNpiFelhMkSE/t3Iyz8m5NVY58z8YBqCA/ECQ3EZL0XpjCMnKux3e++JfDtVAQZHgL2Jt35ZxuLJqkiiawHX/9UwMOFs+nNmu76wEL486oNxw+20thqrMdnoguIlI+n2J3d3wm3eggWX36TuAloF8EeYmfN1e1E+JcImj1GmEoVUMSgBTVNpY86uUMJpuhh0ejn6KE5PpLuCqWyZP2btDwomV8pz/pMK74k4glv5bnevJjfLF9wwLON3jP51aof0yCB69Y2443IsLttwUc5NQfZGfAlhRnkZeOVJjhmVZSK0u+/I0gGhrMAWKKTtUkmBh/OnJyti/QGV2CYkjZXPnWye0aFo0c7Yh76eLjtbqm/OKqDTKPVW3RA2n9h6UCKchYQ+zg+RKDWS64poSKZB7Y31JGN+bqUgkY/UzkUOMyk7r7Bz2xfK7qaaksGUr1UCAssgdQ6ETxSWBoPTkjWebU35NXus6mCWNkks01Qd3kANWgUBkQyw2dvRiEjnMMdS52iOa0a8WaXmmR9n9n/pM8qecrykcOlXBz9OHElms3QLo1hLzrUAkn5/g/1F6uRvv+3tGKPqy27wzidDjwcazJaZipKOt9exukv5GhxrpQbZ/a4oBszAIEPj1QEpRgdydCoQ6hp8isuNSvmprmo3FXC05nhqNZ11VKMrUJwAz57Y3se16dNXyhFHztdYR2Q01XQ9CCSq76aWzAuiuaBjB6JX3A5ue4lxEpxa7/i6NGA63415h+1ANvOpF8dMLEGbTXWKR+VXlpJUESAme4xcQk/8HWpvbAXlcsT7TEeGFKkLTEeGE2FXHqrweHkeFokeSDpm6kVTfl1Ka+TJLhIku8Co6i9WdEIxmofWpH126xJzjefrOn9Sbgkq4jA8VYLUxLHuH8Q73sWk7Y8OOwr90RUt256RvD6otgXw+0ESVp5hyE2Xwdcw9irsZv2W8/5EOTz3pY2Ssns/ckbdqGtRYYQB/xSXm4mCPnH8yv8t9cpVLWySXJrJKZwOqveTbXMsz7dr82embCaQA5Vc4zDBiR5s3APMtCpkqkcTBj/qwOHzFpHLj52wojtSXS1dG07GMxc7XjFL688XSuh31WhPsvoetpOayota8apeaEt8pxIoC1xzJS2c57H43URxile0ITImXXtNQlw6fVm9ZbPSzGMngBhiNmIluMXA+sFkHTeNzzUhwr+gynAHec18TcaP7Wsa873YsT02pmU+3YbbW3lgd02oAq/QucoF1ittToQVNjDQihSeuxBXtjgtBWRgpY6PDCcDgmK3Kxh2fcUtuNTAzwGCLtnxHuNWCnOnSZE1B9DnW/hy+dYop+Ckn3aZAC1Dexnq67CCmUEFpXj6mrgiKzebRHTgJnMUBcwii39Yt7bkOeSY81XRCkEwM6S4DaXEsthxUYNDyFTShM2eXx8xevTbLPQAAAAA"/></p><h3 id="具体实现"><a aria-hidden="true" href="#具体实现"><span class="icon icon-link"></span></a>具体实现</h3><blockquote><p>在react-router中最主要的component是Router RouterContext Link，history库起到了中间桥梁的作用 以browserHistory(一种history类型:一个 history 知道如何去监听浏览器地址栏的变化， 并解析这个 URL 转化为 location 对象)为例 : browserHistory进行路由state管理,主要通过sessionStorage</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="//保存　路由state(router state)
function saveState(key, state) {
  ...
  window.sessionStorage.setItem(createKey(key), JSON.stringify(state));
}
//读取路由state
function readState(key) {
  ...
  json = window.sessionStorage.getItem(createKey(key));
  return JSON.parse(json);
}
" data-status="copy"></button><div class="token-line"><span class="token comment">//保存　路由state(router state)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">saveState</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token parameter punctuation">,</span><span class="token parameter"> state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token function">createKey</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">//读取路由state</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">readState</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token spread operator">...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  json </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">.</span><span class="token method function property-access">getItem</span><span class="token punctuation">(</span><span class="token function">createKey</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><img src="/static/react-router-history.990ac9b1.webp"/></p><p>参考：<a href="https://blog.csdn.net/chern1992/article/details/107053381/" target="_blank" rel="noopener noreferrer">从路由原理出发，深入阅读理解react-router 4.0的源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://www.jianshu.com/p/d991a4a55ae1" target="_blank" rel="noopener noreferrer">React Router原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="函数式编程"><a aria-hidden="true" href="#函数式编程"><span class="icon icon-link"></span></a>函数式编程</h2><p>函数式编程是一种 <strong>编程范式</strong>，你可以理解为一种软件架构的思维模式。它有着独立一套理论基础与边界法则，追求的是 <strong>更简洁、可预测、高复用、易测试</strong>。其实在现有的众多知名库中，都蕴含着丰富的函数式编程思想，如 React / Redux 等。</p><ul><li><p><strong>常见的编程范式</strong>:</p><ul><li>命令式编程(过程化编程): 更关心解决问题的步骤，一步步以语言的形式告诉计算机做什么；</li><li>事件驱动编程: 事件订阅与触发，被广泛用于 GUI 的编程设计中；</li><li>面向对象编程: 基于类、对象与方法的设计模式，拥有三个基础概念: 封装性、继承性、多态性；</li><li>函数式编程<ul><li>换成一种更高端的说法，面向数学编程。怕不怕~🥴</li></ul></li></ul></li><li><p><strong>函数式编程的理念</strong>:</p><ul><li><p><strong>纯函数</strong>(确定性函数): 是函数式编程的基础，可以使程序变得灵活，高度可拓展，可维护；</p><ul><li><p><strong>优势</strong>:</p><ul><li>完全独立，与外部解耦；</li><li>高度可复用，在任意上下文，任意时间线上，都可执行并且保证结果稳定；</li><li>可测试性极强；</li></ul></li><li><p><strong>条件</strong>:</p><ul><li>不修改参数；</li><li>不依赖、不修改任何函数外部的数据；</li><li>完全可控，参数一样，返回值一定一样: 例如函数不能包含<code>new Date()</code>或者<code>Math.randon()</code>等这种不可控因素；</li><li>引用透明；</li></ul></li><li><p>我们常用到的许多 API 或者工具函数，它们都具有着纯函数的特点， 如<code>split / join / map</code>；</p></li></ul></li><li><p><strong>函数复合</strong>: 将多个函数进行组合后调用，可以实现将一个个函数单元进行组合，达成最后的目标；</p><ul><li><p><strong>扁平化嵌套</strong>: 首先，我们一定能想到组合函数最简单的操作就是 包裹，因为在 JS 中，函数也可以当做参数:</p><ul><li><code>f(g(k(x)))</code>: 嵌套地狱，可读性低，当函数复杂后，容易让人一脸懵逼；</li><li>理想的做法: <code>xxx(f, g, k)(x)</code></li></ul></li><li><p><strong>结果传递</strong>: 如果想实现上面的方式，那也就是<code>xxx</code>函数要实现的便是: 执行结果在各个函数之间的执行传递；</p><ul><li>这时我们就能想到一个原生提供的数组方法: <code>reduce</code>，它可以按数组的顺序依次执行，传递执行结果；</li><li>所以我们就能够实现一个方法<code>pipe</code>，用于函数组合:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// ...fs: 将函数组合成数组；
// Array.prototype.reduce 进行组合；
// p: 初始参数；
const pipe = (...fs) =&gt; (p) =&gt; fs.reduce((v, f) =&gt; f(v), p);
" data-status="copy"></button><div class="token-line"><span class="token comment">// ...fs: 将函数组合成数组；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Array.prototype.reduce 进行组合；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// p: 初始参数；</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">pipe</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">fs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token parameter punctuation">,</span><span class="token parameter"> f</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">f</span><span class="token punctuation">(</span><span class="token plain">v</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> p</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li><li><p><strong>使用</strong>: 实现一个 驼峰命名 转 中划线命名 的功能:</p></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// &#x27;Guo DongDong&#x27; --&gt; &#x27;guo-dongdong&#x27;
// 函数组合式写法
const toLowerCase = (str) =&gt; str.toLowerCase();
const join = curry((str, arr) =&gt; arr.join(str));
const split = curry((splitOn, str) =&gt; str.split(splitOn));

const toSlug = pipe(toLowerCase, split(&quot; &quot;), join(&quot;_&quot;), encodeURIComponent);
console.log(toSlug(&quot;Guo DongDong&quot;));
" data-status="copy"></button><div class="token-line"><span class="token comment">// &#x27;Guo DongDong&#x27; --&gt; &#x27;guo-dongdong&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 函数组合式写法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">toLowerCase</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> str</span><span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> join </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token parameter punctuation">,</span><span class="token parameter"> arr</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> arr</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token plain">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> split </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">splitOn</span><span class="token parameter punctuation">,</span><span class="token parameter"> str</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> str</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token plain">splitOn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> toSlug </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token plain">toLowerCase</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> encodeURIComponent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">toSlug</span><span class="token punctuation">(</span><span class="token string">&quot;Guo DongDong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><p><strong>好处</strong>:</p><ul><li>隐藏中间参数，不需要临时变量，避免了这个环节的出错几率；</li><li>只需关注每个纯函数单元的稳定，不再需要关注命名，传递，调用等；</li><li>可复用性强，任何一个函数单元都可被任意复用和组合；</li><li>可拓展性强，成本低，例如现在加个需求，要查看每个环节的输出:</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const log = curry((label, x) =&gt; {
  console.log(`${label}: ${x}`);
  return x;
});

const toSlug = pipe(
  toLowerCase,
  log(&quot;toLowerCase output&quot;),
  split(&quot; &quot;),
  log(&quot;split output&quot;),
  join(&quot;_&quot;),
  log(&quot;join output&quot;),
  encodeURIComponent
);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> log </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">label</span><span class="token parameter punctuation">,</span><span class="token parameter"> x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">label</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">: </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">x</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> x</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> toSlug </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  toLowerCase</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;toLowerCase output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;split output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;join output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  encodeURIComponent</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></li></ul><blockquote><p>Tips:</p><p>一些工具纯函数可直接引用<code>lodash/fp</code>，例如<code>curry/map/split</code>等，并不需要像我们上面这样自己实现；</p></blockquote></li><li><p><strong>数据不可变性</strong>(immutable): 这是一种数据理念，也是函数式编程中的核心理念之一:</p><ul><li><strong>倡导</strong>: 一个对象再被创建后便不会再被修改。当需要改变值时，是返回一个全新的对象，而不是直接在原对象上修改；</li><li><strong>目的</strong>: 保证数据的稳定性。避免依赖的数据被未知地修改，导致了自身的执行异常，能有效提高可控性与稳定性；</li><li>并不等同于<code>const</code>。使用<code>const</code>创建一个对象后，它的属性仍然可以被修改；</li><li>更类似于<code>Object.freeze</code>: 冻结对象，但<code>freeze</code>仍无法保证深层的属性不被串改；</li><li><code>immutable.js</code>: js 中的数据不可变库，它保证了数据不可变，在 React 生态中被广泛应用，大大提升了性能与稳定性；<ul><li><code>trie</code>数据结构:<ul><li>一种数据结构，能有效地深度冻结对象，保证其不可变；</li><li><strong>结构共享</strong>: 可以共用不可变对象的内存引用地址，减少内存占用，提高数据操作性能；</li></ul></li></ul></li></ul></li><li><p>避免不同函数之间的 <strong>状态共享</strong>，数据的传递使用复制或全新对象，遵守数据不可变原则；</p></li><li><p>避免从函数内部 <strong>改变外部状态</strong>，例如改变了全局作用域或父级作用域上的变量值，可能会导致其它单位错误；</p></li><li><p>避免在单元函数内部执行一些 <strong>副作用</strong>，应该将这些操作抽离成更独立的工具单元；</p><ul><li>日志输出</li><li>读写文件</li><li>网络请求</li><li>调用外部进程</li><li>调用有副作用的函数</li></ul></li></ul></li><li><p><strong>高阶函数</strong>: 是指 以函数为参数，返回一个新的增强函数 的一类函数，它通常用于:</p><ul><li>将逻辑行为进行 <strong>隔离抽象</strong>，便于快速复用，如处理数据，兼容性等；</li><li><strong>函数组合</strong>，将一系列单元函数列表组合成功能更强大的函数；</li><li><strong>函数增强</strong>，快速地拓展函数功能，</li></ul></li><li><p><strong>函数式编程的好处</strong>:</p><ul><li>函数副作用小，所有函数独立存在，没有任何耦合，复用性极高；</li><li>不关注执行时间，执行顺序，参数，命名等，能专注于数据的流动与处理，能有效提高稳定性与健壮性；</li><li>追求单元化，粒度化，使其重构和改造成本降低，可维护、可拓展性较好；</li><li>更易于做单元测试。</li></ul></li><li><p><strong>总结</strong>:</p><ul><li>函数式编程其实是一种编程思想，它追求更细的粒度，将应用拆分成一组组极小的单元函数，组合调用操作数据流；</li><li>它提倡着 纯函数 / 函数复合 / 数据不可变， 谨慎对待函数内的 状态共享 / 依赖外部 / 副作用；</li></ul></li></ul><blockquote><p>Tips:</p><p>其实我们很难也不需要在面试过程中去完美地阐述出整套思想，这里也只是浅尝辄止，一些个人理解而已。博主也是初级小菜鸟，停留在表面而已，只求对大家能有所帮助，轻喷 🤣；</p><p>我个人觉得: 这些编程范式之间，其实并不矛盾，各有各的 <strong>优劣势</strong>。</p><p>理解和学习它们的理念与优势，合理地 <strong>设计融合</strong>，将优秀的软件编程思想用于提升我们应用；</p><p>所有设计思想，最终的目标一定是使我们的应用更加 <strong>解耦颗粒化、易拓展、易测试、高复用，开发更为高效和安全</strong>；</p><p>有一些库能让大家很快地接触和运用函数思想: <code>Underscore.js</code> / <code>Lodash/fp</code> / <code>Rxjs</code> 等。</p></blockquote><h2 id="性能优化"><a aria-hidden="true" href="#性能优化"><span class="icon icon-link"></span></a>性能优化</h2><p>在最新的<code>React16</code>版本中，我们可以直接在url后加上<code>?react_pref</code>，就可以在chrome浏览器的<code>performance</code>，我们可以查看<code>User Timeing</code>来查看组件的加载时间。</p><p><img src="/static/react_pref.a037443c.webp"/></p><h3 id="性能检查"><a aria-hidden="true" href="#性能检查"><span class="icon icon-link"></span></a>性能检查</h3><p>参考<a href="https://juejin.im/post/5ea667cbf265da47c7122bdb" target="_blank" rel="noopener noreferrer">精读《React 性能调试》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h3 id="单组件优化"><a aria-hidden="true" href="#单组件优化"><span class="icon icon-link"></span></a>单组件优化</h3><ul><li><code>render</code>里面尽量减少新建变量和<code>bind</code>函数，传递参数是尽量减少传递参数的数量。</li><li>组件继承<code>React.PureComponent</code>，会对数据进行浅层比较</li><li>定制<code>shouldComponentUpdate</code>函数</li><li>使用<code>Immutable.js</code>进行数据管理</li></ul><p><img src="/static/immutable.b863de67.webp"/></p><p><a href="https://segmentfault.com/a/1190000003910357" target="_blank" rel="noopener noreferrer">Immutable详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://github.com/brickspert/blog/issues/36" target="_blank" rel="noopener noreferrer">React 项目性能分析及优化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h3 id="函数组件和类组件的区别"><a aria-hidden="true" href="#函数组件和类组件的区别"><span class="icon icon-link"></span></a>函数组件和类组件的区别</h3><p>函数组件和类组件当然是有区别的，而且函数组件的性能比类组件的性能要高，因为类组件使用的时候要实例化，而函数组件直接执行函数取返回结果即可。为了提高性能，尽量使用函数组件。</p><table><thead><tr><th>区别</th><th>函数组件</th><th>类组件</th></tr></thead><tbody><tr><td>是否有 this</td><td>没有</td><td>有</td></tr><tr><td>是否有生命周期</td><td>没有</td><td>有</td></tr><tr><td>是否有状态 state</td><td>没有</td><td>有</td></tr></tbody></table><p>参考：<a href="https://react.docschina.org/docs/hooks-reference.html#" target="_blank" rel="noopener noreferrer">React Hook API官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://www.jianshu.com/p/333f390f2e84" target="_blank" rel="noopener noreferrer">React 性能优化，你需要知道的几个点<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last Update: ">7/28/2020, 3:25:32 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
  </body>
</html>
