<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg" />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.25
    </script>
    <title>Vue</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/">Drex</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/guide">指南</a><a aria-current="page" class="active" href="/fontend">前端</a><a href="/backend">后端</a><a href="/devops">运维</a><a href="/blog">博客</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.svg&#x27;)" href="/"></a><h1>Drex</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/guide">指南</a></li><li><a aria-current="page" class="active" href="/fontend">前端</a></li><li><a href="/backend">后端</a></li><li><a href="/devops">运维</a></li><li><a href="/blog">博客</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/idrex/career">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/fontend">前端体系图</a></li><li><a href="/fontend/browser">浏览器</a><ul><li><a href="/fontend/browser/basic"><span>基础知识</span></a></li><li><a href="/fontend/browser/model"><span>浏览器模型</span></a></li><li><a href="/fontend/browser/optimization"><span>性能优化</span></a></li><li><a href="/fontend/browser/request"><span>网络请求</span></a></li></ul></li><li><a href="/fontend/html">Html</a><ul><li><a href="/fontend/html/basic"><span>基础知识</span></a></li></ul></li><li><a href="/fontend/css">CSS</a><ul><li><a href="/fontend/css/basic"><span>基础知识</span></a></li><li><a href="/fontend/css/less"><span>Less</span></a></li></ul></li><li><a href="/fontend/javasrcipt">Javasrcipt</a><ul><li><a href="/fontend/javasrcipt/basic"><span>基础中的基础</span></a></li><li><a href="/fontend/javasrcipt/application"><span>基础应用</span></a></li><li><a href="/fontend/javasrcipt/esnext"><span>ES6 &amp; ES Next</span></a></li><li><a href="/fontend/javasrcipt/ts"><span>TypeScript</span></a></li><li><a href="/fontend/javasrcipt/issues"><span>JS 相关方法实现</span></a></li><li><a href="/fontend/javasrcipt/optimization"><span>代码优化技巧</span></a></li></ul></li><li><a href="/fontend/construct">构建工具</a><ul><li><a href="/fontend/construct/webpack"><span>Webpack</span></a></li></ul></li><li><a aria-current="page" class="active" href="/fontend/frame">JS 框架</a><ul><li><a href="/fontend/frame/react"><span>React</span></a></li><li><a href="/fontend/frame/redux"><span>Redux</span></a></li><li><a aria-current="page" class="active" href="/fontend/frame/vue"><span>Vue</span></a></li></ul></li><li><a href="/fontend/mobile">移动&amp;桌面应用</a><ul><li><a href="/fontend/mobile/certificate"><span>证书说明</span></a></li><li><a href="/fontend/mobile/hybrid"><span>Hybrid APP</span></a></li><li><a href="/fontend/mobile/react-native"><span>React Native</span></a></li></ul></li><li><a href="/fontend/setup">工程体系</a><ul><li><a href="/fontend/setup/pattern"><span>体系格局</span></a></li><li><a href="/fontend/setup/engineering"><span>前端工程化</span></a></li></ul></li><li><a href="/fontend/package">Package</a><ul><li><a href="/fontend/package/module"><span>模块化标准</span></a></li><li><a href="/fontend/package/npm"><span>Npm</span></a></li><li><a href="/fontend/package/yarn"><span>Yarn</span></a></li></ul></li><li><a href="/fontend/security">Security</a><ul><li><a href="/fontend/security/monitor"><span>监控体系</span></a></li><li><a href="/fontend/security/web"><span>Web 安全</span></a></li></ul></li><li><a href="/fontend/visual">Visual</a><ul><li><a href="/fontend/visual/map"><span>Map 地图组建</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="1. nextTick" data-depth="3" class=""><a href="/fontend/frame/vue#1-nexttick"><span>1. nextTick</span></a></li><li title="2. 生命周期" data-depth="3" class=""><a href="/fontend/frame/vue#2-生命周期"><span>2. 生命周期</span></a></li><li title="3. 数据响应(数据劫持)" data-depth="3" class=""><a href="/fontend/frame/vue#3-数据响应数据劫持"><span>3. 数据响应(数据劫持)</span></a></li><li title="4. virtual dom 原理实现" data-depth="3" class=""><a href="/fontend/frame/vue#4-virtual-dom-原理实现"><span>4. virtual dom 原理实现</span></a></li><li title="5. Proxy 相比于 defineProperty 的优势" data-depth="3" class=""><a href="/fontend/frame/vue#5-proxy-相比于-defineproperty-的优势"><span>5. Proxy 相比于 defineProperty 的优势</span></a></li><li title="6. vue-router" data-depth="3" class=""><a href="/fontend/frame/vue#6-vue-router"><span>6. vue-router</span></a></li><li title="7. vuex" data-depth="3" class=""><a href="/fontend/frame/vue#7-vuex"><span>7. vuex</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h3 id="1-nexttick"><a aria-hidden="true" href="#1-nexttick"><span class="icon icon-link"></span></a>1. nextTick</h3><p>在下次<code>dom</code>更新循环结束之后执行延迟回调，可用于获取更新后的<code>dom</code>状态</p><ul><li><p>新版本中默认是<code>mincrotasks</code>, <code>v-on</code>中会使用<code>macrotasks</code></p></li><li><p><code>macrotasks</code>任务的实现: - <code>setImmediate / MessageChannel / setTimeout</code></p></li></ul><h3 id="2-生命周期"><a aria-hidden="true" href="#2-生命周期"><span class="icon icon-link"></span></a>2. 生命周期</h3><ul><li><p><code>_init_</code><br/>- <code>initLifecycle/Event</code>，往<code>vm</code>上挂载各种属性 - <code>callHook: beforeCreated</code>: 实例刚创建 - <code>initInjection/initState</code>: 初始化注入和 data 响应性 - <code>created</code>: 创建完成，属性已经绑定， 但还未生成真实<code>dom</code>- 进行元素的挂载： <code>$el / vm.$mount()</code>- 是否有<code>template</code>: 解析成<code>render function</code>- <code>*.vue</code>文件: <code>vue-loader</code>会将<code>&lt;template&gt;</code>编译成<code>render function</code>- <code>beforeMount</code>: 模板编译/挂载之前 - 执行<code>render function</code>，生成真实的<code>dom</code>，并替换到<code>dom tree</code>中 - <code>mounted</code>: 组件已挂载</p></li><li><p><code>update</code>: - 执行<code>diff</code>算法，比对改变是否需要触发UI更新 - <code>flushScheduleQueue</code>- <code>watcher.before</code>: 触发<code>beforeUpdate</code>钩子  - <code>watcher.run()</code>: 执行<code>watcher</code>中的 <code>notify</code>，通知所有依赖项更新UI - 触发<code>updated</code>钩子: 组件已更新</p></li><li><p><code>actived / deactivated(keep-alive)</code>: 不销毁，缓存，组件激活与失活</p></li><li><p><code>destroy</code>: - <code>beforeDestroy</code>: 销毁开始 - 销毁自身且递归销毁子组件以及事件监听 - <code>remove()</code>: 删除节点 - <code>watcher.teardown()</code>: 清空依赖 - <code>vm.$off()</code>: 解绑监听 - <code>destroyed</code>: 完成后触发钩子</p></li></ul><p>上面是<code>vue</code>的声明周期的简单梳理，接下来我们直接以代码的形式来完成<code>vue</code>的初始化</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="
new Vue({})

// 初始化Vue实例
function _init() {
     // 挂载属性
    initLifeCycle(vm) 
    // 初始化事件系统，钩子函数等
    initEvent(vm) 
    // 编译slot、vnode
    initRender(vm) 
    // 触发钩子
    callHook(vm, &#x27;beforeCreate&#x27;)
    // 添加inject功能
    initInjection(vm)
    // 完成数据响应性 props/data/watch/computed/methods
    initState(vm)
    // 添加 provide 功能
    initProvide(vm)
    // 触发钩子
    callHook(vm, &#x27;created&#x27;)
        
     // 挂载节点
    if (vm.$options.el) {
        vm.$mount(vm.$options.el)
    }
}

// 挂载节点实现
function mountComponent(vm) {
     // 获取 render function
    if (!this.options.render) {
        // template to render
        // Vue.compile = compileToFunctions
        let { render } = compileToFunctions() 
        this.options.render = render
    }
    // 触发钩子
    callHook(&#x27;beforeMounte&#x27;)
    // 初始化观察者
    // render 渲染 vdom， 
    vdom = vm.render()
    // update: 根据 diff 出的 patchs 挂载成真实的 dom 
    vm._update(vdom)
    // 触发钩子  
    callHook(vm, &#x27;mounted&#x27;)
}

// 更新节点实现
funtion queueWatcher(watcher) {
    nextTick(flushScheduleQueue)
}

// 清空队列
function flushScheduleQueue() {
     // 遍历队列中所有修改
    for(){
        // beforeUpdate
        watcher.before()
         
        // 依赖局部更新节点
        watcher.update() 
        callHook(&#x27;updated&#x27;)
    }
}

// 销毁实例实现
Vue.prototype.$destory = function() {
     // 触发钩子
    callHook(vm, &#x27;beforeDestory&#x27;)
    // 自身及子节点
    remove() 
    // 删除依赖
    watcher.teardown() 
    // 删除监听
    vm.$off() 
    // 触发钩子
    callHook(vm, &#x27;destoryed&#x27;)
}
" data-status="copy"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 初始化Vue实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 挂载属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initLifeCycle</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 初始化事件系统，钩子函数等</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 编译slot、vnode</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initRender</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 触发钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;beforeCreate&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 添加inject功能</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initInjection</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 完成数据响应性 props/data/watch/computed/methods</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 添加 provide 功能</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">initProvide</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 触发钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;created&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 挂载节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">$options</span><span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        vm</span><span class="token punctuation">.</span><span class="token method function property-access">$mount</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">.</span><span class="token property-access">$options</span><span class="token punctuation">.</span><span class="token property-access">el</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 挂载节点实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 获取 render function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">render</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// template to render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// Vue.compile = compileToFunctions</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> render </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">compileToFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> render</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 触发钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">&#x27;beforeMounte&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 初始化观察者</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// render 渲染 vdom， </span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    vdom </span><span class="token operator">=</span><span class="token plain"> vm</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// update: 根据 diff 出的 patchs 挂载成真实的 dom </span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    vm</span><span class="token punctuation">.</span><span class="token method function property-access">_update</span><span class="token punctuation">(</span><span class="token plain">vdom</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 触发钩子  </span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;mounted&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 更新节点实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">funtion </span><span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token plain">flushScheduleQueue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 清空队列</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">flushScheduleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 遍历队列中所有修改</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// beforeUpdate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        watcher</span><span class="token punctuation">.</span><span class="token method function property-access">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">         </span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 依赖局部更新节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        watcher</span><span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">        </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">&#x27;updated&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 销毁实例实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">$destory</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 触发钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;beforeDestory&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 自身及子节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 删除依赖</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    watcher</span><span class="token punctuation">.</span><span class="token method function property-access">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 删除监听</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    vm</span><span class="token punctuation">.</span><span class="token method function property-access">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 触发钩子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token plain">vm</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;destoryed&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="3-数据响应数据劫持"><a aria-hidden="true" href="#3-数据响应数据劫持"><span class="icon icon-link"></span></a>3. 数据响应(数据劫持)</h3><p>看完生命周期后，里面的<code>watcher</code>等内容其实是数据响应中的一部分。数据响应的实现由两部分构成: <strong>观察者( watcher )</strong> 和 <strong>依赖收集器( Dep )</strong>，其核心是 <code>defineProperty</code>这个方法，它可以 <strong>重写属性的 get 与 set</strong> 方法，从而完成监听数据的改变。</p><ul><li>Observe (观察者)观察 props 与 state - 遍历 props 与 state，对每个属性创建独立的监听器( watcher )</li><li>使用 <code>defineProperty</code> 重写每个属性的 get/set(<code>defineReactive</code>） - <code>get</code>: 收集依赖 - <code>Dep.depend()</code>- <code>watcher.addDep()</code>- <code>set</code>: 派发更新 - <code>Dep.notify()</code>- <code>watcher.update()</code>- <code>queenWatcher()</code>- <code>nextTick</code>- <code>flushScheduleQueue</code>- <code>watcher.run()</code>- <code>updateComponent()</code></li></ul><p>大家可以先看下面的数据相应的代码实现后，理解后就比较容易看懂上面的简单脉络了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="let data = {a: 1}
// 数据响应性
observe(data)

// 初始化观察者
new Watcher(data, &#x27;name&#x27;, updateComponent)
data.a = 2

// 简单表示用于数据更新后的操作
function updateComponent() {
    vm._update() // patchs
}

// 监视对象
function observe(obj) {
     // 遍历对象，使用 get/set 重新定义对象的每个属性值
    Object.keys(obj).map(key =&gt; {
        defineReactive(obj, key, obj[key])
    })
}

function defineReactive(obj, k, v) {
    // 递归子属性
    if (type(v) == &#x27;object&#x27;) observe(v)
    
    // 新建依赖收集器
    let dep = new Dep()
    // 定义get/set
    Object.defineProperty(obj, k, {
        enumerable: true,
        configurable: true,
        get: function reactiveGetter() {
              // 当有获取该属性时，证明依赖于该对象，因此被添加进收集器中
            if (Dep.target) {
                dep.addSub(Dep.target)
            }
            return v
        },
        // 重新设置值时，触发收集器的通知机制
        set: function reactiveSetter(nV) {
            v = nV
            dep.nofify()
        },
    })
}

// 依赖收集器
class Dep {
    constructor() {
        this.subs = []
    }
    addSub(sub) {
        this.subs.push(sub)
    }
    notify() {
        this.subs.map(sub =&gt; {
            sub.update()
        })
    }
}

Dep.target = null

// 观察者
class Watcher {
    constructor(obj, key, cb) {
        Dep.target = this
        this.cb = cb
        this.obj = obj
        this.key = key
        this.value = obj[key]
        Dep.target = null
    }
    addDep(Dep) {
        Dep.addSub(this)
    }
    update() {
        this.value = this.obj[this.key]
        this.cb(this.value)
    }
    before() {
        callHook(&#x27;beforeUpdate&#x27;)
    }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">a</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 数据响应性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 初始化观察者</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;name&#x27;</span><span class="token punctuation">,</span><span class="token plain"> updateComponent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">data</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 简单表示用于数据更新后的操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    vm</span><span class="token punctuation">.</span><span class="token method function property-access">_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// patchs</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 监视对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 遍历对象，使用 get/set 重新定义对象的每个属性值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"> obj</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token parameter punctuation">,</span><span class="token parameter"> k</span><span class="token parameter punctuation">,</span><span class="token parameter"> v</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 递归子属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token plain">v</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string">&#x27;object&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token plain">v</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 新建依赖收集器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> dep </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 定义get/set</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">,</span><span class="token plain"> k</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        enumerable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        configurable</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token comment">// 当有获取该属性时，证明依赖于该对象，因此被添加进收集器中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                dep</span><span class="token punctuation">.</span><span class="token method function property-access">addSub</span><span class="token punctuation">(</span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">return</span><span class="token plain"> v</span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 重新设置值时，触发收集器的通知机制</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function-variable function">set</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">nV</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            v </span><span class="token operator">=</span><span class="token plain"> nV</span></div><div class="token-line"><span class="token plain">            dep</span><span class="token punctuation">.</span><span class="token method function property-access">nofify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 依赖收集器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Dep</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subs</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">sub</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subs</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            sub</span><span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 观察者</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Watcher</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cb</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> cb</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">obj</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> obj</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> key</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> obj</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token property-access">target</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">Dep</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Dep</span><span class="token punctuation">.</span><span class="token method function property-access">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">obj</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">&#x27;beforeUpdate&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="4-virtual-dom-原理实现"><a aria-hidden="true" href="#4-virtual-dom-原理实现"><span class="icon icon-link"></span></a>4. virtual dom 原理实现</h3><ul><li>创建 dom 树</li><li>树的<code>diff</code>，同层对比，输出<code>patchs(listDiff/diffChildren/diffProps)</code>- 没有新的节点，返回 - 新的节点<code>tagName</code>与<code>key</code>不变， 对比<code>props</code>，继续递归遍历子树 - 对比属性(对比新旧属性列表): - 旧属性是否存在与新属性列表中 - 都存在的是否有变化 - 是否出现旧列表中没有的新属性 - <code>tagName</code>和<code>key</code>值变化了，则直接替换成新节点</li><li>渲染差异 - 遍历<code>patchs</code>， 把需要更改的节点取出来 - 局部更新<code>dom</code> </li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// diff算法的实现
function diff(oldTree, newTree) {
     // 差异收集
    let pathchs = {}
    dfs(oldTree, newTree, 0, pathchs)
    return pathchs
}

function dfs(oldNode, newNode, index, pathchs) {
    let curPathchs = []
    if (newNode) {
        // 当新旧节点的 tagName 和 key 值完全一致时
        if (oldNode.tagName === newNode.tagName &amp;&amp; oldNode.key === newNode.key) {
              // 继续比对属性差异
            let props = diffProps(oldNode.props, newNode.props)
            curPathchs.push({ type: &#x27;changeProps&#x27;, props })
            // 递归进入下一层级的比较
            diffChildrens(oldNode.children, newNode.children, index, pathchs)
        } else {
              // 当 tagName 或者 key 修改了后，表示已经是全新节点，无需再比
            curPathchs.push({ type: &#x27;replaceNode&#x27;, node: newNode })
        }
    }

     // 构建出整颗差异树
    if (curPathchs.length) {
            if(pathchs[index]){
                pathchs[index] = pathchs[index].concat(curPathchs)
            } else {
                pathchs[index] = curPathchs
            }
    }
}

// 属性对比实现
function diffProps(oldProps, newProps) {
    let propsPathchs = []
    // 遍历新旧属性列表
    // 查找删除项
    // 查找修改项
    // 查找新增项
    forin(olaProps, (k, v) =&gt; {
        if (!newProps.hasOwnProperty(k)) {
            propsPathchs.push({ type: &#x27;remove&#x27;, prop: k })
        } else {
            if (v !== newProps[k]) {
                propsPathchs.push({ type: &#x27;change&#x27;, prop: k , value: newProps[k] })
            }
        }
    })
    forin(newProps, (k, v) =&gt; {
        if (!oldProps.hasOwnProperty(k)) {
            propsPathchs.push({ type: &#x27;add&#x27;, prop: k, value: v })
        }
    })
    return propsPathchs
}

// 对比子级差异
function diffChildrens(oldChild, newChild, index, pathchs) {
        // 标记子级的删除/新增/移动
    let { change, list } = diffList(oldChild, newChild, index, pathchs)
    if (change.length) {
        if (pathchs[index]) {
            pathchs[index] = pathchs[index].concat(change)
        } else {
            pathchs[index] = change
        }
    }

     // 根据 key 获取原本匹配的节点，进一步递归从头开始对比
    oldChild.map((item, i) =&gt; {
        let keyIndex = list.indexOf(item.key)
        if (keyIndex) {
            let node = newChild[keyIndex]
            // 进一步递归对比
            dfs(item, node, index, pathchs)
        }
    })
}

// 列表对比，主要也是根据 key 值查找匹配项
// 对比出新旧列表的新增/删除/移动
function diffList(oldList, newList, index, pathchs) {
    let change = []
    let list = []
    const newKeys = getKey(newList)
    oldList.map(v =&gt; {
        if (newKeys.indexOf(v.key) &gt; -1) {
            list.push(v.key)
        } else {
            list.push(null)
        }
    })

    // 标记删除
    for (let i = list.length - 1; i&gt;= 0; i--) {
        if (!list[i]) {
            list.splice(i, 1)
            change.push({ type: &#x27;remove&#x27;, index: i })
        }
    }

    // 标记新增和移动
    newList.map((item, i) =&gt; {
        const key = item.key
        const index = list.indexOf(key)
        if (index === -1 || key == null) {
            // 新增
            change.push({ type: &#x27;add&#x27;, node: item, index: i })
            list.splice(i, 0, key)
        } else {
            // 移动
            if (index !== i) {
                change.push({
                    type: &#x27;move&#x27;,
                    form: index,
                    to: i,
                })
                move(list, index, i)
            }
        }
    })

    return { change, list }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// diff算法的实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">oldTree</span><span class="token parameter punctuation">,</span><span class="token parameter"> newTree</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 差异收集</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> pathchs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token plain">oldTree</span><span class="token punctuation">,</span><span class="token plain"> newTree</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> pathchs</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> pathchs</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode</span><span class="token parameter punctuation">,</span><span class="token parameter"> newNode</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> pathchs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> curPathchs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newNode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 当新旧节点的 tagName 和 key 值完全一致时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldNode</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> oldNode</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token comment">// 继续比对属性差异</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">let</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token plain">oldNode</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            curPathchs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;changeProps&#x27;</span><span class="token punctuation">,</span><span class="token plain"> props </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 递归进入下一层级的比较</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">diffChildrens</span><span class="token punctuation">(</span><span class="token plain">oldNode</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">,</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> pathchs</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token comment">// 当 tagName 或者 key 修改了后，表示已经是全新节点，无需再比</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            curPathchs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;replaceNode&#x27;</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">:</span><span class="token plain"> newNode </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 构建出整颗差异树</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">curPathchs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token plain">pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token plain">curPathchs</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> curPathchs</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 属性对比实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> newProps</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> propsPathchs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 遍历新旧属性列表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 查找删除项</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 查找修改项</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 查找新增项</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">forin</span><span class="token punctuation">(</span><span class="token plain">olaProps</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token parameter punctuation">,</span><span class="token parameter"> v</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">newProps</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">k</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            propsPathchs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;remove&#x27;</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">:</span><span class="token plain"> k </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">v </span><span class="token operator">!==</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">k</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                propsPathchs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;change&#x27;</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">:</span><span class="token plain"> k </span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">:</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">k</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">forin</span><span class="token punctuation">(</span><span class="token plain">newProps</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token parameter punctuation">,</span><span class="token parameter"> v</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">oldProps</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">k</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            propsPathchs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;add&#x27;</span><span class="token punctuation">,</span><span class="token plain"> prop</span><span class="token punctuation">:</span><span class="token plain"> k</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">:</span><span class="token plain"> v </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> propsPathchs</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对比子级差异</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diffChildrens</span><span class="token punctuation">(</span><span class="token parameter">oldChild</span><span class="token parameter punctuation">,</span><span class="token parameter"> newChild</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> pathchs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 标记子级的删除/新增/移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> change</span><span class="token punctuation">,</span><span class="token plain"> list </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">diffList</span><span class="token punctuation">(</span><span class="token plain">oldChild</span><span class="token punctuation">,</span><span class="token plain"> newChild</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> pathchs</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            pathchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> change</span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">     </span><span class="token comment">// 根据 key 获取原本匹配的节点，进一步递归从头开始对比</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    oldChild</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> keyIndex </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">keyIndex</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">let</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> newChild</span><span class="token punctuation">[</span><span class="token plain">keyIndex</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 进一步递归对比</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> pathchs</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 列表对比，主要也是根据 key 值查找匹配项</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对比出新旧列表的新增/删除/移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diffList</span><span class="token punctuation">(</span><span class="token parameter">oldList</span><span class="token parameter punctuation">,</span><span class="token parameter"> newList</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> pathchs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> change </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> list </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newKeys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token plain">newList</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    oldList</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newKeys</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">v</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            list</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">v</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            list</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 标记删除</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">--</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">list</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            list</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;remove&#x27;</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">:</span><span class="token plain"> i </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 标记新增和移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    newList</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> key </span><span class="token operator">==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 新增</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;add&#x27;</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">:</span><span class="token plain"> item</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">:</span><span class="token plain"> i </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            list</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token comment">// 移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">!==</span><span class="token plain"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;move&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    form</span><span class="token punctuation">:</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    to</span><span class="token punctuation">:</span><span class="token plain"> i</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token function">move</span><span class="token punctuation">(</span><span class="token plain">list</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> i</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> change</span><span class="token punctuation">,</span><span class="token plain"> list </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="5-proxy-相比于-defineproperty-的优势"><a aria-hidden="true" href="#5-proxy-相比于-defineproperty-的优势"><span class="icon icon-link"></span></a>5. Proxy 相比于 defineProperty 的优势</h3><ul><li>数组变化也能监听到</li><li>不需要深度遍历监听</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="let data = { a: 1 }
let reactiveData = new Proxy(data, {
    get: function(target, name){
        // ...
    },
    // ...
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> a</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> reactiveData </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token parameter punctuation">,</span><span class="token parameter"> name</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="6-vue-router"><a aria-hidden="true" href="#6-vue-router"><span class="icon icon-link"></span></a>6. vue-router</h3><ul><li><code>mode</code>- <code>hash</code>- <code>history</code></li><li>跳转 - <code>this.$router.push()</code>- <code>&lt;router-link to=&quot;&quot;&gt;&lt;/router-link&gt;</code></li><li>占位 - <code>&lt;router-view&gt;&lt;/router-view&gt;</code></li></ul><h3 id="7-vuex"><a aria-hidden="true" href="#7-vuex"><span class="icon icon-link"></span></a>7. vuex</h3><ul><li><code>state</code>: 状态中心  </li><li><code>mutations</code>: 更改状态</li><li><code>actions</code>: 异步更改状态</li><li><code>getters</code>: 获取状态</li><li><code>modules</code>: 将<code>state</code>分成多个<code>modules</code>，便于管理</li></ul></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="Last Update: ">11/5/2020, 10:02:50 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
  </body>
</html>
