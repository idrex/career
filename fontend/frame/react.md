---
title: React
group:
  title: JS æ¡†æ¶
  order: 10
---

**React**

`React` ä¹Ÿæ˜¯ç°å¦‚ä»Šæœ€æµè¡Œçš„å‰ç«¯æ¡†æ¶ï¼Œä¹Ÿæ˜¯å¾ˆå¤šå¤§å‚é¢è¯•å¿…å¤‡ã€‚`React` ä¸ `Vue` è™½æœ‰ä¸åŒï¼Œä½†åŒæ ·ä½œä¸ºä¸€æ¬¾ `UI` æ¡†æ¶ï¼Œè™½ç„¶å®ç°å¯èƒ½ä¸ä¸€æ ·ï¼Œä½†åœ¨ä¸€äº›ç†å¿µä¸Šè¿˜æ˜¯æœ‰ç›¸ä¼¼çš„ï¼Œä¾‹å¦‚æ•°æ®é©±åŠ¨ã€ç»„ä»¶åŒ–ã€è™šæ‹Ÿ `dom` ç­‰ã€‚è¿™é‡Œå°±ä¸»è¦åˆ—ä¸¾ä¸€äº› React ä¸­ç‹¬æœ‰çš„æ¦‚å¿µã€‚

## æ¶æ„

### Fiber

React16 æå‡ºäº† Fiber ç»“æ„ï¼Œå…¶èƒ½å¤Ÿå°†ä»»åŠ¡åˆ†ç‰‡ï¼Œåˆ’åˆ†ä¼˜å…ˆçº§ï¼ŒåŒæ—¶èƒ½å¤Ÿå®ç°ç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­å¯¹çº¿ç¨‹çš„æŠ¢å å¼è°ƒåº¦ï¼Œéå¸¸å¼ºå¤§ã€‚

React çš„æ ¸å¿ƒæµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:

- reconciliation (**è°ƒåº¦ç®—æ³•**ï¼Œä¹Ÿå¯ç§°ä¸º render):
  - æ›´æ–° state ä¸ propsï¼›
  - è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­ï¼›
  - ç”Ÿæˆ virtual domï¼›
  - é€šè¿‡æ–°æ—§ vdom è¿›è¡Œ diff ç®—æ³•ï¼Œè·å– vdom changeï¼›
  - ç¡®å®šæ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
- commit:
  - å¦‚éœ€è¦ï¼Œåˆ™æ“ä½œ dom èŠ‚ç‚¹æ›´æ–°ï¼›

è¦äº†è§£ Fiberï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

- **é—®é¢˜**: éšç€åº”ç”¨å˜å¾—è¶Šæ¥è¶Šåºå¤§ï¼Œæ•´ä¸ªæ›´æ–°æ¸²æŸ“çš„è¿‡ç¨‹å¼€å§‹å˜å¾—åƒåŠ›ï¼Œå¤§é‡çš„ç»„ä»¶æ¸²æŸ“ä¼šå¯¼è‡´ä¸»è¿›ç¨‹é•¿æ—¶é—´è¢«å ç”¨ï¼Œå¯¼è‡´ä¸€äº›åŠ¨ç”»æˆ–é«˜é¢‘æ“ä½œå‡ºç°å¡é¡¿å’Œæ‰å¸§çš„æƒ…å†µã€‚è€Œå…³é”®ç‚¹ï¼Œä¾¿æ˜¯ **åŒæ­¥é˜»å¡**ã€‚åœ¨ä¹‹å‰çš„è°ƒåº¦ç®—æ³•ä¸­ï¼ŒReact éœ€è¦å®ä¾‹åŒ–æ¯ä¸ªç±»ç»„ä»¶ï¼Œç”Ÿæˆä¸€é¢—ç»„ä»¶æ ‘ï¼Œä½¿ç”¨ **åŒæ­¥é€’å½’** çš„æ–¹å¼è¿›è¡Œéå†æ¸²æŸ“ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ— æ³• **æš‚åœå’Œæ¢å¤**ã€‚

- **è§£å†³æ–¹æ¡ˆ**: è§£å†³åŒæ­¥é˜»å¡çš„æ–¹æ³•ï¼Œé€šå¸¸æœ‰ä¸¤ç§: **å¼‚æ­¥** ä¸ **ä»»åŠ¡åˆ†å‰²**ã€‚è€Œ React Fiber ä¾¿æ˜¯ä¸ºäº†å®ç°ä»»åŠ¡åˆ†å‰²è€Œè¯ç”Ÿçš„ã€‚

- **ç®€è¿°**:

  - åœ¨ React V16 å°†è°ƒåº¦ç®—æ³•è¿›è¡Œäº†é‡æ„ï¼Œ å°†ä¹‹å‰çš„ stack reconciler é‡æ„æˆæ–°ç‰ˆçš„ fiber reconcilerï¼Œå˜æˆäº†å…·æœ‰é“¾è¡¨å’ŒæŒ‡é’ˆçš„ **å•é“¾è¡¨æ ‘éå†ç®—æ³•**ã€‚é€šè¿‡æŒ‡é’ˆæ˜ å°„ï¼Œæ¯ä¸ªå•å…ƒéƒ½è®°å½•ç€éå†å½“ä¸‹çš„ä¸Šä¸€æ­¥ä¸ä¸‹ä¸€æ­¥ï¼Œä»è€Œä½¿éå†å˜å¾—å¯ä»¥è¢«æš‚åœå’Œé‡å¯ã€‚
  - è¿™é‡Œæˆ‘ç†è§£ä¸ºæ˜¯ä¸€ç§ **ä»»åŠ¡åˆ†å‰²è°ƒåº¦ç®—æ³•**ï¼Œä¸»è¦æ˜¯ å°†åŸå…ˆåŒæ­¥æ›´æ–°æ¸²æŸ“çš„ä»»åŠ¡åˆ†å‰²æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„ **å°ä»»åŠ¡å•ä½**ï¼Œæ ¹æ®ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œå°†å°ä»»åŠ¡åˆ†æ•£åˆ°æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨ä¸»è¿›ç¨‹çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚

- **æ ¸å¿ƒ**:

  - Fiber è¿™é‡Œå¯ä»¥å…·è±¡ä¸ºä¸€ä¸ª **æ•°æ®ç»“æ„**:

  ```js
  class Fiber {
    constructor(instance) {
      this.instance = instance;
      // æŒ‡å‘ç¬¬ä¸€ä¸ª child èŠ‚ç‚¹
      this.child = child;
      // æŒ‡å‘çˆ¶èŠ‚ç‚¹
      this.return = parent;
      // æŒ‡å‘ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
      this.sibling = previous;
    }
  }
  ```

  - **é“¾è¡¨æ ‘éå†ç®—æ³•**: é€šè¿‡ **èŠ‚ç‚¹ä¿å­˜ä¸æ˜ å°„**ï¼Œä¾¿èƒ½å¤Ÿéšæ—¶åœ°è¿›è¡Œ åœæ­¢å’Œé‡å¯ï¼Œè¿™æ ·ä¾¿èƒ½è¾¾åˆ°å®ç°ä»»åŠ¡åˆ†å‰²çš„åŸºæœ¬å‰æï¼›

    - 1ã€é¦–å…ˆé€šè¿‡ä¸æ–­éå†å­èŠ‚ç‚¹ï¼Œåˆ°æ ‘æœ«å°¾ï¼›
    - 2ã€å¼€å§‹é€šè¿‡ sibling éå†å…„å¼ŸèŠ‚ç‚¹ï¼›
    - 3ã€return è¿”å›çˆ¶èŠ‚ç‚¹ï¼Œç»§ç»­æ‰§è¡Œ 2ï¼›
    - 4ã€ç›´åˆ° root èŠ‚ç‚¹åï¼Œè·³å‡ºéå†ï¼›

  - **ä»»åŠ¡åˆ†å‰²**ï¼ŒReact ä¸­çš„æ¸²æŸ“æ›´æ–°å¯ä»¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µ:

    - **reconciliation é˜¶æ®µ**: vdom çš„æ•°æ®å¯¹æ¯”ï¼Œæ˜¯ä¸ªé€‚åˆæ‹†åˆ†çš„é˜¶æ®µï¼Œæ¯”å¦‚å¯¹æ¯”ä¸€éƒ¨åˆ†æ ‘åï¼Œå…ˆæš‚åœæ‰§è¡Œä¸ªåŠ¨ç”»è°ƒç”¨ï¼Œå¾…å®Œæˆåå†å›æ¥ç»§ç»­æ¯”å¯¹ã€‚
    - **Commit é˜¶æ®µ**: å°† change list æ›´æ–°åˆ° dom ä¸Šï¼Œä¸é€‚åˆæ‹†åˆ†ï¼Œå› ä¸ºä½¿ç”¨ vdom çš„æ„ä¹‰å°±æ˜¯ä¸ºäº†èŠ‚çœä¼ è¯´ä¸­æœ€è€—æ—¶çš„ dom æ“ä½œï¼ŒæŠŠæ‰€æœ‰æ“ä½œä¸€æ¬¡æ€§æ›´æ–°ï¼Œå¦‚æœåœ¨è¿™é‡Œåˆæ‹†åˆ†ï¼Œé‚£ä¸æ˜¯åˆæ‡µäº†ä¹ˆã€‚ğŸ™ƒ

  - **åˆ†æ•£æ‰§è¡Œ**: ä»»åŠ¡åˆ†å‰²åï¼Œå°±å¯ä»¥æŠŠå°ä»»åŠ¡å•å…ƒåˆ†æ•£åˆ°æµè§ˆå™¨çš„ç©ºé—²æœŸé—´å»æ’é˜Ÿæ‰§è¡Œï¼Œè€Œå®ç°çš„å…³é”®æ˜¯ä¸¤ä¸ªæ–° API: `requestIdleCallback` ä¸ `requestAnimationFrame`
    - ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡äº¤ç»™`requestIdleCallback`å¤„ç†ï¼Œè¿™æ˜¯ä¸ªæµè§ˆå™¨æä¾›çš„äº‹ä»¶å¾ªç¯ç©ºé—²æœŸçš„å›è°ƒå‡½æ•°ï¼Œéœ€è¦ pollyfillï¼Œè€Œä¸”æ‹¥æœ‰ deadline å‚æ•°ï¼Œé™åˆ¶æ‰§è¡Œäº‹ä»¶ï¼Œä»¥ç»§ç»­åˆ‡åˆ†ä»»åŠ¡ï¼›
    - é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡äº¤ç»™`requestAnimationFrame`å¤„ç†ï¼›

  ```js
  // ç±»ä¼¼äºè¿™æ ·çš„æ–¹å¼
  requestIdleCallback((deadline) => {
    // å½“æœ‰ç©ºé—²æ—¶é—´æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªç»„ä»¶æ¸²æŸ“ï¼›
    // æŠŠä»»åŠ¡å¡åˆ°ä¸€ä¸ªä¸ªç¢ç‰‡æ—¶é—´ä¸­å»ï¼›
    while (
      (deadline.timeRemaining() > 0 || deadline.didTimeout) &&
      nextComponent
    ) {
      nextComponent = performWork(nextComponent);
    }
  });
  ```

  - **ä¼˜å…ˆçº§ç­–ç•¥**: æ–‡æœ¬æ¡†è¾“å…¥ > æœ¬æ¬¡è°ƒåº¦ç»“æŸéœ€å®Œæˆçš„ä»»åŠ¡ > åŠ¨ç”»è¿‡æ¸¡ > äº¤äº’åé¦ˆ > æ•°æ®æ›´æ–° > ä¸ä¼šæ˜¾ç¤ºä½†ä»¥é˜²å°†æ¥ä¼šæ˜¾ç¤ºçš„ä»»åŠ¡

> Tips:
>
> Fiber å…¶å®å¯ä»¥ç®—æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œåœ¨å…¶å®ƒè¯­è¨€ä¸­ä¹Ÿæœ‰è®¸å¤šåº”ç”¨(Ruby Fiber)ã€‚å½“é‡åˆ°è¿›ç¨‹é˜»å¡çš„é—®é¢˜æ—¶ï¼Œ**ä»»åŠ¡åˆ†å‰²**ã€**å¼‚æ­¥è°ƒç”¨** å’Œ **ç¼“å­˜ç­–ç•¥** æ˜¯ä¸‰ä¸ªæ˜¾è‘—çš„è§£å†³æ€è·¯ã€‚

### Virtual DOM

è™½ç„¶DOMæ˜¯ç”±JavaScriptå®ç°çš„ï¼Œä½†æ˜¯åœ¨æµè§ˆå™¨ä¸­éƒ½æ˜¯æŠŠDOMå’ŒJavaScriptåˆ†å¼€æ¥å®ç°çš„ï¼Œæ¯”å¦‚IEä¸­ï¼ŒJavaScriptçš„å®ç°åä¸ºJScriptï¼Œæ”¾åœ¨jscript.dllæ–‡ä»¶ä¸­ï¼Œè€ŒDOMåˆ™æ”¾åœ¨å¦ä¸€ä¸ªå«åšmshtml.dllçš„åº“ä¸­ã€‚åœ¨Safariä¸­ï¼ŒDOMå’Œæ¸²æŸ“æ˜¯ä½¿ç”¨Webkitä¸­çš„WebCoreå®ç°ï¼Œè€ŒJavaScriptæ˜¯ç”±ç‹¬ç«‹çš„JavaScriptCoreå¼•æ“å®ç°ï¼ŒåŒæ ·åœ¨Chromeä¸­ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨WebCoreæ¥å®ç°æ¸²æŸ“ï¼Œè€ŒJavaScriptå¼•æ“åˆ™æ˜¯ä»–ä»¬è‡ªå·±ç ”å‘çš„V8å¼•æ“ã€‚

ç”±äºDOMå’ŒJavaScriptæ˜¯è¢«åˆ†å¼€ç‹¬ç«‹å®ç°çš„ï¼Œå› æ­¤ï¼Œæ¯ä¸€æ¬¡åœ¨é€šè¿‡jsæ“ä½œDOMçš„æ—¶å€™ï¼Œå°±éœ€è¦å…ˆå»è¿æ¥jså’ŒDOMï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼šæŠŠDOMå’ŒJavaScriptæ¯”ä½œä¸¤ä¸ªå²›ï¼Œä»–ä»¬ä¹‹é—´é€šè¿‡ä¸€ä¸ªæ”¶è´¹çš„æ¡¥è¿æ¥ç€ï¼Œæ¯ä¸€æ¬¡è®¿é—®DOMçš„æ—¶å€™ï¼Œå°±éœ€è¦ç»è¿‡è¿™åº§æ¡¥ï¼Œå¹¶ä¸”ç»™â€œè¿‡è·¯è´¹â€ï¼Œè®¿é—®çš„æ¬¡æ•°è¶Šå¤šï¼Œè·¯è´¹å°±ä¼šè¶Šé«˜ï¼Œå¹¶ä¸”è®¿é—®åˆ°DOMåï¼Œæ“ä½œå…·ä½“çš„DOMè¿˜éœ€è¦ç»™â€œæ“ä½œè´¹â€ï¼Œç”±äºæµè§ˆå™¨è®¿é—®DOMçš„æ“ä½œå¾ˆå¤šï¼Œå› æ­¤ï¼Œâ€œè·¯è´¹â€å’Œâ€œæ“ä½œè´¹â€è‡ªç„¶ä¼šå¢åŠ ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ“ä½œDOMä¼šå¾ˆæ…¢çš„åŸå› 

## ç”Ÿå‘½å‘¨æœŸ

åœ¨æ–°ç‰ˆæœ¬ä¸­ï¼ŒReact å®˜æ–¹å¯¹ç”Ÿå‘½å‘¨æœŸæœ‰äº†æ–°çš„ **å˜åŠ¨å»ºè®®**:

- ä½¿ç”¨`getDerivedStateFromProps` æ›¿æ¢`componentWillMount`ï¼›
- ä½¿ç”¨`getSnapshotBeforeUpdate`æ›¿æ¢`componentWillUpdate`ï¼›
- é¿å…ä½¿ç”¨`componentWillReceiveProps`ï¼›

å…¶å®è¯¥å˜åŠ¨çš„åŸå› ï¼Œæ­£æ˜¯ç”±äºä¸Šè¿°æåˆ°çš„ Fiberã€‚é¦–å…ˆï¼Œä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“ React å¯ä»¥åˆ†æˆ reconciliation ä¸ commit ä¸¤ä¸ªé˜¶æ®µï¼Œå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹:

- **reconciliation**:

  - `componentWillMount`
  - `componentWillReceiveProps`
  - `shouldComponentUpdate`
  - `componentWillUpdate`

- **commit**:
  - `componentDidMount`
  - `componentDidUpdate`
  - `componentWillUnmount`

åœ¨ Fiber ä¸­ï¼Œreconciliation é˜¶æ®µè¿›è¡Œäº†ä»»åŠ¡åˆ†å‰²ï¼Œæ¶‰åŠåˆ° æš‚åœ å’Œ é‡å¯ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¼è‡´ reconciliation ä¸­çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°åœ¨ä¸€æ¬¡æ›´æ–°æ¸²æŸ“å¾ªç¯ä¸­è¢« **å¤šæ¬¡è°ƒç”¨** çš„æƒ…å†µï¼Œäº§ç”Ÿä¸€äº›æ„å¤–é”™è¯¯ã€‚

æ–°ç‰ˆçš„å»ºè®®ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹:

```js
class Component extends React.Component {
  // æ›¿æ¢ `componentWillReceiveProps` ï¼Œ
  // åˆå§‹åŒ–å’Œ update æ—¶è¢«è°ƒç”¨
  // é™æ€å‡½æ•°ï¼Œæ— æ³•ä½¿ç”¨ this
  static getDerivedStateFromProps(nextProps, prevState) {}

  // åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶
  // å¯ä»¥ç”¨äºç»„ä»¶æ€§èƒ½ä¼˜åŒ–
  shouldComponentUpdate(nextProps, nextState) {}

  // ç»„ä»¶è¢«æŒ‚è½½åè§¦å‘
  componentDidMount() {}

  // æ›¿æ¢ componentWillUpdate
  // å¯ä»¥åœ¨æ›´æ–°ä¹‹å‰è·å–æœ€æ–° dom æ•°æ®
  getSnapshotBeforeUpdate() {}

  // ç»„ä»¶æ›´æ–°åè°ƒç”¨
  componentDidUpdate() {}

  // ç»„ä»¶å³å°†é”€æ¯
  componentWillUnmount() {}

  // ç»„ä»¶å·²é”€æ¯
  componentDidUnMount() {}
}
```

- **ä½¿ç”¨å»ºè®®**:

  - åœ¨`constructor`åˆå§‹åŒ– stateï¼›
  - åœ¨`componentDidMount`ä¸­è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œå¹¶åœ¨`componentWillUnmount`ä¸­è§£ç»‘äº‹ä»¶ï¼›
  - åœ¨`componentDidMount`ä¸­è¿›è¡Œæ•°æ®çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨`componentWillMount`ï¼›
  - éœ€è¦æ ¹æ® props æ›´æ–° state æ—¶ï¼Œä½¿ç”¨`getDerivedStateFromProps(nextProps, prevState)`ï¼›
    - æ—§ props éœ€è¦è‡ªå·±å­˜å‚¨ï¼Œä»¥ä¾¿æ¯”è¾ƒï¼›

  ```js
  public static getDerivedStateFromProps(nextProps, prevState) {
    // å½“æ–° props ä¸­çš„ data å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒåŒæ­¥æ›´æ–°åˆ° state ä¸Š
    if (nextProps.data !== prevState.data) {
      return {
        data: nextProps.data
      }
    } else {
      return null1
    }
    }
  ```

  - å¯ä»¥åœ¨`componentDidUpdate`ç›‘å¬ props æˆ–è€… state çš„å˜åŒ–ï¼Œä¾‹å¦‚:

  ```js
  componentDidUpdate(prevProps) {
    // å½“ id å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°è·å–æ•°æ®
    if (this.props.id !== prevProps.id) {
      this.fetchData(this.props.id);
    }
  }
  ```

  - åœ¨`componentDidUpdate`ä½¿ç”¨`setState`æ—¶ï¼Œå¿…é¡»åŠ æ¡ä»¶ï¼Œå¦åˆ™å°†è¿›å…¥æ­»å¾ªç¯ï¼›
  - `getSnapshotBeforeUpdate(prevProps, prevState)`å¯ä»¥åœ¨æ›´æ–°ä¹‹å‰è·å–æœ€æ–°çš„æ¸²æŸ“æ•°æ®ï¼Œå®ƒçš„è°ƒç”¨æ˜¯åœ¨ render ä¹‹åï¼Œ mounted ä¹‹å‰ï¼›
  - `shouldComponentUpdate`: é»˜è®¤æ¯æ¬¡è°ƒç”¨`setState`ï¼Œä¸€å®šä¼šæœ€ç»ˆèµ°åˆ° diff é˜¶æ®µï¼Œä½†å¯ä»¥é€šè¿‡`shouldComponentUpdate`çš„ç”Ÿå‘½é’©å­è¿”å›`false`æ¥ç›´æ¥é˜»æ­¢åé¢çš„é€»è¾‘æ‰§è¡Œï¼Œé€šå¸¸æ˜¯ç”¨äºåšæ¡ä»¶æ¸²æŸ“ï¼Œä¼˜åŒ–æ¸²æŸ“çš„æ€§èƒ½ã€‚

## æ¸²æŸ“æœºåˆ¶

### key

> key æ˜¯ç»™æ¯ä¸€ä¸ª vnode çš„å”¯ä¸€ id,å¯ä»¥ä¾é  key,æ›´å‡†ç¡®, æ›´å¿«çš„æ‹¿åˆ° oldVnode ä¸­å¯¹åº”çš„ vnode èŠ‚ç‚¹ã€‚

1. æ›´å‡†ç¡®
   å› ä¸ºå¸¦ key å°±ä¸æ˜¯å°±åœ°å¤ç”¨äº†ï¼Œåœ¨ sameNode å‡½æ•° a.key === b.key å¯¹æ¯”ä¸­å¯ä»¥é¿å…å°±åœ°å¤ç”¨çš„æƒ…å†µã€‚æ‰€ä»¥ä¼šæ›´åŠ å‡†ç¡®ã€‚

2. æ›´å¿«
   åˆ©ç”¨ key çš„å”¯ä¸€æ€§ç”Ÿæˆ map å¯¹è±¡æ¥è·å–å¯¹åº”èŠ‚ç‚¹ï¼Œæ¯”éå†æ–¹å¼æ›´å¿«ã€‚(è¿™ä¸ªè§‚ç‚¹ï¼Œå°±æ˜¯æˆ‘æœ€åˆçš„é‚£ä¸ªè§‚ç‚¹ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œmap ä¼šæ¯”éå†æ›´å¿«ã€‚)

### setState

åœ¨äº†è§£`setState`ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸‹ React ä¸€ä¸ªåŒ…è£…ç»“æ„: **Transaction**:

- **äº‹åŠ¡** (Transaction):
  - æ˜¯ React ä¸­çš„ä¸€ä¸ªè°ƒç”¨ç»“æ„ï¼Œç”¨äºåŒ…è£…ä¸€ä¸ªæ–¹æ³•ï¼Œç»“æ„ä¸º: **initialize - perform(method) - close**ã€‚é€šè¿‡äº‹åŠ¡ï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†ä¸€ä¸ªæ–¹æ³•çš„å¼€å§‹ä¸ç»“æŸï¼›å¤„äºäº‹åŠ¡æµä¸­ï¼Œè¡¨ç¤ºè¿›ç¨‹æ­£åœ¨æ‰§è¡Œä¸€äº›æ“ä½œï¼›

<img width="750" src="https://raw.githubusercontent.com/xd-tayde/blog/master/images/interview/7.png">

- `setState`: React ä¸­ç”¨äºä¿®æ”¹çŠ¶æ€ï¼Œæ›´æ–°è§†å›¾ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:

- **å¼‚æ­¥ä¸åŒæ­¥**: `setState`å¹¶ä¸æ˜¯å•çº¯çš„å¼‚æ­¥æˆ–åŒæ­¥ï¼Œè¿™å…¶å®ä¸è°ƒç”¨æ—¶çš„ç¯å¢ƒç›¸å…³:

  - åœ¨ **åˆæˆäº‹ä»¶** å’Œ **ç”Ÿå‘½å‘¨æœŸé’©å­(é™¤ componentDidUpdate)** ä¸­ï¼Œ`setState`æ˜¯"å¼‚æ­¥"çš„ï¼›
    - **åŸå› **: å› ä¸ºåœ¨`setState`çš„å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªåˆ¤æ–­: å½“æ›´æ–°ç­–ç•¥æ­£åœ¨äº‹åŠ¡æµçš„æ‰§è¡Œä¸­æ—¶ï¼Œè¯¥ç»„ä»¶æ›´æ–°ä¼šè¢«æ¨å…¥`dirtyComponents`é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼›å¦åˆ™ï¼Œå¼€å§‹æ‰§è¡Œ`batchedUpdates`é˜Ÿåˆ—æ›´æ–°ï¼›
      - åœ¨ç”Ÿå‘½å‘¨æœŸé’©å­è°ƒç”¨ä¸­ï¼Œæ›´æ–°ç­–ç•¥éƒ½å¤„äºæ›´æ–°ä¹‹å‰ï¼Œç»„ä»¶ä»å¤„äºäº‹åŠ¡æµä¸­ï¼Œè€Œ`componentDidUpdate`æ˜¯åœ¨æ›´æ–°ä¹‹åï¼Œæ­¤æ—¶ç»„ä»¶å·²ç»ä¸åœ¨äº‹åŠ¡æµä¸­äº†ï¼Œå› æ­¤åˆ™ä¼šåŒæ­¥æ‰§è¡Œï¼›
      - åœ¨åˆæˆäº‹ä»¶ä¸­ï¼ŒReact æ˜¯åŸºäº **äº‹åŠ¡æµå®Œæˆçš„äº‹ä»¶å§”æ‰˜æœºåˆ¶** å®ç°ï¼Œä¹Ÿæ˜¯å¤„äºäº‹åŠ¡æµä¸­ï¼›
    - **é—®é¢˜**: æ— æ³•åœ¨`setState`åé©¬ä¸Šä»`this.state`ä¸Šè·å–æ›´æ–°åçš„å€¼ã€‚
    - **è§£å†³**: å¦‚æœéœ€è¦é©¬ä¸ŠåŒæ­¥å»è·å–æ–°å€¼ï¼Œ`setState`å…¶å®æ˜¯å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°çš„ã€‚`setState(updater, callback)`ï¼Œåœ¨å›è°ƒä¸­å³å¯è·å–æœ€æ–°å€¼ï¼›
  - åœ¨ **åŸç”Ÿäº‹ä»¶** å’Œ **setTimeout** ä¸­ï¼Œ`setState`æ˜¯åŒæ­¥çš„ï¼Œå¯ä»¥é©¬ä¸Šè·å–æ›´æ–°åçš„å€¼ï¼›
    - åŸå› : åŸç”Ÿäº‹ä»¶æ˜¯æµè§ˆå™¨æœ¬èº«çš„å®ç°ï¼Œä¸äº‹åŠ¡æµæ— å…³ï¼Œè‡ªç„¶æ˜¯åŒæ­¥ï¼›è€Œ`setTimeout`æ˜¯æ”¾ç½®äºå®šæ—¶å™¨çº¿ç¨‹ä¸­å»¶åæ‰§è¡Œï¼Œæ­¤æ—¶äº‹åŠ¡æµå·²ç»“æŸï¼Œå› æ­¤ä¹Ÿæ˜¯åŒæ­¥ï¼›

- **æ‰¹é‡æ›´æ–°**: åœ¨ **åˆæˆäº‹ä»¶** å’Œ **ç”Ÿå‘½å‘¨æœŸé’©å­** ä¸­ï¼Œ`setState`æ›´æ–°é˜Ÿåˆ—æ—¶ï¼Œå­˜å‚¨çš„æ˜¯ **åˆå¹¶çŠ¶æ€**(`Object.assign`)ã€‚å› æ­¤å‰é¢è®¾ç½®çš„ key å€¼ä¼šè¢«åé¢æ‰€è¦†ç›–ï¼Œæœ€ç»ˆåªä¼šæ‰§è¡Œä¸€æ¬¡æ›´æ–°ï¼›

- **å‡½æ•°å¼**: ç”±äº Fiber åŠ åˆå¹¶ çš„é—®é¢˜ï¼Œå®˜æ–¹æ¨èå¯ä»¥ä¼ å…¥ **å‡½æ•°** çš„å½¢å¼ã€‚`setState(fn)`ï¼Œåœ¨`fn`ä¸­è¿”å›æ–°çš„`state`å¯¹è±¡å³å¯ï¼Œä¾‹å¦‚`this.state((state, props) => newState)ï¼›`

  - ä½¿ç”¨å‡½æ•°å¼ï¼Œå¯ä»¥ç”¨äºé¿å…`setState`çš„æ‰¹é‡æ›´æ–°çš„é€»è¾‘ï¼Œä¼ å…¥çš„å‡½æ•°å°†ä¼šè¢« **é¡ºåºè°ƒç”¨**ï¼›

- **æ³¨æ„äº‹é¡¹**:
  - setState åˆå¹¶ï¼Œåœ¨ åˆæˆäº‹ä»¶ å’Œ ç”Ÿå‘½å‘¨æœŸé’©å­ ä¸­å¤šæ¬¡è¿ç»­è°ƒç”¨ä¼šè¢«ä¼˜åŒ–ä¸ºä¸€æ¬¡ï¼›
  - å½“ç»„ä»¶å·²è¢«é”€æ¯ï¼Œå¦‚æœå†æ¬¡è°ƒç”¨`setState`ï¼ŒReact ä¼šæŠ¥é”™è­¦å‘Šï¼Œé€šå¸¸æœ‰ä¸¤ç§è§£å†³åŠæ³•:
    - å°†æ•°æ®æŒ‚è½½åˆ°å¤–éƒ¨ï¼Œé€šè¿‡ props ä¼ å…¥ï¼Œå¦‚æ”¾åˆ° Redux æˆ– çˆ¶çº§ä¸­ï¼›
    - åœ¨ç»„ä»¶å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€é‡ (isUnmounted)ï¼Œ`componentWillUnmount`ä¸­æ ‡è®°ä¸º trueï¼Œåœ¨`setState`å‰è¿›è¡Œåˆ¤æ–­ï¼›

### forceUpdate

å¼ºåˆ¶Reactç»„ä»¶æ¸²æŸ“çš„æ–¹æ³•æœ‰å¤šç§ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ã€‚ é¦–å…ˆæ˜¯ä½¿ç”¨this.forceUpdate() ï¼Œå®ƒä¼šè·³è¿‡shouldComponentUpdate

```js
someMethod() {
  // Force a render without state change...
  this.forceUpdate();
}
```

## äº‹ä»¶æœºåˆ¶

- Reactäº‹ä»¶æ˜¯åˆæˆäº‹ä»¶
- æœ‰stopPropagationå’ŒpreventDefault
- æœ‰nativeEventä¸Šçš„æ‰€æœ‰å±æ€§
- å¯ä»¥é€šè¿‡nativeEventè·å–åˆ°åŸç”Ÿäº‹ä»¶
- è·¨æµè§ˆå™¨å…¼å®¹

### äº‹ä»¶ä»£ç†

é¦–å…ˆå›é¡¾ä»¥ä¸‹åŸç”Ÿäº‹ä»¶çš„ä¸¤ä¸ªæ–¹æ³•ï¼š`event.stopImmediatePropagation` å’Œ `event.stopPropagation` ï¼Œå‰è€…å¯ä»¥é˜»æ­¢åŒä¸€ dom ä¸Šçš„åç»­äº‹ä»¶çš„æ‰§è¡Œä»¥åŠé˜»æ­¢å†’æ³¡ï¼Œåè€…ä»…èƒ½é˜»æ­¢å†’æ³¡ã€‚

åœ¨ react å†…é€šè¿‡ onClick ç»‘å®šçš„äº‹ä»¶ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰æŠŠç‚¹å‡»äº‹ä»¶ç»‘å®šåˆ°å¯¹åº”çš„å…ƒç´ ä¸Šï¼Œè€Œæ˜¯ç»Ÿä¸€æ”¾åˆ°äº† document ä¸Šå¤„ç†ã€‚ç‚¹å‡»ä¸€ä¸ªå…ƒç´ ï¼Œé¦–å…ˆè§¦å‘è¿™ä¸ªå…ƒç´ çš„åŸç”Ÿç»‘å®šäº‹ä»¶ï¼ˆè¿™é‡Œä¸è®¨è®ºæ•è·ï¼‰ï¼Œæ¥ç€äº‹ä»¶å†’æ³¡ï¼Œåˆ°äº† document ä¸Šï¼Œå…ˆè§¦å‘ dispatchï¼Œå³åˆ†å‘ react çš„åˆæˆäº‹ä»¶ï¼Œè¿™ä¸ªè§¦å‘è¿‡ç¨‹ä¹Ÿæ˜¯å’Œå†’æ³¡ç±»ä¼¼ï¼Œä»é‡Œå‘å¤–çš„ã€‚

dispatch ç»“æŸåï¼Œè§¦å‘ document ä¸Šå‰©ä½™çš„åŸç”Ÿäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è®¤ä¸º dispatch æ˜¯ document ä¸Šçš„ç¬¬ä¸€ä¸ªåŸç”Ÿç»‘å®šäº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶å†…è¿›è¡Œ react åˆæˆäº‹ä»¶çš„åˆ†å‘ã€‚

åŸç”Ÿç»‘å®šçš„å›è°ƒäº‹ä»¶ä¸­è·å–åˆ°çš„æ˜¯åŸç”Ÿäº‹ä»¶ã€‚é€šè¿‡ react åœ¨ jsx å†… onClick ç»‘å®šçš„å›è°ƒäº‹ä»¶ä¸­è·å–åˆ°çš„æ˜¯åˆæˆäº‹ä»¶ã€‚

å¦‚æœä½ æœ‰è¯•è¿‡è¾“å‡º react äº‹ä»¶ä¸­çš„ eventï¼Œä½ å°±ä¼šå‘ç°è¿™ä¸ª event å¥½åƒå’Œæˆ‘ä»¬çœ‹åˆ°çš„ dom äº‹ä»¶ä¸­çš„ event ä¸å¤ªä¸€æ ·ï¼Œé‚£æ˜¯å› ä¸º react åœ¨è¿›è¡Œ dom äº‹ä»¶ç»‘å®šæ—¶ï¼Œä¸æ˜¯ç›´æ¥ç»‘å®šäº‹ä»¶çš„ï¼Œè€Œæ˜¯é€šè¿‡æ‰€è°“çš„åˆæˆäº‹ä»¶(SyntheticEvent)è¿›è¡Œå§”æ‰˜ç®¡ç†çš„ï¼Œå®ƒæ˜¯åŸç”Ÿäº‹ä»¶è¿›è¡Œå°è£…åçš„ç»“æœï¼Œä½ å¯ä»¥é€šè¿‡ nativeEvent è·å–åŸç”Ÿäº‹ä»¶ã€‚

```jsx
import React, { Component } from "react";
class App extends Component {
  componentDidMount() {
    document.addEventListener("click", function() {
      console.log("document click");
    });
    document
      .getElementsByClassName("App")[0]
      .addEventListener("click", function() {
        console.log("app click");
      });
    document
      .getElementsByTagName("button")[0]
      .addEventListener("click", function(e) {
        console.log("button click");
        // e.stopPropagation();
      });
  }
  onClick = (e) => {
    e.preventDefault(); // é˜»æ­¢å…¨éƒ¨
    e.stopPropagation(); // èƒ½å¤Ÿé˜»æ­¢div.appçš„è§¦å‘
    e.nativeEvent.stopImmediatePropagation(); // èƒ½å¤Ÿé˜»æ­¢documentçš„è§¦å‘
    e.nativeEvent.stopPropagation(); // ä»€ä¹ˆéƒ½é˜»æ­¢ä¸äº†
    console.log("react button click");
  };
  render() {
    return (
      <div
        className="App"
        onClick={() => {
          console.log("react app click");
        }}
      >
        æ‰“å¼€æ§åˆ¶å°ï¼Œç‚¹å‡» <button onClick={this.onClick}>æŒ‰é’®</button>
      </div>
    );
  }
}
export default App;
```

### äº‹ä»¶ This ç»‘å®š

1. bind
   å¦‚æœä¸€ä¸ªäº‹ä»¶åªä¼šè¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œåˆ™ä½¿ç”¨ bind è¿›è¡Œç»‘å®šæ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼š

```js
onClick = { this.clickHandle.bind(this,[other params]) }
```

2. æ„é€ å‡½æ•°ä¸­ç»‘å®š
   å¦‚æœä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°å¯èƒ½ä¼šå¤šæ¬¡ç»‘å®šï¼Œåˆ™ä½¿ç”¨æ„é€ å‡½æ•°ä¸­ç»‘å®šä¸€æ¬¡å³å¯.

åœ¨ JSX ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ `onClick = { this.clickHandle }` ç»‘å®šäº‹ä»¶

```js
constructor(props){
  super(props);

  this.clickHandle = this.handleClick.bind(this);

  render() {
    return <button onClick = { this.handleClick }>click</button>;
  }
}
```

3. ç®­å¤´å‡½æ•°

ç®­å¤´å‡½æ•°çš„ç‰¹ç‚¹æ˜¯ï¼Œ èƒ½å¤Ÿè‡ªåŠ¨ç»‘å®šå®šä¹‰æ­¤å‡½æ•°ä½œç”¨åŸŸçš„ this ã€‚

ç®­å¤´å‡½æ•°è„±ç¦»ä¸äº†å‡½æ•°è¿™ä¸ªèŒƒå›´ï¼Œå› æ­¤å…¶ this æŒ‡å‘ä¾æ—§æ˜¯æœ€ç»ˆè°ƒç”¨è¯¥å‡½æ•°çš„ä½œç”¨åŸŸ thisã€‚ï¼ˆè¿™å¥è¯æ˜¯å¦æ­£ç¡®æˆ–è€…åˆç†ç›®å‰ä¸ªäººå¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šï¼‰

æ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªç‰¹æ€§å®ç°ç»‘å®šã€‚

```js
onClick={ () => this.handleClick() }
```

## ç»„ä»¶å¤ç”¨
### HOC(é«˜é˜¶ç»„ä»¶)

HOC(Higher Order Componennt) æ˜¯åœ¨ React æœºåˆ¶ä¸‹ç¤¾åŒºå½¢æˆçš„ä¸€ç§ç»„ä»¶æ¨¡å¼ï¼Œåœ¨å¾ˆå¤šç¬¬ä¸‰æ–¹å¼€æºåº“ä¸­è¡¨ç°å¼ºå¤§ã€‚

- **ç®€è¿°**:

  - é«˜é˜¶ç»„ä»¶ä¸æ˜¯ç»„ä»¶ï¼Œæ˜¯ **å¢å¼ºå‡½æ•°**ï¼Œå¯ä»¥è¾“å…¥ä¸€ä¸ªå…ƒç»„ä»¶ï¼Œè¿”å›å‡ºä¸€ä¸ªæ–°çš„å¢å¼ºç»„ä»¶ï¼›
  - é«˜é˜¶ç»„ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯ **ä»£ç å¤ç”¨**ï¼Œ**æ“ä½œ** çŠ¶æ€å’Œå‚æ•°ï¼›

- **ç”¨æ³•**:

  - **å±æ€§ä»£ç† (Props Proxy)**: è¿”å›å‡ºä¸€ä¸ªç»„ä»¶ï¼Œå®ƒåŸºäºè¢«åŒ…è£¹ç»„ä»¶è¿›è¡Œ **åŠŸèƒ½å¢å¼º**ï¼›

    - **é»˜è®¤å‚æ•°**: å¯ä»¥ä¸ºç»„ä»¶åŒ…è£¹ä¸€å±‚é»˜è®¤å‚æ•°ï¼›

    ```js
    function proxyHoc(Comp) {
      return class extends React.Component {
        render() {
          const newProps = {
            name: "tayde",
            age: 1,
          };
          return <Comp {...this.props} {...newProps} />;
        }
      };
    }
    ```

    - **æå–çŠ¶æ€**: å¯ä»¥é€šè¿‡ props å°†è¢«åŒ…è£¹ç»„ä»¶ä¸­çš„ state ä¾èµ–å¤–å±‚ï¼Œä¾‹å¦‚ç”¨äºè½¬æ¢å—æ§ç»„ä»¶:

    ```js
    function withOnChange(Comp) {
      return class extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            name: "",
          };
        }
        onChangeName = () => {
          this.setState({
            name: "dongdong",
          });
        };
        render() {
          const newProps = {
            value: this.state.name,
            onChange: this.onChangeName,
          };
          return <Comp {...this.props} {...newProps} />;
        }
      };
    }
    ```

    ä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ï¼Œè¿™æ ·å°±èƒ½éå¸¸å¿«é€Ÿçš„å°†ä¸€ä¸ª `Input` ç»„ä»¶è½¬åŒ–æˆå—æ§ç»„ä»¶ã€‚

    ```js
    const NameInput = (props) => <input name="name" {...props} />;
    export default withOnChange(NameInput);
    ```

    - **åŒ…è£¹ç»„ä»¶**: å¯ä»¥ä¸ºè¢«åŒ…è£¹å…ƒç´ è¿›è¡Œä¸€å±‚åŒ…è£…ï¼Œ

    ```js
    function withMask(Comp) {
      return class extends React.Component {
        render() {
          return (
            <div>
              <Comp {...this.props} />
              <div style={{
                width: '100%',
                height: '100%',
                backgroundColor: 'rgba(0, 0, 0, .6)',
              }}
            </div>
          )
        }
      }
    }
    ```

  - **åå‘ç»§æ‰¿** (Inheritance Inversion): è¿”å›å‡ºä¸€ä¸ªç»„ä»¶ï¼Œ**ç»§æ‰¿äºè¢«åŒ…è£¹ç»„ä»¶**ï¼Œå¸¸ç”¨äºä»¥ä¸‹æ“ä½œ:

    ```js
    function IIHoc(Comp) {
      return class extends Comp {
        render() {
          return super.render();
        }
      };
    }
    ```

    - **æ¸²æŸ“åŠ«æŒ** (Render Highjacking)

      - **æ¡ä»¶æ¸²æŸ“**: æ ¹æ®æ¡ä»¶ï¼Œæ¸²æŸ“ä¸åŒçš„ç»„ä»¶

      ```js
      function withLoading(Comp) {
        return class extends Comp {
          render() {
            if (this.props.isLoading) {
              return <Loading />;
            } else {
              return super.render();
            }
          }
        };
      }
      ```

      - å¯ä»¥ç›´æ¥ä¿®æ”¹è¢«åŒ…è£¹ç»„ä»¶æ¸²æŸ“å‡ºçš„ React å…ƒç´ æ ‘

    - **æ“ä½œçŠ¶æ€** (Operate State): å¯ä»¥ç›´æ¥é€šè¿‡ `this.state` è·å–åˆ°è¢«åŒ…è£¹ç»„ä»¶çš„çŠ¶æ€ï¼Œå¹¶è¿›è¡Œæ“ä½œã€‚ä½†è¿™æ ·çš„æ“ä½œå®¹æ˜“ä½¿ state å˜å¾—éš¾ä»¥è¿½è¸ªï¼Œä¸æ˜“ç»´æŠ¤ï¼Œè°¨æ…ä½¿ç”¨ã€‚

- **åº”ç”¨åœºæ™¯**:

  - **æƒé™æ§åˆ¶**ï¼Œé€šè¿‡æŠ½è±¡é€»è¾‘ï¼Œç»Ÿä¸€å¯¹é¡µé¢è¿›è¡Œæƒé™åˆ¤æ–­ï¼ŒæŒ‰ä¸åŒçš„æ¡ä»¶è¿›è¡Œé¡µé¢æ¸²æŸ“:

  ```js
  function withAdminAuth(WrappedComponent) {
    return class extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          isAdmin: false,
        };
      }
      async componentWillMount() {
        const currentRole = await getCurrentUserRole();
        this.setState({
          isAdmin: currentRole === "Admin",
        });
      }
      render() {
        if (this.state.isAdmin) {
          return <Comp {...this.props} />;
        } else {
          return <div>æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹è¯¥é¡µé¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼</div>;
        }
      }
    };
  }
  ```

  - **æ€§èƒ½ç›‘æ§**ï¼ŒåŒ…è£¹ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿›è¡Œç»Ÿä¸€åŸ‹ç‚¹:

  ```js
  function withTiming(Comp) {
      return class extends Comp {
          constructor(props) {
              super(props);
              this.start = Date.now();
              this.end = 0;
          }
          componentDidMount() {
              super.componentDidMount && super.componentDidMount();
              this.end = Date.now();
              console.log(`${WrappedComponent.name} ç»„ä»¶æ¸²æŸ“æ—¶é—´ä¸º ${this.end - this.start} ms`);
          }
          render() {
              return super.render();
          }
      };
  }
  ```

  - **ä»£ç å¤ç”¨**ï¼Œå¯ä»¥å°†é‡å¤çš„é€»è¾‘è¿›è¡ŒæŠ½è±¡ã€‚

- ä½¿ç”¨æ³¨æ„:

  - 1. **çº¯å‡½æ•°**: å¢å¼ºå‡½æ•°åº”ä¸ºçº¯å‡½æ•°ï¼Œé¿å…ä¾µå…¥ä¿®æ”¹å…ƒç»„ä»¶ï¼›
  - 2. **é¿å…ç”¨æ³•æ±¡æŸ“**: ç†æƒ³çŠ¶æ€ä¸‹ï¼Œåº”é€ä¼ å…ƒç»„ä»¶çš„æ— å…³å‚æ•°ä¸äº‹ä»¶ï¼Œå°½é‡ä¿è¯ç”¨æ³•ä¸å˜ï¼›
  - 3. **å‘½åç©ºé—´**: ä¸º HOC å¢åŠ ç‰¹å¼‚æ€§çš„ç»„ä»¶åç§°ï¼Œè¿™æ ·èƒ½ä¾¿äºå¼€å‘è°ƒè¯•å’ŒæŸ¥æ‰¾é—®é¢˜ï¼›
  - 4. **å¼•ç”¨ä¼ é€’**: å¦‚æœéœ€è¦ä¼ é€’å…ƒç»„ä»¶çš„ refs å¼•ç”¨ï¼Œå¯ä»¥ä½¿ç”¨`React.forwardRef`ï¼›
  - 5. **é™æ€æ–¹æ³•**: å…ƒç»„ä»¶ä¸Šçš„é™æ€æ–¹æ³•å¹¶æ— æ³•è¢«è‡ªåŠ¨ä¼ å‡ºï¼Œä¼šå¯¼è‡´ä¸šåŠ¡å±‚æ— æ³•è°ƒç”¨ï¼›è§£å†³:
    - å‡½æ•°å¯¼å‡º
    - é™æ€æ–¹æ³•èµ‹å€¼
  - 6. **é‡æ–°æ¸²æŸ“**: ç”±äºå¢å¼ºå‡½æ•°æ¯æ¬¡è°ƒç”¨æ˜¯è¿”å›ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œå› æ­¤å¦‚æœåœ¨ Render ä¸­ä½¿ç”¨å¢å¼ºå‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´æ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“æ•´ä¸ª HOCï¼Œè€Œä¸”ä¹‹å‰çš„çŠ¶æ€ä¼šä¸¢å¤±ï¼›

### RenderProps

åœ¨è°ƒç”¨ç»„ä»¶æ—¶ï¼Œå¼•å…¥ä¸€ä¸ªå‡½æ•°ç±»å‹çš„ propï¼Œè¿™ä¸ª prop å®šä¹‰äº†ç»„ä»¶çš„æ¸²æŸ“æ–¹å¼ã€‚

è€Œ render props æœ¬è´¨å®é™…ä¸Šæ˜¯ä½¿ç”¨åˆ°äº†å›è°ƒçš„æ–¹å¼æ¥é€šä¿¡ã€‚åªä¸è¿‡åœ¨ä¼ ç»Ÿçš„ js å›è°ƒæ˜¯åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼ˆä½¿ç”¨å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼‰ï¼Œè€Œåœ¨ react ä¸­ï¼Œç°åœ¨å¯ä»¥é€šè¿‡ props ä¼ å…¥è¯¥å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€ä»‹ç»çš„ render propã€‚

å›è°ƒçš„ç›®çš„æ˜¯æ¸²æŸ“å­ç»„ä»¶ï¼Œè€Œæ¸²æŸ“çš„å¤–éƒ¨ç»†èŠ‚éœ€è¦é€šè¿‡çˆ¶ç»„ä»¶æ³¨å…¥ï¼Œå®ç°äº†æ§åˆ¶åè½¬ã€‚

<code src='./react-app/RenderProps.jsx'>

## é€šä¿¡æœºåˆ¶

ç»„ä»¶é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’ï¼ˆé€šä¿¡ï¼‰ï¼Œç»„ä»¶é—´é€šä¿¡å¤§ä½“æœ‰ä¸‹é¢å‡ ç§æƒ…å†µï¼š

- çˆ¶ç»„ä»¶å‘å­ç»„ä»¶é€šä¿¡
- å­ç»„ä»¶å‘çˆ¶ç»„ä»¶é€šä¿¡
- å…„å¼Ÿç»„ä»¶é€šä¿¡
- è·¨çº§ç»„ä»¶ä¹‹é—´é€šä¿¡
- éåµŒå¥—ç»„ä»¶é—´é€šä¿¡

### Props

ç®€å•çš„çˆ¶å­ï¼Œå…„å¼Ÿä¹‹é—´çš„é€šä¿¡ç”¨`Props`ä¼ å€¼ï¼Œç”¨`Callback`è¿›è¡Œå›è°ƒèµ‹å€¼

### EventBus

ä½œä¸ºä¸­é—´ä»‹å­è¿›è¡Œäº‹ä»¶æ±‡æ€»åŠå‘å¸ƒï¼Œå‚è€ƒ[å‘å¸ƒè®¢é˜…æ¨¡å¼](/guide/common/è®¾è®¡æ¨¡å¼#å‘å¸ƒè®¢é˜…æ¨¡å¼)

### Context

`Context` é€šè¿‡ç»„ä»¶æ ‘æä¾›äº†ä¸€ä¸ªä¼ é€’æ•°æ®çš„æ–¹æ³•ï¼Œä»è€Œé¿å…äº†åœ¨æ¯ä¸€ä¸ªå±‚çº§æ‰‹åŠ¨çš„ä¼ é€’ `props` å±æ€§ã€‚Reduxå°±æ˜¯é€šè¿‡è¿™ä¸ªæ–¹å¼æ³¨å…¥

```js
// React.createContextï¼šåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡çš„å®¹å™¨(ç»„ä»¶), defaultValueå¯ä»¥è®¾ç½®å…±äº«çš„é»˜è®¤æ•°æ®
const {Provider, Consumer} = React.createContext(defaultValue);
// Provider(ç”Ÿäº§è€…): ç”¨äºç”Ÿäº§å…±äº«æ•°æ®çš„åœ°æ–¹ã€‚value:æ”¾ç½®å…±äº«çš„æ•°æ®
<Provider value={/*å…±äº«çš„æ•°æ®*/}>
    /*é‡Œé¢å¯ä»¥æ¸²æŸ“å¯¹åº”çš„å†…å®¹*/
</Provider>
// Consumer(æ¶ˆè´¹è€…): æ¶ˆè´¹ä¾›åº”å•†(Provider ä¸Šé¢æåˆ°çš„)äº§ç”Ÿæ•°æ®ã€‚Consumeréœ€è¦åµŒå¥—åœ¨ç”Ÿäº§è€…ä¸‹é¢ã€‚æ‰èƒ½é€šè¿‡å›è°ƒçš„æ–¹å¼æ‹¿åˆ°å…±äº«çš„æ•°æ®æºã€‚å½“ç„¶ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œé‚£å°±åªèƒ½æ¶ˆè´¹åˆ°ä¸Šæ–‡æåˆ°çš„defaultValue
<Consumer>
  {value => /*æ ¹æ®ä¸Šä¸‹æ–‡  è¿›è¡Œæ¸²æŸ“ç›¸åº”å†…å®¹*/}
</Consumer>
```


## Hooks

`React` ä¸­é€šå¸¸ä½¿ç”¨ **ç±»å®šä¹‰** æˆ–è€… **å‡½æ•°å®šä¹‰** åˆ›å»ºç»„ä»¶:

åœ¨ç±»å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ°è®¸å¤š `React` ç‰¹æ€§ï¼Œä¾‹å¦‚ `state`ã€ å„ç§ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­ç­‰ï¼Œä½†æ˜¯åœ¨å‡½æ•°å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å´æ— èƒ½ä¸ºåŠ›ï¼Œå› æ­¤ `React 16.8` ç‰ˆæœ¬æ¨å‡ºäº†ä¸€ä¸ªæ–°åŠŸèƒ½ (`React Hooks)`ï¼Œé€šè¿‡å®ƒï¼Œå¯ä»¥æ›´å¥½çš„åœ¨å‡½æ•°å®šä¹‰ç»„ä»¶ä¸­ä½¿ç”¨ `React` ç‰¹æ€§ã€‚

### ä¼˜ç¼ºç‚¹

1. **è·¨ç»„ä»¶å¤ç”¨**: å…¶å® `render props` / `HOC` ä¹Ÿæ˜¯ä¸ºäº†å¤ç”¨ï¼Œç›¸æ¯”äºå®ƒä»¬ï¼Œ`Hooks` ä½œä¸ºå®˜æ–¹çš„åº•å±‚ `API`ï¼Œæœ€ä¸ºè½»é‡ï¼Œè€Œä¸”æ”¹é€ æˆæœ¬å°ï¼Œä¸ä¼šå½±å“åŸæ¥çš„ç»„ä»¶å±‚æ¬¡ç»“æ„å’Œä¼ è¯´ä¸­çš„åµŒå¥—åœ°ç‹±ï¼›
2. **ç±»å®šä¹‰æ›´ä¸ºå¤æ‚**:
  - ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸä¼šä½¿é€»è¾‘å˜å¾—åˆ†æ•£ä¸”æ··ä¹±ï¼Œä¸æ˜“ç»´æŠ¤å’Œç®¡ç†ï¼›
  - æ—¶åˆ»éœ€è¦å…³æ³¨`this`çš„æŒ‡å‘é—®é¢˜ï¼›
  - ä»£ç å¤ç”¨ä»£ä»·é«˜ï¼Œé«˜é˜¶ç»„ä»¶çš„ä½¿ç”¨ç»å¸¸ä¼šä½¿æ•´ä¸ªç»„ä»¶æ ‘å˜å¾—è‡ƒè‚¿ï¼›
3. **çŠ¶æ€ä¸ UI éš”ç¦»**: æ­£æ˜¯ç”±äº Hooks çš„ç‰¹æ€§ï¼ŒçŠ¶æ€é€»è¾‘ä¼šå˜æˆæ›´å°çš„ç²’åº¦ï¼Œå¹¶ä¸”æå®¹æ˜“è¢«æŠ½è±¡æˆä¸€ä¸ªè‡ªå®šä¹‰ Hooksï¼Œç»„ä»¶ä¸­çš„çŠ¶æ€å’Œ UI å˜å¾—æ›´ä¸ºæ¸…æ™°å’Œéš”ç¦»ã€‚
4. **ä»£ç æ¸…çˆ½é‡å°‘**: å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ï¼Œå‡½æ•°å¼ç»„ä»¶ã€çŠ¶æ€ä¿å­˜åœ¨è¿è¡Œç¯å¢ƒã€æ¯ä¸ªåŠŸèƒ½éƒ½åŒ…è£¹åœ¨å‡½æ•°ä¸­ï¼Œæ•´ä½“é£æ ¼æ›´æ¸…çˆ½ï¼Œæ›´ä¼˜é›…

### æ³¨æ„äº‹é¡¹

- é¿å…åœ¨ å¾ªç¯/æ¡ä»¶åˆ¤æ–­/åµŒå¥—å‡½æ•° ä¸­è°ƒç”¨ hooksï¼Œä¿è¯è°ƒç”¨é¡ºåºçš„ç¨³å®šï¼›
- åªæœ‰ å‡½æ•°å®šä¹‰ç»„ä»¶ å’Œ hooks å¯ä»¥è°ƒç”¨ hooksï¼Œé¿å…åœ¨ ç±»ç»„ä»¶ æˆ–è€… æ™®é€šå‡½æ•° ä¸­è°ƒç”¨ï¼›
- ä¸èƒ½åœ¨`useEffect`ä¸­ä½¿ç”¨`useState`ï¼ŒReact ä¼šæŠ¥é”™æç¤ºï¼›
- ç±»ç»„ä»¶ä¸ä¼šè¢«æ›¿æ¢æˆ–åºŸå¼ƒï¼Œä¸éœ€è¦å¼ºåˆ¶æ”¹é€ ç±»ç»„ä»¶ï¼Œä¸¤ç§æ–¹å¼èƒ½å¹¶å­˜ï¼›

### çŠ¶æ€é’©å­(`useState`)

ç”¨äºå®šä¹‰ç»„ä»¶çš„ Stateï¼Œå…¶åˆ°ç±»å®šä¹‰ä¸­`this.state`çš„åŠŸèƒ½ï¼›

```js
// useState åªæ¥å—ä¸€ä¸ªå‚æ•°: åˆå§‹çŠ¶æ€
// è¿”å›çš„æ˜¯ç»„ä»¶åå’Œæ›´æ”¹è¯¥ç»„ä»¶å¯¹åº”çš„å‡½æ•°
const [flag, setFlag] = useState(true);
// ä¿®æ”¹çŠ¶æ€
setFlag(false);

// ä¸Šé¢çš„ä»£ç æ˜ å°„åˆ°ç±»å®šä¹‰ä¸­:
this.state = {
  flag: true,
};
const flag = this.state.flag;
const setFlag = (bool) => {
  this.setState({
    flag: bool,
  });
};
```

### ç”Ÿå‘½å‘¨æœŸé’©å­(`useEffect`)

ç±»å®šä¹‰ä¸­æœ‰è®¸å¤šç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè€Œåœ¨ React Hooks ä¸­ä¹Ÿæä¾›äº†ä¸€ä¸ªç›¸åº”çš„å‡½æ•° (`useEffect`)ï¼Œè¿™é‡Œå¯ä»¥çœ‹åš`componentDidMount`ã€`componentDidUpdate`å’Œ`componentWillUnmount`çš„ç»“åˆã€‚

- `useEffect(callback, [source])`æ¥å—ä¸¤ä¸ªå‚æ•°
  - `callback`: é’©å­å›è°ƒå‡½æ•°ï¼›
  - `source`: è®¾ç½®è§¦å‘æ¡ä»¶ï¼Œä»…å½“ source å‘ç”Ÿæ”¹å˜æ—¶æ‰ä¼šè§¦å‘ï¼›
  - `useEffect`é’©å­åœ¨æ²¡æœ‰ä¼ å…¥`[source]`å‚æ•°æ—¶ï¼Œé»˜è®¤åœ¨æ¯æ¬¡ render æ—¶éƒ½ä¼šä¼˜å…ˆè°ƒç”¨ä¸Šæ¬¡ä¿å­˜çš„å›è°ƒä¸­è¿”å›çš„å‡½æ•°ï¼Œåå†é‡æ–°è°ƒç”¨å›è°ƒï¼›

```js
useEffect(() => {
  // ç»„ä»¶æŒ‚è½½åæ‰§è¡Œäº‹ä»¶ç»‘å®š
  console.log("on");
  addEventListener();

  // ç»„ä»¶ update æ—¶ä¼šæ‰§è¡Œäº‹ä»¶è§£ç»‘
  return () => {
    console.log("off");
    removeEventListener();
  };
}, [source]);

// æ¯æ¬¡ source å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰§è¡Œç»“æœ(ä»¥ç±»å®šä¹‰çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾¿äºå¤§å®¶ç†è§£):
// --- DidMount ---
// 'on'
// --- DidUpdate ---
// 'off'
// 'on'
// --- DidUpdate ---
// 'off'
// 'on'
// --- WillUnmount ---
// 'off'
```

- é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ä¾¿å¯æ¨¡æ‹Ÿå‡ºå‡ ä¸ªå¸¸ç”¨çš„ç”Ÿå‘½å‘¨æœŸ:

  - `componentDidMount`: ä¼ å…¥`[]`æ—¶ï¼Œå°±åªä¼šåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ï¼›

  ```js
  const useMount = (fn) => useEffect(fn, []);
  ```

  - `componentWillUnmount`: ä¼ å…¥`[]`ï¼Œå›è°ƒä¸­çš„è¿”å›çš„å‡½æ•°ä¹Ÿåªä¼šè¢«æœ€ç»ˆæ‰§è¡Œä¸€æ¬¡ï¼›

  ```js
  const useUnmount = (fn) => useEffect(() => fn, []);
  ```

  - `mounted`: å¯ä»¥ä½¿ç”¨ useState å°è£…æˆä¸€ä¸ªé«˜åº¦å¯å¤ç”¨çš„ mounted çŠ¶æ€ï¼›

  ```js
  const useMounted = () => {
    const [mounted, setMounted] = useState(false);
    useEffect(() => {
      !mounted && setMounted(true);
      return () => setMounted(false);
    }, []);
    return mounted;
  };
  ```

  - `componentDidUpdate`: `useEffect`æ¯æ¬¡å‡ä¼šæ‰§è¡Œï¼Œå…¶å®å°±æ˜¯æ’é™¤äº† DidMount åå³å¯ï¼›

  ```js
  const mounted = useMounted();
  useEffect(() => {
    mounted && fn();
  });
  ```

### å…¶å®ƒå†…ç½®é’©å­

- `useContext`: è·å– context å¯¹è±¡

```js
import React, { useContext } from "react";

const colorContext = React.createContext("gray");
function Bar() {
  const color = useContext(colorContext);
  return <div>{color}</div>;
}
function Foo() {
  return <Bar />;
}
function App() {
  return (
    <colorContext.Provider value={"red"}>
      <Foo />
    </colorContext.Provider>
  );
}
```

- `useReducer`: ç±»ä¼¼äº Redux æ€æƒ³çš„å®ç°ï¼Œä½†å…¶å¹¶ä¸è¶³ä»¥æ›¿ä»£ Reduxï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªç»„ä»¶å†…éƒ¨çš„ redux:

  - å¹¶ä¸æ˜¯æŒä¹…åŒ–å­˜å‚¨ï¼Œä¼šéšç€ç»„ä»¶è¢«é”€æ¯è€Œé”€æ¯ï¼›
  - å±äºç»„ä»¶å†…éƒ¨ï¼Œå„ä¸ªç»„ä»¶æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå•çº¯ç”¨å®ƒå¹¶æ— æ³•å…±äº«æ•°æ®ï¼›
  - é…åˆ`useContext`çš„å…¨å±€æ€§ï¼Œå¯ä»¥å®Œæˆä¸€ä¸ªè½»é‡çº§çš„ Reduxï¼›([easy-peasy](https://github.com/ctrlplusb/easy-peasy))

```js
const initialState = {count: 0};

function reducer(state, action) {
  switch (action.type) {
    case 'increment':
      return {count: state.count + 1};
    case 'decrement':
      return {count: state.count - 1};
    default:
      throw new Error();
  }
}

function Counter() {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <>
      Count: {state.count}
      <button onClick={() => dispatch({type: 'decrement'})}>-</button>
      <button onClick={() => dispatch({type: 'increment'})}>+</button>
    </>
  );
}
```
- `useCallback`: ç¼“å­˜å›è°ƒå‡½æ•°ï¼Œé¿å…ä¼ å…¥çš„å›è°ƒæ¯æ¬¡éƒ½æ˜¯æ–°çš„å‡½æ•°å®ä¾‹è€Œå¯¼è‡´ä¾èµ–ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå…·æœ‰æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœï¼›

```js
const memoizedCallback = useCallback(
  () => {
    doSomething(a, b);
  },
  [a, b],
);
```

- `useMemo`: ç”¨äºç¼“å­˜ä¼ å…¥çš„ propsï¼Œé¿å…ä¾èµ–çš„ç»„ä»¶æ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“ï¼›

```js
const memoizedValue = useMemo(() => computeExpensiveValue(a, b), [a, b]);
```

- `useRef`: è·å–ç»„ä»¶çš„çœŸå®èŠ‚ç‚¹ï¼›
- `useLayoutEffect`:
  - DOM æ›´æ–°åŒæ­¥é’©å­ã€‚ç”¨æ³•ä¸`useEffect`ç±»ä¼¼ï¼Œåªæ˜¯åŒºåˆ«äºæ‰§è¡Œæ—¶é—´ç‚¹çš„ä¸åŒã€‚
  - `useEffect`å±äºå¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä¸ä¼šç­‰å¾… DOM çœŸæ­£æ¸²æŸ“åæ‰§è¡Œï¼Œè€Œ`useLayoutEffect`åˆ™ä¼šçœŸæ­£æ¸²æŸ“åæ‰è§¦å‘ï¼›
  - å¯ä»¥è·å–æ›´æ–°åçš„ stateï¼›

### è‡ªå®šä¹‰é’©å­(`useXxxxx`)

åŸºäº Hooks å¯ä»¥å¼•ç”¨å…¶å®ƒ Hooks è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå®šä¹‰é’©å­ï¼Œå¦‚ä¸Šé¢çš„`useMounted`ã€‚åˆä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªé¡µé¢è‡ªå®šä¹‰æ ‡é¢˜:

```js
function useTitle(title) {
  useEffect(() => {
    document.title = title;
  });
}

// ä½¿ç”¨:
function Home() {
  const title = "æˆ‘æ˜¯é¦–é¡µ";
  useTitle(title);

  return <div>{title}</div>;
}
```

### æ¨¡ä»¿Hooks

<code src='./react-app/ImitateHooks.jsx' />

### Hooks å®ç° Redux

## SSR

SSRï¼Œä¿—ç§° **æœåŠ¡ç«¯æ¸²æŸ“** (Server Side Render)ï¼Œè®²äººè¯å°±æ˜¯: ç›´æ¥åœ¨æœåŠ¡ç«¯å±‚è·å–æ•°æ®ï¼Œæ¸²æŸ“å‡ºå®Œæˆçš„ HTML æ–‡ä»¶ï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·æµè§ˆå™¨è®¿é—®ã€‚

- **å‰åç«¯åˆ†ç¦»**: å‰ç«¯ä¸æœåŠ¡ç«¯éš”ç¦»ï¼Œå‰ç«¯åŠ¨æ€è·å–æ•°æ®ï¼Œæ¸²æŸ“é¡µé¢ã€‚

- **ç—›ç‚¹**:

  - **é¦–å±æ¸²æŸ“æ€§èƒ½ç“¶é¢ˆ**:

    - ç©ºç™½å»¶è¿Ÿ: HTML ä¸‹è½½æ—¶é—´ + JS ä¸‹è½½/æ‰§è¡Œæ—¶é—´ + è¯·æ±‚æ—¶é—´ + æ¸²æŸ“æ—¶é—´ã€‚åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œé¡µé¢å¤„äºç©ºç™½çš„çŠ¶æ€ã€‚

  - **SEO é—®é¢˜**: ç”±äºé¡µé¢åˆå§‹çŠ¶æ€ä¸ºç©ºï¼Œå› æ­¤çˆ¬è™«æ— æ³•è·å–é¡µé¢ä¸­ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œå› æ­¤å¯¹æœç´¢å¼•æ“ä¸å‹å¥½ã€‚
    - è™½ç„¶ä¸€ç›´æœ‰åœ¨æåŠ¨æ€æ¸²æŸ“çˆ¬è™«çš„æŠ€æœ¯ï¼Œä¸è¿‡æ®æˆ‘äº†è§£ï¼Œå¤§éƒ¨åˆ†å›½å†…æœç´¢å¼•æ“ä»ç„¶æ˜¯æ²¡æœ‰å®ç°ã€‚

æœ€åˆçš„æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä¾¿æ²¡æœ‰è¿™äº›é—®é¢˜ã€‚ä½†æˆ‘ä»¬ä¸èƒ½è¿”ç’å½’çœŸï¼Œæ—¢è¦ä¿è¯ç°æœ‰çš„å‰ç«¯ç‹¬ç«‹çš„å¼€å‘æ¨¡å¼ï¼Œåˆè¦ç”±æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ React SSRã€‚

- **åŸç†**:

  - Node æœåŠ¡: è®©å‰åç«¯è¿è¡ŒåŒä¸€å¥—ä»£ç æˆä¸ºå¯èƒ½ã€‚
  - Virtual Dom: è®©å‰ç«¯ä»£ç è„±ç¦»æµè§ˆå™¨è¿è¡Œã€‚

- **æ¡ä»¶**: Node ä¸­é—´å±‚ã€ React / Vue ç­‰æ¡†æ¶ã€‚ ç»“æ„å¤§æ¦‚å¦‚ä¸‹:

<img width="600" src="https://raw.githubusercontent.com/xd-tayde/blog/master/images/interview/9.png">

- **å¼€å‘æµç¨‹**: (æ­¤å¤„ä»¥ React + Router + Redux + Koa ä¸ºä¾‹)

  - 1ã€åœ¨åŒä¸ªé¡¹ç›®ä¸­ï¼Œ**æ­å»º** å‰åç«¯éƒ¨åˆ†ï¼Œå¸¸è§„ç»“æ„:
    - build
    - public
    - src

      - client
      - server
  - 2ã€server ä¸­ä½¿ç”¨ Koa **è·¯ç”±ç›‘å¬** é¡µé¢è®¿é—®:

  ```js
  import * as Router from "koa-router";

  const router = new Router();
  // å¦‚æœä¸­é—´ä¹Ÿæä¾› Api å±‚
  router.use("/api/home", async () => {
    // è¿”å›æ•°æ®
  });

  router.get("*", async (ctx) => {
    // è¿”å› HTML
  });
  ```

  - 3ã€é€šè¿‡è®¿é—® url **åŒ¹é…** å‰ç«¯é¡µé¢è·¯ç”±:

  ```js
  // å‰ç«¯é¡µé¢è·¯ç”±
  import { pages } from "../../client/app";
  import { matchPath } from "react-router-dom";

  // ä½¿ç”¨ react-router åº“æä¾›çš„ä¸€ä¸ªåŒ¹é…æ–¹æ³•
  const matchPage = matchPath(ctx.req.url, page);
  ```

  - 4ã€é€šè¿‡é¡µé¢è·¯ç”±çš„é…ç½®è¿›è¡Œ **æ•°æ®è·å–**ã€‚é€šå¸¸å¯ä»¥åœ¨é¡µé¢è·¯ç”±ä¸­å¢åŠ  SSR ç›¸å…³çš„é™æ€é…ç½®ï¼Œç”¨äºæŠ½è±¡é€»è¾‘ï¼Œå¯ä»¥ä¿è¯æœåŠ¡ç«¯é€»è¾‘çš„é€šç”¨æ€§ï¼Œå¦‚:

    ```js
    class HomePage extends React.Component{
      public static ssrConfig = {
          cache: true,
             fetch() {
                // è¯·æ±‚è·å–æ•°æ®
             }
        }
    }
    ```

    è·å–æ•°æ®é€šå¸¸æœ‰ä¸¤ç§æƒ…å†µ:

    - ä¸­é—´å±‚ä¹Ÿä½¿ç”¨ **http** è·å–æ•°æ®ï¼Œåˆ™æ­¤æ—¶ fetch æ–¹æ³•å¯å‰åç«¯å…±äº«ï¼›

    ```js
    const data = await matchPage.ssrConfig.fetch();
    ```

    - ä¸­é—´å±‚å¹¶ä¸ä½¿ç”¨ httpï¼Œæ˜¯é€šè¿‡ä¸€äº› **å†…éƒ¨è°ƒç”¨**ï¼Œä¾‹å¦‚ Rpc æˆ– ç›´æ¥è¯»æ•°æ®åº“ ç­‰ï¼Œæ­¤æ—¶ä¹Ÿå¯ä»¥ç›´æ¥ç”±æœåŠ¡ç«¯è°ƒç”¨å¯¹åº”çš„æ–¹æ³•è·å–æ•°æ®ã€‚é€šå¸¸ï¼Œè¿™é‡Œéœ€è¦åœ¨ ssrConfig ä¸­é…ç½®ç‰¹å¼‚æ€§çš„ä¿¡æ¯ï¼Œç”¨äºåŒ¹é…å¯¹åº”çš„æ•°æ®è·å–æ–¹æ³•ã€‚

    ```js
    // é¡µé¢è·¯ç”±
    class HomePage extends React.Component{
      public static ssrConfig = {
            fetch: {
               url: '/api/home',
            }
        }
    }

    // æ ¹æ®è§„åˆ™åŒ¹é…å‡ºå¯¹åº”çš„æ•°æ®è·å–æ–¹æ³•
    // è¿™é‡Œçš„è§„åˆ™å¯ä»¥è‡ªç”±ï¼Œåªè¦èƒ½åŒ¹é…å‡ºæ­£ç¡®çš„æ–¹æ³•å³å¯
    const controller = matchController(ssrConfig.fetch.url)

    // è·å–æ•°æ®
    const data = await controller(ctx)
    ```

  - 5ã€åˆ›å»º Redux storeï¼Œå¹¶å°†æ•°æ®`dispatch`åˆ°é‡Œé¢:

  ```js
  import { createStore } from "redux";
  // è·å– Clinetå±‚ reducer
  // å¿…é¡»å¤ç”¨å‰ç«¯å±‚çš„é€»è¾‘ï¼Œæ‰èƒ½ä¿è¯ä¸€è‡´æ€§ï¼›
  import { reducers } from "../../client/store";

  // åˆ›å»º store
  const store = createStore(reducers);

  // è·å–é…ç½®å¥½çš„ Action
  const action = ssrConfig.action;

  // å­˜å‚¨æ•°æ®
  store.dispatch(createAction(action)(data));
  ```

  - 6ã€æ³¨å…¥ Storeï¼Œ è°ƒç”¨`renderToString`å°† React Virtual Dom æ¸²æŸ“æˆ **å­—ç¬¦ä¸²**:

  ```js
  import * as ReactDOMServer from "react-dom/server";
  import { Provider } from "react-redux";

  // è·å– Clinet å±‚æ ¹ç»„ä»¶
  import { App } from "../../client/app";

  const AppString = ReactDOMServer.renderToString(
    <Provider store={store}>
      <StaticRouter location={ctx.req.url} context={{}}>
        <App />
      </StaticRouter>
    </Provider>
  );
  ```

  - 7ã€å°† AppString åŒ…è£…æˆå®Œæ•´çš„ html æ–‡ä»¶æ ¼å¼ï¼›

  - 8ã€æ­¤æ—¶ï¼Œå·²ç»èƒ½ç”Ÿæˆå®Œæ•´çš„ HTML æ–‡ä»¶ã€‚ä½†åªæ˜¯ä¸ªçº¯é™æ€çš„é¡µé¢ï¼Œæ²¡æœ‰æ ·å¼æ²¡æœ‰äº¤äº’ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯è¦æ’å…¥ JS ä¸ CSSã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®å‰ç«¯æ‰“åŒ…åç”Ÿæˆçš„`asset-manifest.json`æ–‡ä»¶æ¥è·å–ç›¸åº”çš„æ–‡ä»¶è·¯å¾„ï¼Œå¹¶åŒæ ·æ³¨å…¥åˆ° Html ä¸­å¼•ç”¨ã€‚

  ```js
  const html = `
    <!DOCTYPE html>
    <html lang="zh">
      <head></head>
      <link href="${cssPath}" rel="stylesheet" />
      <body>
        <div id="App">${AppString}</div>
        <script src="${scriptPath}"></script>
      </body>
    </html>
  `;
  ```

  - 9ã€è¿›è¡Œ **æ•°æ®è„±æ°´**: ä¸ºäº†æŠŠæœåŠ¡ç«¯è·å–çš„æ•°æ®åŒæ­¥åˆ°å‰ç«¯ã€‚ä¸»è¦æ˜¯å°†æ•°æ®åºåˆ—åŒ–åï¼Œæ’å…¥åˆ° html ä¸­ï¼Œè¿”å›ç»™å‰ç«¯ã€‚

  ```js
  import serialize from "serialize-javascript";
  // è·å–æ•°æ®
  const initState = store.getState();
  const html = `
    <!DOCTYPE html>
    <html lang="zh">
      <head></head>
      <body>
        <div id="App"></div>
        <script type="application/json" id="SSR_HYDRATED_DATA">${serialize(
          initState
        )}</script>
      </body>
    </html>
  `;

  ctx.status = 200;
  ctx.body = html;
  ```

  > **Tips**:
  >
  > è¿™é‡Œæ¯”è¾ƒç‰¹åˆ«çš„æœ‰ä¸¤ç‚¹:
  >
  > 1. ä½¿ç”¨äº†`serialize-javascript`åºåˆ—åŒ– storeï¼Œ æ›¿ä»£äº†`JSON.stringify`ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ï¼Œé¿å…ä»£ç æ³¨å…¥å’Œ XSS æ”»å‡»ï¼›
  >
  > 2. ä½¿ç”¨ json è¿›è¡Œä¼ è¾“ï¼Œå¯ä»¥è·å¾—æ›´å¿«çš„åŠ è½½é€Ÿåº¦ï¼›

  - 10ã€Client å±‚ **æ•°æ®å¸æ°´**: åˆå§‹åŒ– store æ—¶ï¼Œä»¥è„±æ°´åçš„æ•°æ®ä¸ºåˆå§‹åŒ–æ•°æ®ï¼ŒåŒæ­¥åˆ›å»º storeã€‚

  ```js
  const hydratedEl = document.getElementById("SSR_HYDRATED_DATA");
  const hydrateData = JSON.parse(hydratedEl.textContent);

  // ä½¿ç”¨åˆå§‹ state åˆ›å»º Redux store
  const store = createStore(reducer, hydrateData);
  ```

## React-Router

### History

> historyæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹jsåº“ï¼Œå¯ä»¥ç”¨æ¥å…¼å®¹åœ¨ä¸åŒæµè§ˆå™¨ã€ä¸åŒç¯å¢ƒä¸‹å¯¹å†å²è®°å½•çš„ç®¡ç†ï¼Œæ‹¥æœ‰ç»Ÿä¸€çš„APIã€‚å…·ä½“æ¥è¯´é‡Œé¢çš„historyåˆ†ä¸ºä¸‰ç±»

- è€æµè§ˆå™¨çš„history: ä¸»è¦é€šè¿‡hashæ¥å®ç°ï¼Œå¯¹åº”createHashHistory
- é«˜ç‰ˆæœ¬æµè§ˆå™¨: é€šè¿‡html5é‡Œé¢çš„historyï¼Œå¯¹åº”createBrowserHistory
- nodeç¯å¢ƒä¸‹: ä¸»è¦å­˜å‚¨åœ¨memeoryé‡Œé¢ï¼Œå¯¹åº”createMemoryHistory

### åŸºæœ¬åŸç†

> å®ç°URLä¸UIç•Œé¢çš„åŒæ­¥ã€‚å…¶ä¸­åœ¨react-routerä¸­ï¼ŒURLå¯¹åº”Locationå¯¹è±¡ï¼Œè€ŒUIæ˜¯ç”±react componentsæ¥å†³å®šçš„ï¼Œè¿™æ ·å°±è½¬å˜æˆlocationä¸componentsä¹‹é—´çš„åŒæ­¥é—®é¢˜

![](./react-router.webp)

### å…·ä½“å®ç°

> åœ¨react-routerä¸­æœ€ä¸»è¦çš„componentæ˜¯Router RouterContext Linkï¼Œhistoryåº“èµ·åˆ°äº†ä¸­é—´æ¡¥æ¢çš„ä½œç”¨
> ä»¥browserHistory(ä¸€ç§historyç±»å‹:ä¸€ä¸ª history çŸ¥é“å¦‚ä½•å»ç›‘å¬æµè§ˆå™¨åœ°å€æ çš„å˜åŒ–ï¼Œ å¹¶è§£æè¿™ä¸ª URL è½¬åŒ–ä¸º location å¯¹è±¡)ä¸ºä¾‹ : browserHistoryè¿›è¡Œè·¯ç”±stateç®¡ç†,ä¸»è¦é€šè¿‡sessionStorage

```js
//ä¿å­˜ã€€è·¯ç”±state(router state)
function saveState(key, state) {
  ...
  window.sessionStorage.setItem(createKey(key), JSON.stringify(state));
}
//è¯»å–è·¯ç”±state
function readState(key) {
  ...
  json = window.sessionStorage.getItem(createKey(key));
  return JSON.parse(json);
}
```

![](./react-router-history.webp)

å‚è€ƒï¼š
[ä»è·¯ç”±åŸç†å‡ºå‘ï¼Œæ·±å…¥é˜…è¯»ç†è§£react-router 4.0çš„æºç ](https://blog.csdn.net/chern1992/article/details/107053381/)
[React RouteråŸç†](https://www.jianshu.com/p/d991a4a55ae1)

## å‡½æ•°å¼ç¼–ç¨‹

å‡½æ•°å¼ç¼–ç¨‹æ˜¯ä¸€ç§ **ç¼–ç¨‹èŒƒå¼**ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸€ç§è½¯ä»¶æ¶æ„çš„æ€ç»´æ¨¡å¼ã€‚å®ƒæœ‰ç€ç‹¬ç«‹ä¸€å¥—ç†è®ºåŸºç¡€ä¸è¾¹ç•Œæ³•åˆ™ï¼Œè¿½æ±‚çš„æ˜¯ **æ›´ç®€æ´ã€å¯é¢„æµ‹ã€é«˜å¤ç”¨ã€æ˜“æµ‹è¯•**ã€‚å…¶å®åœ¨ç°æœ‰çš„ä¼—å¤šçŸ¥ååº“ä¸­ï¼Œéƒ½è•´å«ç€ä¸°å¯Œçš„å‡½æ•°å¼ç¼–ç¨‹æ€æƒ³ï¼Œå¦‚ React / Redux ç­‰ã€‚

- **å¸¸è§çš„ç¼–ç¨‹èŒƒå¼**:

  - å‘½ä»¤å¼ç¼–ç¨‹(è¿‡ç¨‹åŒ–ç¼–ç¨‹): æ›´å…³å¿ƒè§£å†³é—®é¢˜çš„æ­¥éª¤ï¼Œä¸€æ­¥æ­¥ä»¥è¯­è¨€çš„å½¢å¼å‘Šè¯‰è®¡ç®—æœºåšä»€ä¹ˆï¼›
  - äº‹ä»¶é©±åŠ¨ç¼–ç¨‹: äº‹ä»¶è®¢é˜…ä¸è§¦å‘ï¼Œè¢«å¹¿æ³›ç”¨äº GUI çš„ç¼–ç¨‹è®¾è®¡ä¸­ï¼›
  - é¢å‘å¯¹è±¡ç¼–ç¨‹: åŸºäºç±»ã€å¯¹è±¡ä¸æ–¹æ³•çš„è®¾è®¡æ¨¡å¼ï¼Œæ‹¥æœ‰ä¸‰ä¸ªåŸºç¡€æ¦‚å¿µ: å°è£…æ€§ã€ç»§æ‰¿æ€§ã€å¤šæ€æ€§ï¼›
  - å‡½æ•°å¼ç¼–ç¨‹
    - æ¢æˆä¸€ç§æ›´é«˜ç«¯çš„è¯´æ³•ï¼Œé¢å‘æ•°å­¦ç¼–ç¨‹ã€‚æ€•ä¸æ€•~ğŸ¥´

- **å‡½æ•°å¼ç¼–ç¨‹çš„ç†å¿µ**:

  - **çº¯å‡½æ•°**(ç¡®å®šæ€§å‡½æ•°): æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„åŸºç¡€ï¼Œå¯ä»¥ä½¿ç¨‹åºå˜å¾—çµæ´»ï¼Œé«˜åº¦å¯æ‹“å±•ï¼Œå¯ç»´æŠ¤ï¼›

    - **ä¼˜åŠ¿**:

      - å®Œå…¨ç‹¬ç«‹ï¼Œä¸å¤–éƒ¨è§£è€¦ï¼›
      - é«˜åº¦å¯å¤ç”¨ï¼Œåœ¨ä»»æ„ä¸Šä¸‹æ–‡ï¼Œä»»æ„æ—¶é—´çº¿ä¸Šï¼Œéƒ½å¯æ‰§è¡Œå¹¶ä¸”ä¿è¯ç»“æœç¨³å®šï¼›
      - å¯æµ‹è¯•æ€§æå¼ºï¼›

    - **æ¡ä»¶**:

      - ä¸ä¿®æ”¹å‚æ•°ï¼›
      - ä¸ä¾èµ–ã€ä¸ä¿®æ”¹ä»»ä½•å‡½æ•°å¤–éƒ¨çš„æ•°æ®ï¼›
      - å®Œå…¨å¯æ§ï¼Œå‚æ•°ä¸€æ ·ï¼Œè¿”å›å€¼ä¸€å®šä¸€æ ·: ä¾‹å¦‚å‡½æ•°ä¸èƒ½åŒ…å«`new Date()`æˆ–è€…`Math.randon()`ç­‰è¿™ç§ä¸å¯æ§å› ç´ ï¼›
      - å¼•ç”¨é€æ˜ï¼›

    - æˆ‘ä»¬å¸¸ç”¨åˆ°çš„è®¸å¤š API æˆ–è€…å·¥å…·å‡½æ•°ï¼Œå®ƒä»¬éƒ½å…·æœ‰ç€çº¯å‡½æ•°çš„ç‰¹ç‚¹ï¼Œ å¦‚`split / join / map`ï¼›

  - **å‡½æ•°å¤åˆ**: å°†å¤šä¸ªå‡½æ•°è¿›è¡Œç»„åˆåè°ƒç”¨ï¼Œå¯ä»¥å®ç°å°†ä¸€ä¸ªä¸ªå‡½æ•°å•å…ƒè¿›è¡Œç»„åˆï¼Œè¾¾æˆæœ€åçš„ç›®æ ‡ï¼›

    - **æ‰å¹³åŒ–åµŒå¥—**: é¦–å…ˆï¼Œæˆ‘ä»¬ä¸€å®šèƒ½æƒ³åˆ°ç»„åˆå‡½æ•°æœ€ç®€å•çš„æ“ä½œå°±æ˜¯ åŒ…è£¹ï¼Œå› ä¸ºåœ¨ JS ä¸­ï¼Œå‡½æ•°ä¹Ÿå¯ä»¥å½“åšå‚æ•°:
      - `f(g(k(x)))`: åµŒå¥—åœ°ç‹±ï¼Œå¯è¯»æ€§ä½ï¼Œå½“å‡½æ•°å¤æ‚åï¼Œå®¹æ˜“è®©äººä¸€è„¸æ‡µé€¼ï¼›
      - ç†æƒ³çš„åšæ³•: `xxx(f, g, k)(x)`
    - **ç»“æœä¼ é€’**: å¦‚æœæƒ³å®ç°ä¸Šé¢çš„æ–¹å¼ï¼Œé‚£ä¹Ÿå°±æ˜¯`xxx`å‡½æ•°è¦å®ç°çš„ä¾¿æ˜¯: æ‰§è¡Œç»“æœåœ¨å„ä¸ªå‡½æ•°ä¹‹é—´çš„æ‰§è¡Œä¼ é€’ï¼›

      - è¿™æ—¶æˆ‘ä»¬å°±èƒ½æƒ³åˆ°ä¸€ä¸ªåŸç”Ÿæä¾›çš„æ•°ç»„æ–¹æ³•: `reduce`ï¼Œå®ƒå¯ä»¥æŒ‰æ•°ç»„çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œä¼ é€’æ‰§è¡Œç»“æœï¼›
      - æ‰€ä»¥æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°ä¸€ä¸ªæ–¹æ³•`pipe`ï¼Œç”¨äºå‡½æ•°ç»„åˆ:

      ```js
      // ...fs: å°†å‡½æ•°ç»„åˆæˆæ•°ç»„ï¼›
      // Array.prototype.reduce è¿›è¡Œç»„åˆï¼›
      // p: åˆå§‹å‚æ•°ï¼›
      const pipe = (...fs) => (p) => fs.reduce((v, f) => f(v), p);
      ```

    - **ä½¿ç”¨**: å®ç°ä¸€ä¸ª é©¼å³°å‘½å è½¬ ä¸­åˆ’çº¿å‘½å çš„åŠŸèƒ½:

    ```js
    // 'Guo DongDong' --> 'guo-dongdong'
    // å‡½æ•°ç»„åˆå¼å†™æ³•
    const toLowerCase = (str) => str.toLowerCase();
    const join = curry((str, arr) => arr.join(str));
    const split = curry((splitOn, str) => str.split(splitOn));

    const toSlug = pipe(toLowerCase, split(" "), join("_"), encodeURIComponent);
    console.log(toSlug("Guo DongDong"));
    ```

    - **å¥½å¤„**:

      - éšè—ä¸­é—´å‚æ•°ï¼Œä¸éœ€è¦ä¸´æ—¶å˜é‡ï¼Œé¿å…äº†è¿™ä¸ªç¯èŠ‚çš„å‡ºé”™å‡ ç‡ï¼›
      - åªéœ€å…³æ³¨æ¯ä¸ªçº¯å‡½æ•°å•å…ƒçš„ç¨³å®šï¼Œä¸å†éœ€è¦å…³æ³¨å‘½åï¼Œä¼ é€’ï¼Œè°ƒç”¨ç­‰ï¼›
      - å¯å¤ç”¨æ€§å¼ºï¼Œä»»ä½•ä¸€ä¸ªå‡½æ•°å•å…ƒéƒ½å¯è¢«ä»»æ„å¤ç”¨å’Œç»„åˆï¼›
      - å¯æ‹“å±•æ€§å¼ºï¼Œæˆæœ¬ä½ï¼Œä¾‹å¦‚ç°åœ¨åŠ ä¸ªéœ€æ±‚ï¼Œè¦æŸ¥çœ‹æ¯ä¸ªç¯èŠ‚çš„è¾“å‡º:

      ```js
      const log = curry((label, x) => {
        console.log(`${label}: ${x}`);
        return x;
      });

      const toSlug = pipe(
        toLowerCase,
        log("toLowerCase output"),
        split(" "),
        log("split output"),
        join("_"),
        log("join output"),
        encodeURIComponent
      );
      ```

    > Tips:
    >
    > ä¸€äº›å·¥å…·çº¯å‡½æ•°å¯ç›´æ¥å¼•ç”¨`lodash/fp`ï¼Œä¾‹å¦‚`curry/map/split`ç­‰ï¼Œå¹¶ä¸éœ€è¦åƒæˆ‘ä»¬ä¸Šé¢è¿™æ ·è‡ªå·±å®ç°ï¼›

  - **æ•°æ®ä¸å¯å˜æ€§**(immutable): è¿™æ˜¯ä¸€ç§æ•°æ®ç†å¿µï¼Œä¹Ÿæ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„æ ¸å¿ƒç†å¿µä¹‹ä¸€:

    - **å€¡å¯¼**: ä¸€ä¸ªå¯¹è±¡å†è¢«åˆ›å»ºåä¾¿ä¸ä¼šå†è¢«ä¿®æ”¹ã€‚å½“éœ€è¦æ”¹å˜å€¼æ—¶ï¼Œæ˜¯è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨åŸå¯¹è±¡ä¸Šä¿®æ”¹ï¼›
    - **ç›®çš„**: ä¿è¯æ•°æ®çš„ç¨³å®šæ€§ã€‚é¿å…ä¾èµ–çš„æ•°æ®è¢«æœªçŸ¥åœ°ä¿®æ”¹ï¼Œå¯¼è‡´äº†è‡ªèº«çš„æ‰§è¡Œå¼‚å¸¸ï¼Œèƒ½æœ‰æ•ˆæé«˜å¯æ§æ€§ä¸ç¨³å®šæ€§ï¼›
    - å¹¶ä¸ç­‰åŒäº`const`ã€‚ä½¿ç”¨`const`åˆ›å»ºä¸€ä¸ªå¯¹è±¡åï¼Œå®ƒçš„å±æ€§ä»ç„¶å¯ä»¥è¢«ä¿®æ”¹ï¼›
    - æ›´ç±»ä¼¼äº`Object.freeze`: å†»ç»“å¯¹è±¡ï¼Œä½†`freeze`ä»æ— æ³•ä¿è¯æ·±å±‚çš„å±æ€§ä¸è¢«ä¸²æ”¹ï¼›
    - `immutable.js`: js ä¸­çš„æ•°æ®ä¸å¯å˜åº“ï¼Œå®ƒä¿è¯äº†æ•°æ®ä¸å¯å˜ï¼Œåœ¨ React ç”Ÿæ€ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œå¤§å¤§æå‡äº†æ€§èƒ½ä¸ç¨³å®šæ€§ï¼›
      - `trie`æ•°æ®ç»“æ„:
        - ä¸€ç§æ•°æ®ç»“æ„ï¼Œèƒ½æœ‰æ•ˆåœ°æ·±åº¦å†»ç»“å¯¹è±¡ï¼Œä¿è¯å…¶ä¸å¯å˜ï¼›
        - **ç»“æ„å…±äº«**: å¯ä»¥å…±ç”¨ä¸å¯å˜å¯¹è±¡çš„å†…å­˜å¼•ç”¨åœ°å€ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œæé«˜æ•°æ®æ“ä½œæ€§èƒ½ï¼›

  - é¿å…ä¸åŒå‡½æ•°ä¹‹é—´çš„ **çŠ¶æ€å…±äº«**ï¼Œæ•°æ®çš„ä¼ é€’ä½¿ç”¨å¤åˆ¶æˆ–å…¨æ–°å¯¹è±¡ï¼Œéµå®ˆæ•°æ®ä¸å¯å˜åŸåˆ™ï¼›
  - é¿å…ä»å‡½æ•°å†…éƒ¨ **æ”¹å˜å¤–éƒ¨çŠ¶æ€**ï¼Œä¾‹å¦‚æ”¹å˜äº†å…¨å±€ä½œç”¨åŸŸæˆ–çˆ¶çº§ä½œç”¨åŸŸä¸Šçš„å˜é‡å€¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶å®ƒå•ä½é”™è¯¯ï¼›
  - é¿å…åœ¨å•å…ƒå‡½æ•°å†…éƒ¨æ‰§è¡Œä¸€äº› **å‰¯ä½œç”¨**ï¼Œåº”è¯¥å°†è¿™äº›æ“ä½œæŠ½ç¦»æˆæ›´ç‹¬ç«‹çš„å·¥å…·å•å…ƒï¼›
    - æ—¥å¿—è¾“å‡º
    - è¯»å†™æ–‡ä»¶
    - ç½‘ç»œè¯·æ±‚
    - è°ƒç”¨å¤–éƒ¨è¿›ç¨‹
    - è°ƒç”¨æœ‰å‰¯ä½œç”¨çš„å‡½æ•°

- **é«˜é˜¶å‡½æ•°**: æ˜¯æŒ‡ ä»¥å‡½æ•°ä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å¢å¼ºå‡½æ•° çš„ä¸€ç±»å‡½æ•°ï¼Œå®ƒé€šå¸¸ç”¨äº:

  - å°†é€»è¾‘è¡Œä¸ºè¿›è¡Œ **éš”ç¦»æŠ½è±¡**ï¼Œä¾¿äºå¿«é€Ÿå¤ç”¨ï¼Œå¦‚å¤„ç†æ•°æ®ï¼Œå…¼å®¹æ€§ç­‰ï¼›
  - **å‡½æ•°ç»„åˆ**ï¼Œå°†ä¸€ç³»åˆ—å•å…ƒå‡½æ•°åˆ—è¡¨ç»„åˆæˆåŠŸèƒ½æ›´å¼ºå¤§çš„å‡½æ•°ï¼›
  - **å‡½æ•°å¢å¼º**ï¼Œå¿«é€Ÿåœ°æ‹“å±•å‡½æ•°åŠŸèƒ½ï¼Œ

- **å‡½æ•°å¼ç¼–ç¨‹çš„å¥½å¤„**:

  - å‡½æ•°å‰¯ä½œç”¨å°ï¼Œæ‰€æœ‰å‡½æ•°ç‹¬ç«‹å­˜åœ¨ï¼Œæ²¡æœ‰ä»»ä½•è€¦åˆï¼Œå¤ç”¨æ€§æé«˜ï¼›
  - ä¸å…³æ³¨æ‰§è¡Œæ—¶é—´ï¼Œæ‰§è¡Œé¡ºåºï¼Œå‚æ•°ï¼Œå‘½åç­‰ï¼Œèƒ½ä¸“æ³¨äºæ•°æ®çš„æµåŠ¨ä¸å¤„ç†ï¼Œèƒ½æœ‰æ•ˆæé«˜ç¨³å®šæ€§ä¸å¥å£®æ€§ï¼›
  - è¿½æ±‚å•å…ƒåŒ–ï¼Œç²’åº¦åŒ–ï¼Œä½¿å…¶é‡æ„å’Œæ”¹é€ æˆæœ¬é™ä½ï¼Œå¯ç»´æŠ¤ã€å¯æ‹“å±•æ€§è¾ƒå¥½ï¼›
  - æ›´æ˜“äºåšå•å…ƒæµ‹è¯•ã€‚

- **æ€»ç»“**:
  - å‡½æ•°å¼ç¼–ç¨‹å…¶å®æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒè¿½æ±‚æ›´ç»†çš„ç²’åº¦ï¼Œå°†åº”ç”¨æ‹†åˆ†æˆä¸€ç»„ç»„æå°çš„å•å…ƒå‡½æ•°ï¼Œç»„åˆè°ƒç”¨æ“ä½œæ•°æ®æµï¼›
  - å®ƒæå€¡ç€ çº¯å‡½æ•° / å‡½æ•°å¤åˆ / æ•°æ®ä¸å¯å˜ï¼Œ è°¨æ…å¯¹å¾…å‡½æ•°å†…çš„ çŠ¶æ€å…±äº« / ä¾èµ–å¤–éƒ¨ / å‰¯ä½œç”¨ï¼›

> Tips:
>
> å…¶å®æˆ‘ä»¬å¾ˆéš¾ä¹Ÿä¸éœ€è¦åœ¨é¢è¯•è¿‡ç¨‹ä¸­å»å®Œç¾åœ°é˜è¿°å‡ºæ•´å¥—æ€æƒ³ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯æµ…å°è¾„æ­¢ï¼Œä¸€äº›ä¸ªäººç†è§£è€Œå·²ã€‚åšä¸»ä¹Ÿæ˜¯åˆçº§å°èœé¸Ÿï¼Œåœç•™åœ¨è¡¨é¢è€Œå·²ï¼Œåªæ±‚å¯¹å¤§å®¶èƒ½æœ‰æ‰€å¸®åŠ©ï¼Œè½»å–· ğŸ¤£ï¼›
>
> æˆ‘ä¸ªäººè§‰å¾—: è¿™äº›ç¼–ç¨‹èŒƒå¼ä¹‹é—´ï¼Œå…¶å®å¹¶ä¸çŸ›ç›¾ï¼Œå„æœ‰å„çš„ **ä¼˜åŠ£åŠ¿**ã€‚
>
> ç†è§£å’Œå­¦ä¹ å®ƒä»¬çš„ç†å¿µä¸ä¼˜åŠ¿ï¼Œåˆç†åœ° **è®¾è®¡èåˆ**ï¼Œå°†ä¼˜ç§€çš„è½¯ä»¶ç¼–ç¨‹æ€æƒ³ç”¨äºæå‡æˆ‘ä»¬åº”ç”¨ï¼›
>
> æ‰€æœ‰è®¾è®¡æ€æƒ³ï¼Œæœ€ç»ˆçš„ç›®æ ‡ä¸€å®šæ˜¯ä½¿æˆ‘ä»¬çš„åº”ç”¨æ›´åŠ  **è§£è€¦é¢—ç²’åŒ–ã€æ˜“æ‹“å±•ã€æ˜“æµ‹è¯•ã€é«˜å¤ç”¨ï¼Œå¼€å‘æ›´ä¸ºé«˜æ•ˆå’Œå®‰å…¨**ï¼›
>
> æœ‰ä¸€äº›åº“èƒ½è®©å¤§å®¶å¾ˆå¿«åœ°æ¥è§¦å’Œè¿ç”¨å‡½æ•°æ€æƒ³: `Underscore.js` / `Lodash/fp` / `Rxjs` ç­‰ã€‚

## æ€§èƒ½ä¼˜åŒ–

åœ¨æœ€æ–°çš„`React16`ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨urlååŠ ä¸Š`?react_pref`ï¼Œå°±å¯ä»¥åœ¨chromeæµè§ˆå™¨çš„`performance`ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹`User Timeing`æ¥æŸ¥çœ‹ç»„ä»¶çš„åŠ è½½æ—¶é—´ã€‚

![](./react_pref.webp)

### æ€§èƒ½æ£€æŸ¥

å‚è€ƒ
[ç²¾è¯»ã€ŠReact æ€§èƒ½è°ƒè¯•ã€‹](https://juejin.im/post/5ea667cbf265da47c7122bdb)

### å•ç»„ä»¶ä¼˜åŒ–

- `render`é‡Œé¢å°½é‡å‡å°‘æ–°å»ºå˜é‡å’Œ`bind`å‡½æ•°ï¼Œä¼ é€’å‚æ•°æ˜¯å°½é‡å‡å°‘ä¼ é€’å‚æ•°çš„æ•°é‡ã€‚
- ç»„ä»¶ç»§æ‰¿`React.PureComponent`ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œæµ…å±‚æ¯”è¾ƒ
- å®šåˆ¶`shouldComponentUpdate`å‡½æ•°
- ä½¿ç”¨`Immutable.js`è¿›è¡Œæ•°æ®ç®¡ç†

![immutable](./immutable.webp)

[Immutableè¯¦è§£](https://segmentfault.com/a/1190000003910357)
[React é¡¹ç›®æ€§èƒ½åˆ†æåŠä¼˜åŒ–](https://github.com/brickspert/blog/issues/36)

### å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶çš„åŒºåˆ«

å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶å½“ç„¶æ˜¯æœ‰åŒºåˆ«çš„ï¼Œè€Œä¸”å‡½æ•°ç»„ä»¶çš„æ€§èƒ½æ¯”ç±»ç»„ä»¶çš„æ€§èƒ½è¦é«˜ï¼Œå› ä¸ºç±»ç»„ä»¶ä½¿ç”¨çš„æ—¶å€™è¦å®ä¾‹åŒ–ï¼Œè€Œå‡½æ•°ç»„ä»¶ç›´æ¥æ‰§è¡Œå‡½æ•°å–è¿”å›ç»“æœå³å¯ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå°½é‡ä½¿ç”¨å‡½æ•°ç»„ä»¶ã€‚

| åŒºåˆ« | å‡½æ•°ç»„ä»¶ | ç±»ç»„ä»¶ |
| --- | --- | --- |
| æ˜¯å¦æœ‰ this |	æ²¡æœ‰ | æœ‰ |
| æ˜¯å¦æœ‰ç”Ÿå‘½å‘¨æœŸ | æ²¡æœ‰ | æœ‰ |
| æ˜¯å¦æœ‰çŠ¶æ€ state | æ²¡æœ‰ | æœ‰ |


å‚è€ƒï¼š
[React æŠ€æœ¯æ­ç§˜](https://react.iamkasong.com/)
[React Hook APIå®˜æ–¹æ–‡æ¡£](https://react.docschina.org/docs/hooks-reference.html#)
[React æ€§èƒ½ä¼˜åŒ–ï¼Œä½ éœ€è¦çŸ¥é“çš„å‡ ä¸ªç‚¹](https://www.jianshu.com/p/333f390f2e84)
[Reactå…¨éƒ¨apiè§£è¯»](https://juejin.cn/post/6950063294270930980#heading-41)